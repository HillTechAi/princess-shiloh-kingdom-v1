<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Princess Shiloh's Magical Kingdom</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --pink-light:#fce4ec;--pink:#f8a4c8;--pink-deep:#e91e8c;
  --purple-light:#f3e5f5;--purple:#ce93d8;--purple-deep:#7b1fa2;
  --lavender:#d1b3f0;--gold:#ffd54f;--gold-deep:#f9a825;
  --rose:#f48fb1;--blush:#fce4ec;
  --blue:#81d4fa;--teal:#4dd0e1;
}
html, body {
  width:100%;height:100%;overflow:hidden;
  font-family:'Quicksand',sans-serif;
  background:#f8e1f4;
  touch-action:manipulation;
  -webkit-tap-highlight-color:transparent;
  user-select:none;
}

/* ===== PAGES ===== */
.page { display:none; width:100%; height:100%; position:absolute; top:0; left:0; }
.page.active { display:flex; flex-direction:column; }

/* ===== SPARKLE CANVAS ===== */
#sparkle-canvas { position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9000; }

/* ===== SHARED HEADER ===== */
.hdr { position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:linear-gradient(180deg,rgba(248,225,244,0.97) 0%,rgba(248,225,244,0) 100%); }
.hdr-btn { width:44px;height:44px;border-radius:50%;border:2px solid rgba(186,104,200,0.3);background:rgba(255,255,255,0.6);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;transition:transform .2s; }
.hdr-btn:active { transform:scale(0.9); }
.hdr-title { font-family:'Dancing Script',cursive;font-size:clamp(16px,4.5vw,26px);color:var(--purple-deep);text-shadow:0 0 20px rgba(186,104,200,0.2);text-align:center;flex:1; }
.star-counter { display:flex;align-items:center;gap:5px;background:linear-gradient(135deg,rgba(255,213,79,0.3),rgba(255,213,79,0.15));border:2px solid rgba(255,213,79,0.5);border-radius:50px;padding:6px 12px;font-weight:700;color:var(--gold-deep);font-size:16px; }
.star-counter .si { font-size:18px;animation:starP 2s ease-in-out infinite; }
@keyframes starP { 0%,100%{transform:scale(1)}50%{transform:scale(1.2)} }

/* ===== TOAST ===== */
.toast-box { position:fixed;bottom:120px;left:50%;transform:translateX(-50%) translateY(20px);background:linear-gradient(135deg,rgba(248,164,200,0.92),rgba(186,104,200,0.92));color:#fff;padding:12px 24px;border-radius:50px;font-weight:700;font-size:14px;box-shadow:0 8px 30px rgba(186,104,200,0.3);z-index:8000;opacity:0;transition:opacity .3s,transform .3s;text-align:center;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.3);pointer-events:none; }
.toast-box.show { opacity:1;transform:translateX(-50%) translateY(0); }

/* ===== SOUND TOGGLE ===== */
.snd-toggle { position:fixed;bottom:16px;right:16px;z-index:200;width:48px;height:48px;border-radius:50%;border:2px solid rgba(255,255,255,0.5);background:linear-gradient(135deg,rgba(248,164,200,0.4),rgba(186,104,200,0.3));backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;box-shadow:0 4px 20px rgba(186,104,200,0.2);transition:transform .2s; }
.snd-toggle:active { transform:scale(0.9); }

/* =============================================
   HOME PAGE
   ============================================= */
#page-home { background:linear-gradient(180deg,#f8e1f4 0%,#e8d5f5 30%,#d4e9f7 55%,#b2ebf2 75%,#80deea 100%); }
#page-home .scroll-wrap { flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-top:60px; }
.realm { position:relative;width:100%;min-height:50vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px; }
.realm-castle { background:radial-gradient(ellipse at 50% 120%,rgba(248,164,200,0.2) 0%,transparent 60%),linear-gradient(180deg,#f8e1f4 0%,#f0d4f0 40%,#e0c4e8 70%,#d4e0f0 100%); }
.realm-mermaid { background:radial-gradient(ellipse at 50% -20%,rgba(77,208,225,0.15) 0%,transparent 60%),linear-gradient(180deg,#d4e0f0 0%,#b8e8f0 30%,#90d4e8 60%,#6ec6db 85%,#4fbdd0 100%); }
.realm-title { font-family:'Dancing Script',cursive;font-size:clamp(24px,6vw,38px);margin-bottom:20px;text-align:center; }
.realm-title.ct { color:var(--purple-deep);text-shadow:0 0 30px rgba(186,104,200,0.3); }
.realm-title.mt { color:#00695c;text-shadow:0 0 30px rgba(0,172,193,0.3); }

.portal-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:14px;width:100%;max-width:600px; }
.portal { display:flex;flex-direction:column;align-items:center;gap:8px;padding:18px 10px;border-radius:22px;border:2px solid rgba(255,255,255,0.5);cursor:pointer;transition:transform .25s cubic-bezier(.34,1.56,.64,1),box-shadow .25s;min-height:130px;justify-content:center;position:relative;overflow:hidden; }
.portal:active { transform:scale(0.93); }
.portal:hover { transform:scale(1.04) translateY(-3px);box-shadow:0 10px 35px rgba(0,0,0,0.1); }
.portal-icon { width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:26px;background:rgba(255,255,255,0.6);border:2px solid rgba(255,255,255,0.7);box-shadow:0 2px 10px rgba(0,0,0,0.05);animation:bob 4s ease-in-out infinite; }
@keyframes bob { 0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)} }
.portal-label { font-weight:700;font-size:12px;color:rgba(0,0,0,0.6);text-align:center;line-height:1.3; }

/* Portal colors */
.p-c1{background:linear-gradient(135deg,rgba(252,228,236,0.85),rgba(248,164,200,0.5));box-shadow:0 4px 18px rgba(248,164,200,0.2)}
.p-c2{background:linear-gradient(135deg,rgba(232,213,245,0.85),rgba(186,104,200,0.4));box-shadow:0 4px 18px rgba(186,104,200,0.18)}
.p-c3{background:linear-gradient(135deg,rgba(255,243,224,0.85),rgba(255,213,79,0.4));box-shadow:0 4px 18px rgba(255,213,79,0.18)}
.p-c4{background:linear-gradient(135deg,rgba(248,187,208,0.85),rgba(233,30,140,0.3));box-shadow:0 4px 18px rgba(233,30,140,0.12)}
.p-c5{background:linear-gradient(135deg,rgba(209,179,240,0.85),rgba(123,31,162,0.3));box-shadow:0 4px 18px rgba(123,31,162,0.12)}
.p-m1{background:linear-gradient(135deg,rgba(178,235,242,0.85),rgba(77,208,225,0.4));box-shadow:0 4px 18px rgba(77,208,225,0.2)}
.p-m2{background:linear-gradient(135deg,rgba(200,230,255,0.85),rgba(100,181,246,0.4));box-shadow:0 4px 18px rgba(100,181,246,0.18)}
.p-m3{background:linear-gradient(135deg,rgba(225,245,254,0.85),rgba(0,172,193,0.35));box-shadow:0 4px 18px rgba(0,172,193,0.15)}
.p-m4{background:linear-gradient(135deg,rgba(209,196,233,0.85),rgba(149,117,205,0.4));box-shadow:0 4px 18px rgba(149,117,205,0.15)}
.p-m5{background:linear-gradient(135deg,rgba(255,224,230,0.85),rgba(240,98,146,0.35));box-shadow:0 4px 18px rgba(240,98,146,0.12)}

/* Floating decor */
.fdeco { position:absolute;pointer-events:none;animation:fl var(--d,6s) ease-in-out infinite;animation-delay:var(--dl,0s);opacity:var(--o,0.5);font-size:var(--sz,20px);z-index:2; }
@keyframes fl { 0%,100%{transform:translateY(0)}50%{transform:translateY(var(--fy,-14px))} }
.bubble { position:absolute;border-radius:50%;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,0.8),rgba(255,255,255,0.1));border:1px solid rgba(255,255,255,0.4);pointer-events:none;animation:bub var(--d,8s) ease-in infinite;animation-delay:var(--dl,0s);z-index:2; }
@keyframes bub { 0%{transform:translateY(0) scale(1);opacity:0.5}100%{transform:translateY(-180px) scale(0.4);opacity:0} }

/* Wave */
.wave-div { width:100%;height:50px;margin-top:-25px;margin-bottom:-25px;position:relative;z-index:5; }

/* Castle SVG scene */
.castle-scene { width:100%;max-width:460px;height:200px;margin-bottom:24px; }
.castle-scene svg { width:100%;height:100%; }
.mermaid-scene { width:100%;max-width:460px;height:180px;margin-bottom:24px; }
.mermaid-scene svg { width:100%;height:100%; }

/* =============================================
   DRESS-UP PAGE
   ============================================= */
#page-dressup { background:linear-gradient(165deg,#f8e1f4 0%,#f3e5f5 25%,#ede7f6 50%,#fce4ec 75%,#fff3e0 100%); }
.du-layout { flex:1;display:flex;flex-direction:column;padding-top:58px;overflow:hidden; }
.du-stage { flex:1;display:flex;align-items:center;justify-content:center;position:relative;min-height:0; }
.du-stage-glow { position:absolute;width:260px;height:260px;border-radius:50%;background:radial-gradient(circle,rgba(248,164,200,0.15) 0%,transparent 70%);pointer-events:none; }
.princess-container { position:relative;width:clamp(180px,40vw,280px);height:clamp(290px,50vh,440px); }
.princess-svg { width:100%;height:100%;filter:drop-shadow(0 6px 20px rgba(186,104,200,0.12)); }

.wardrobe { flex-shrink:0;background:linear-gradient(0deg,rgba(255,255,255,0.95) 0%,rgba(252,228,236,0.9) 100%);backdrop-filter:blur(20px);border-top:1px solid rgba(206,147,216,0.2);padding:0 0 env(safe-area-inset-bottom,10px);box-shadow:0 -6px 30px rgba(186,104,200,0.06); }
.cat-tabs { display:flex;gap:3px;padding:8px 10px 4px;overflow-x:auto;scrollbar-width:none; }
.cat-tabs::-webkit-scrollbar { display:none; }
.ct-tab { flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 12px;border-radius:14px;border:2px solid transparent;background:rgba(255,255,255,0.5);cursor:pointer;transition:all .25s;min-width:58px; }
.ct-tab.act { border-color:var(--pink);background:linear-gradient(135deg,rgba(248,164,200,0.2),rgba(206,147,216,0.15));box-shadow:0 2px 10px rgba(248,164,200,0.18); }
.ct-tab:active { transform:scale(0.93); }
.ct-tab-i { font-size:20px; }
.ct-tab-l { font-size:9px;font-weight:700;color:rgba(0,0,0,0.45);letter-spacing:.3px; }
.ct-tab.act .ct-tab-l { color:var(--pink-deep); }

.items-row { display:flex;gap:8px;padding:6px 14px 10px;overflow-x:auto;scrollbar-width:none; }
.items-row::-webkit-scrollbar { display:none; }
.itm-card { flex-shrink:0;width:72px;height:72px;border-radius:16px;border:2.5px solid rgba(206,147,216,0.25);background:rgba(255,255,255,0.7);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .25s cubic-bezier(.34,1.56,.64,1);position:relative; }
.itm-card:active { transform:scale(0.9); }
.itm-card.sel { border-color:var(--pink);background:linear-gradient(135deg,rgba(248,164,200,0.15),rgba(206,147,216,0.1));box-shadow:0 3px 16px rgba(248,164,200,0.22);transform:scale(1.05); }
.itm-card.lck { opacity:0.4;filter:grayscale(0.5); }
.itm-card .lk-b { position:absolute;top:3px;right:3px;font-size:10px;background:rgba(0,0,0,0.12);border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center; }
.itm-card .ip { width:52px;height:52px; }
.clr-btn { flex-shrink:0;width:72px;height:72px;border-radius:16px;border:2.5px dashed rgba(206,147,216,0.3);background:rgba(255,255,255,0.4);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;transition:all .2s;color:rgba(0,0,0,0.3);font-size:9px;font-weight:700; }
.clr-btn:active { transform:scale(0.9); }
.clr-btn .ci { font-size:20px; }

/* Mirror overlay */
.mirror-ov { position:fixed;inset:0;z-index:7000;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0);pointer-events:none;opacity:0;transition:all .5s; }
.mirror-ov.act { background:rgba(123,31,162,0.12);pointer-events:auto;opacity:1; }
.mirror-fr { width:clamp(220px,65vw,340px);transform:scale(0.8);transition:transform .5s cubic-bezier(.34,1.56,.64,1); }
.mirror-ov.act .mirror-fr { transform:scale(1); }
.mirror-txt { font-family:'Dancing Script',cursive;font-size:clamp(20px,5vw,30px);color:var(--purple-deep);text-align:center;margin-top:16px;text-shadow:0 0 30px rgba(186,104,200,0.4);opacity:0;transform:translateY(10px);transition:all .5s .3s; }
.mirror-ov.act .mirror-txt { opacity:1;transform:translateY(0); }

/* =============================================
   COLORING PAGE
   ============================================= */
#page-coloring { background:linear-gradient(165deg,#fff8e1 0%,#fce4ec 30%,#f3e5f5 60%,#e8eaf6 100%); }

/* =============================================
   PUZZLE PAGE
   ============================================= */
#page-puzzle { background:linear-gradient(165deg,#ede7f6 0%,#e8d5f5 30%,#f3e5f5 60%,#fce4ec 100%); }
.pz-layout { flex:1;display:flex;flex-direction:column;padding-top:58px;overflow:hidden; }
.pz-board-wrap { flex:1;display:flex;align-items:center;justify-content:center;position:relative;min-height:0;padding:10px; }
.pz-board { position:relative;border-radius:16px;background:rgba(255,255,255,0.35);border:2.5px dashed rgba(186,104,200,0.25);box-shadow:inset 0 2px 20px rgba(186,104,200,0.06); }
.pz-board .pz-ghost { position:absolute;border:1.5px dashed rgba(186,104,200,0.2);border-radius:4px;background:rgba(248,164,200,0.04);transition:background .3s; }
.pz-board .pz-ghost.filled { background:transparent;border-color:transparent; }

.pz-piece { position:absolute;border-radius:5px;cursor:grab;transition:box-shadow .2s;touch-action:none;z-index:10;overflow:hidden;box-shadow:0 3px 12px rgba(0,0,0,0.12),0 1px 3px rgba(0,0,0,0.08); }
.pz-piece:active { cursor:grabbing;z-index:100; }
.pz-piece.placed { cursor:default;box-shadow:0 1px 4px rgba(0,0,0,0.06);z-index:5;pointer-events:none;border-radius:0; }
.pz-piece canvas { width:100%;height:100%;display:block; }

.pz-toolbar { flex-shrink:0;background:linear-gradient(0deg,rgba(255,255,255,0.95) 0%,rgba(232,213,245,0.9) 100%);backdrop-filter:blur(20px);border-top:1px solid rgba(186,104,200,0.15);padding:8px 10px env(safe-area-inset-bottom,10px);box-shadow:0 -6px 30px rgba(186,104,200,0.05); }
.pz-chooser { display:flex;gap:8px;padding:0 4px 6px;overflow-x:auto;scrollbar-width:none;align-items:center; }
.pz-chooser::-webkit-scrollbar { display:none; }
.pz-img-thumb { flex-shrink:0;width:56px;height:56px;border-radius:14px;border:2.5px solid rgba(186,104,200,0.2);overflow:hidden;cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.7); }
.pz-img-thumb.act { border-color:var(--purple);box-shadow:0 3px 14px rgba(186,104,200,0.25);transform:scale(1.08); }
.pz-img-thumb:active { transform:scale(0.92); }
.pz-img-thumb.lck { opacity:0.4;filter:grayscale(0.5); }
.pz-img-thumb svg { width:44px;height:44px; }

.pz-diff { display:flex;gap:6px;padding:4px 4px 0;align-items:center; }
.pz-diff-btn { padding:8px 16px;border-radius:14px;border:2px solid rgba(186,104,200,0.2);background:rgba(255,255,255,0.6);font-size:12px;font-weight:700;color:rgba(0,0,0,0.5);cursor:pointer;transition:all .2s;font-family:'Quicksand',sans-serif; }
.pz-diff-btn:active { transform:scale(0.93); }
.pz-diff-btn.act { border-color:var(--purple);background:linear-gradient(135deg,rgba(209,179,240,0.25),rgba(186,104,200,0.15));color:var(--purple-deep); }
.pz-shuffle-btn { margin-left:auto;padding:8px 16px;border-radius:14px;border:2px solid rgba(255,213,79,0.4);background:linear-gradient(135deg,rgba(255,213,79,0.2),rgba(255,183,77,0.1));font-size:12px;font-weight:700;color:var(--gold-deep);cursor:pointer;transition:all .2s;font-family:'Quicksand',sans-serif; }
.pz-shuffle-btn:active { transform:scale(0.93); }

/* Completion overlay */
.pz-complete { position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(248,225,244,0.85);backdrop-filter:blur(8px);border-radius:16px;opacity:0;pointer-events:none;transition:opacity .5s;z-index:200; }
.pz-complete.show { opacity:1;pointer-events:auto; }
.pz-complete-title { font-family:'Dancing Script',cursive;font-size:clamp(28px,6vw,42px);color:var(--purple-deep);text-shadow:0 0 30px rgba(186,104,200,0.3);margin-bottom:8px; }
.pz-complete-sub { font-size:16px;font-weight:700;color:var(--pink-deep);margin-bottom:16px; }
.pz-complete-btn { padding:12px 28px;border-radius:50px;border:none;background:linear-gradient(135deg,var(--pink),var(--purple));color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:'Quicksand',sans-serif;box-shadow:0 4px 20px rgba(186,104,200,0.3);transition:transform .2s; }
.pz-complete-btn:active { transform:scale(0.93); }

/* =============================================
   DANCE PARTY PAGE
   ============================================= */
#page-dance { background:linear-gradient(180deg,#1a0030 0%,#2d1052 30%,#4a1a6b 60%,#6a1b9a 100%);overflow:hidden; }
.dn-layout { flex:1;display:flex;flex-direction:column;padding-top:58px;overflow:hidden;position:relative; }
.dn-hdr-override .hdr-title { color:#e1bee7; }

/* Dance floor */
.dn-floor { position:absolute;bottom:0;left:0;right:0;height:35%;background:linear-gradient(0deg,rgba(123,31,162,0.4) 0%,transparent 100%);pointer-events:none; }
.dn-tile { position:absolute;border:1px solid rgba(206,147,216,0.15);background:rgba(206,147,216,0.05);transition:background .3s; }
.dn-tile.lit { background:rgba(248,164,200,0.2); }

/* Dancer character */
.dn-dancer { position:absolute;bottom:30%;left:50%;transform:translateX(-50%);width:clamp(80px,20vw,130px);z-index:10;transition:transform .15s; }
.dn-dancer svg { width:100%;height:auto; }
.dn-dancer.pose1 { transform:translateX(-50%) rotate(-5deg); }
.dn-dancer.pose2 { transform:translateX(-50%) rotate(5deg); }
.dn-dancer.pose3 { transform:translateX(-50%) scaleX(-1) rotate(-5deg); }
.dn-dancer.pose4 { transform:translateX(-50%) translateY(-8px); }

/* Score and combo */
.dn-score { position:absolute;top:68px;left:50%;transform:translateX(-50%);font-family:'Dancing Script',cursive;font-size:clamp(20px,5vw,32px);color:#ffd54f;text-shadow:0 0 20px rgba(255,213,79,0.5);z-index:20;pointer-events:none; }
.dn-combo { position:absolute;top:100px;left:50%;transform:translateX(-50%);font-size:14px;font-weight:700;color:#f8a4c8;text-shadow:0 0 10px rgba(248,164,200,0.4);z-index:20;pointer-events:none;opacity:0;transition:opacity .3s; }
.dn-combo.show { opacity:1; }

/* Hit buttons */
.dn-btn-row { position:absolute;bottom:8%;left:0;right:0;display:flex;justify-content:center;gap:clamp(12px,4vw,28px);z-index:30;padding:0 16px; }
.dn-hit-btn { width:clamp(60px,16vw,80px);height:clamp(60px,16vw,80px);border-radius:50%;border:3px solid rgba(255,255,255,0.5);display:flex;align-items:center;justify-content:center;font-size:clamp(26px,6vw,36px);cursor:pointer;transition:transform .12s,box-shadow .12s;touch-action:manipulation;position:relative;overflow:hidden; }
.dn-hit-btn::after { content:'';position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(255,255,255,0.3),transparent 60%);pointer-events:none; }
.dn-hit-btn:active { transform:scale(0.85); }
.dn-hit-btn.flash { transform:scale(1.15);box-shadow:0 0 30px rgba(255,255,255,0.4); }
.dn-btn-pink { background:linear-gradient(135deg,#f48fb1,#e91e8c);box-shadow:0 4px 20px rgba(233,30,140,0.4); }
.dn-btn-purple { background:linear-gradient(135deg,#ce93d8,#7b1fa2);box-shadow:0 4px 20px rgba(123,31,162,0.4); }
.dn-btn-gold { background:linear-gradient(135deg,#ffd54f,#f9a825);box-shadow:0 4px 20px rgba(249,168,37,0.4); }
.dn-btn-blue { background:linear-gradient(135deg,#81d4fa,#1e88e5);box-shadow:0 4px 20px rgba(30,136,229,0.4); }

/* Falling notes */
.dn-note { position:absolute;width:clamp(44px,12vw,60px);height:clamp(44px,12vw,60px);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:clamp(22px,5vw,30px);pointer-events:none;z-index:15;opacity:0.9;transition:none; }
.dn-note.n-pink { background:radial-gradient(circle,rgba(244,143,177,0.8),rgba(233,30,140,0.5));border:2px solid rgba(248,164,200,0.6); }
.dn-note.n-purple { background:radial-gradient(circle,rgba(206,147,216,0.8),rgba(123,31,162,0.5));border:2px solid rgba(209,179,240,0.6); }
.dn-note.n-gold { background:radial-gradient(circle,rgba(255,213,79,0.8),rgba(249,168,37,0.5));border:2px solid rgba(255,213,79,0.6); }
.dn-note.n-blue { background:radial-gradient(circle,rgba(129,212,250,0.8),rgba(30,136,229,0.5));border:2px solid rgba(129,212,250,0.6); }

/* Disco lights */
.dn-light { position:absolute;border-radius:50%;pointer-events:none;z-index:1;filter:blur(40px);animation:discoPulse var(--d,4s) ease-in-out infinite alternate; }
@keyframes discoPulse { 0%{opacity:var(--o1,0.15);transform:scale(1)}100%{opacity:var(--o2,0.3);transform:scale(1.2)} }

/* Start/pause overlay */
.dn-overlay { position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(26,0,48,0.7);backdrop-filter:blur(6px);z-index:50;transition:opacity .4s; }
.dn-overlay.hidden { opacity:0;pointer-events:none; }
.dn-start-btn { padding:16px 40px;border-radius:50px;border:3px solid rgba(255,255,255,0.3);background:linear-gradient(135deg,var(--pink),var(--purple));color:white;font-family:'Dancing Script',cursive;font-size:clamp(24px,6vw,36px);cursor:pointer;box-shadow:0 6px 30px rgba(186,104,200,0.4);transition:transform .2s; }
.dn-start-btn:active { transform:scale(0.93); }
.dn-overlay-title { font-family:'Dancing Script',cursive;font-size:clamp(26px,6vw,40px);color:#ffd54f;text-shadow:0 0 20px rgba(255,213,79,0.4);margin-bottom:12px; }
.dn-overlay-sub { font-size:14px;color:#e1bee7;margin-bottom:24px;text-align:center; }

/* =============================================
   CATCH THE STARS PAGE
   ============================================= */
#page-stars { background:linear-gradient(180deg,#0d1b3e 0%,#1a237e 25%,#283593 50%,#3949ab 75%,#5c6bc0 100%);overflow:hidden; }
.st-layout { flex:1;position:relative;padding-top:58px;overflow:hidden; }
.st-hdr-override .hdr-title { color:#c5cae9; }

.st-score-bar { position:absolute;top:62px;left:12px;right:12px;display:flex;justify-content:space-between;align-items:center;z-index:20;pointer-events:none; }
.st-score-val { font-family:'Dancing Script',cursive;font-size:clamp(22px,5vw,32px);color:#ffd54f;text-shadow:0 0 15px rgba(255,213,79,0.5); }
.st-timer { font-size:14px;font-weight:700;color:#c5cae9;background:rgba(255,255,255,0.1);padding:4px 14px;border-radius:50px; }
.st-lives { font-size:18px;letter-spacing:4px; }

/* Falling items */
.st-item { position:absolute;font-size:clamp(32px,8vw,50px);z-index:10;cursor:pointer;pointer-events:auto;transition:none;filter:drop-shadow(0 0 8px rgba(255,213,79,0.3)); }
.st-item:active { transform:scale(0.8); }
.st-item.caught { transition:transform .25s,opacity .25s;transform:scale(1.8);opacity:0;pointer-events:none; }
.st-item.bad { filter:drop-shadow(0 0 8px rgba(244,67,54,0.4)); }

/* Score popup */
.st-popup { position:absolute;font-family:'Dancing Script',cursive;font-size:20px;font-weight:700;color:#ffd54f;text-shadow:0 0 10px rgba(255,213,79,0.5);pointer-events:none;z-index:25;animation:stPop .8s ease-out forwards; }
@keyframes stPop { 0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-40px) scale(1.3)} }

/* Twinkling stars background */
.st-bg-star { position:absolute;width:3px;height:3px;background:white;border-radius:50%;pointer-events:none;animation:twinkle var(--d,3s) ease-in-out infinite;animation-delay:var(--dl,0s);z-index:1; }
@keyframes twinkle { 0%,100%{opacity:var(--o1,0.3)}50%{opacity:var(--o2,0.8)} }

/* Moon */
.st-moon { position:absolute;top:8%;right:8%;width:clamp(40px,10vw,70px);height:clamp(40px,10vw,70px);border-radius:50%;background:radial-gradient(circle at 35% 35%,#fff9c4,#fff176,#ffd54f);box-shadow:0 0 30px rgba(255,213,79,0.3),0 0 60px rgba(255,213,79,0.1);z-index:2;pointer-events:none; }

/* Ocean floor hint */
.st-ocean { position:absolute;bottom:0;left:0;right:0;height:15%;background:linear-gradient(0deg,rgba(0,172,193,0.2) 0%,transparent 100%);pointer-events:none;z-index:3; }

/* Start/end overlay */
.st-overlay { position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(13,27,62,0.8);backdrop-filter:blur(6px);z-index:50;transition:opacity .4s; }
.st-overlay.hidden { opacity:0;pointer-events:none; }
.st-ov-title { font-family:'Dancing Script',cursive;font-size:clamp(28px,7vw,42px);color:#ffd54f;text-shadow:0 0 25px rgba(255,213,79,0.4);margin-bottom:10px; }
.st-ov-sub { font-size:14px;color:#c5cae9;margin-bottom:22px;text-align:center;line-height:1.5; }
.st-ov-btn { padding:14px 36px;border-radius:50px;border:3px solid rgba(255,255,255,0.25);background:linear-gradient(135deg,#ffd54f,#ff9800);color:#4a3728;font-family:'Dancing Script',cursive;font-size:clamp(22px,5vw,30px);cursor:pointer;box-shadow:0 6px 25px rgba(255,152,0,0.35);transition:transform .2s; }
.st-ov-btn:active { transform:scale(0.93); }

/* =============================================
   PRINCESS ACADEMY PAGE
   ============================================= */
#page-academy { background:linear-gradient(165deg,#fff8e1 0%,#fce4ec 30%,#f3e5f5 60%,#e8eaf6 100%); }
.ac-layout { flex:1;display:flex;flex-direction:column;padding-top:58px;overflow:hidden; }

.ac-question-area { flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;min-height:0;position:relative; }
.ac-prompt { font-family:'Dancing Script',cursive;font-size:clamp(22px,5.5vw,34px);color:var(--purple-deep);text-align:center;margin-bottom:12px;text-shadow:0 0 15px rgba(186,104,200,0.15); }
.ac-display { font-size:clamp(50px,14vw,90px);margin-bottom:16px;text-align:center;line-height:1.2;min-height:80px;display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap; }
.ac-display-item { display:inline-block;animation:acBounce .4s ease-out;transition:transform .2s; }
@keyframes acBounce { 0%{transform:scale(0) rotate(-10deg)}60%{transform:scale(1.2) rotate(3deg)}100%{transform:scale(1) rotate(0)} }

.ac-answers { display:flex;flex-wrap:wrap;justify-content:center;gap:clamp(8px,2vw,14px);padding:0 12px;max-width:500px; }
.ac-ans { min-width:clamp(70px,20vw,110px);padding:clamp(14px,3.5vw,20px) clamp(16px,4vw,28px);border-radius:20px;border:3px solid rgba(206,147,216,0.3);background:rgba(255,255,255,0.7);backdrop-filter:blur(8px);font-size:clamp(18px,5vw,28px);font-weight:700;text-align:center;cursor:pointer;transition:all .2s cubic-bezier(.34,1.56,.64,1);box-shadow:0 3px 15px rgba(0,0,0,0.06);color:var(--purple-deep); }
.ac-ans:active { transform:scale(0.90); }
.ac-ans.correct { border-color:#66bb6a;background:linear-gradient(135deg,rgba(102,187,106,0.2),rgba(129,199,132,0.15));box-shadow:0 0 20px rgba(102,187,106,0.3);transform:scale(1.08); }
.ac-ans.wrong { border-color:#ef5350;background:rgba(239,83,80,0.08);transform:scale(0.95);opacity:0.5; }

.ac-feedback { position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Dancing Script',cursive;font-size:clamp(30px,8vw,50px);pointer-events:none;z-index:30;opacity:0;transition:opacity .3s; }
.ac-feedback.show { opacity:1; }

.ac-toolbar { flex-shrink:0;background:linear-gradient(0deg,rgba(255,255,255,0.95) 0%,rgba(255,243,224,0.9) 100%);backdrop-filter:blur(20px);border-top:1px solid rgba(255,213,79,0.2);padding:10px 14px env(safe-area-inset-bottom,10px);display:flex;align-items:center;justify-content:space-between;box-shadow:0 -4px 20px rgba(186,104,200,0.04); }
.ac-progress { display:flex;gap:6px;align-items:center; }
.ac-dot { width:clamp(12px,3vw,16px);height:clamp(12px,3vw,16px);border-radius:50%;background:rgba(206,147,216,0.2);border:2px solid rgba(206,147,216,0.3);transition:all .3s; }
.ac-dot.done { background:var(--gold);border-color:#f9a825;box-shadow:0 0 8px rgba(255,213,79,0.4); }
.ac-dot.current { border-color:var(--pink);transform:scale(1.2); }
.ac-cat-label { font-size:12px;font-weight:700;color:var(--purple-deep);opacity:0.6; }
.ac-streak { font-size:14px;font-weight:700;color:var(--gold-deep); }

/* =============================================
   TREASURE HUNT (Memory Match)
   ============================================= */
#page-treasure { background:linear-gradient(180deg,#e0f7fa 0%,#b2ebf2 30%,#80deea 60%,#4dd0e1 100%); }
.th-layout { flex:1;display:flex;flex-direction:column;padding-top:58px;overflow:hidden; }
.th-info { display:flex;justify-content:space-between;align-items:center;padding:8px 16px 4px; }
.th-moves { font-size:14px;font-weight:700;color:#00695c; }
.th-pairs { font-size:14px;font-weight:700;color:#e91e8c; }

.th-grid-wrap { flex:1;display:flex;align-items:center;justify-content:center;padding:10px;min-height:0; }
.th-grid { display:grid;gap:clamp(6px,1.5vw,10px);width:fit-content; }

.th-card { width:clamp(60px,18vw,85px);height:clamp(72px,22vw,100px);border-radius:14px;cursor:pointer;perspective:600px;-webkit-tap-highlight-color:transparent; }
.th-card-inner { position:relative;width:100%;height:100%;transition:transform 0.45s cubic-bezier(.4,.2,.2,1);transform-style:preserve-3d; }
.th-card.flipped .th-card-inner { transform:rotateY(180deg); }
.th-card.matched .th-card-inner { transform:rotateY(180deg); }
.th-card.matched { pointer-events:none; }

.th-card-front,.th-card-back { position:absolute;width:100%;height:100%;border-radius:14px;backface-visibility:hidden;-webkit-backface-visibility:hidden;display:flex;align-items:center;justify-content:center; }
.th-card-back { background:linear-gradient(135deg,#4dd0e1,#00acc1);border:2.5px solid rgba(0,172,193,0.4);box-shadow:0 3px 14px rgba(0,172,193,0.2);font-size:clamp(22px,5vw,32px); }
.th-card-back::after { content:'';position:absolute;inset:4px;border-radius:10px;border:1.5px dashed rgba(255,255,255,0.25); }
.th-card-front { background:rgba(255,255,255,0.9);border:2.5px solid rgba(255,255,255,0.8);box-shadow:0 3px 14px rgba(0,0,0,0.08);transform:rotateY(180deg);font-size:clamp(30px,8vw,46px); }

.th-card.matched .th-card-front { background:linear-gradient(135deg,rgba(255,213,79,0.15),rgba(255,183,77,0.1));border-color:rgba(255,213,79,0.4);box-shadow:0 0 16px rgba(255,213,79,0.2); }

.th-toolbar { flex-shrink:0;background:linear-gradient(0deg,rgba(255,255,255,0.95) 0%,rgba(178,235,242,0.9) 100%);backdrop-filter:blur(20px);border-top:1px solid rgba(0,172,193,0.15);padding:8px 14px env(safe-area-inset-bottom,10px);display:flex;align-items:center;gap:8px;box-shadow:0 -4px 20px rgba(0,172,193,0.05); }
.th-diff-btn { padding:8px 14px;border-radius:14px;border:2px solid rgba(0,172,193,0.2);background:rgba(255,255,255,0.6);font-size:12px;font-weight:700;color:rgba(0,0,0,0.5);cursor:pointer;transition:all .2s;font-family:'Quicksand',sans-serif; }
.th-diff-btn:active { transform:scale(0.93); }
.th-diff-btn.act { border-color:#00acc1;background:linear-gradient(135deg,rgba(77,208,225,0.2),rgba(0,172,193,0.1));color:#00695c; }
.th-reset-btn { margin-left:auto;padding:8px 14px;border-radius:14px;border:2px solid rgba(255,213,79,0.4);background:linear-gradient(135deg,rgba(255,213,79,0.2),rgba(255,183,77,0.1));font-size:12px;font-weight:700;color:var(--gold-deep);cursor:pointer;font-family:'Quicksand',sans-serif; }
.th-reset-btn:active { transform:scale(0.93); }

/* Completion */
.th-complete { position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(224,247,250,0.9);backdrop-filter:blur(8px);border-radius:0;opacity:0;pointer-events:none;transition:opacity .5s;z-index:30; }
.th-complete.show { opacity:1;pointer-events:auto; }
.th-complete-title { font-family:'Dancing Script',cursive;font-size:clamp(28px,7vw,42px);color:#00695c;margin-bottom:8px; }
.th-complete-sub { font-size:15px;font-weight:700;color:var(--pink-deep);margin-bottom:16px; }
.th-complete-btn { padding:12px 28px;border-radius:50px;border:none;background:linear-gradient(135deg,#4dd0e1,#00acc1);color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:'Quicksand',sans-serif;box-shadow:0 4px 20px rgba(0,172,193,0.3);transition:transform .2s; }
.th-complete-btn:active { transform:scale(0.93); }

/* Bubbles decoration */
.th-bubble { position:absolute;border-radius:50%;border:1.5px solid rgba(255,255,255,0.3);background:radial-gradient(circle at 30% 30%,rgba(255,255,255,0.3),transparent);pointer-events:none;z-index:1;animation:thBubble var(--d,6s) ease-in-out infinite;animation-delay:var(--dl,0s); }
@keyframes thBubble { 0%{transform:translateY(0) scale(1);opacity:.4}50%{transform:translateY(-20px) scale(1.1);opacity:.6}100%{transform:translateY(0) scale(1);opacity:.4} }

/* =============================================
   STORY TIME PAGE
   ============================================= */
#page-story { background:#1a0a2e; }
.sb-layout { flex:1;display:flex;flex-direction:column;padding-top:58px;overflow:hidden;position:relative; }
.sb-hdr-override .hdr-title { color:#e1bee7; }

.sb-scene { flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;min-height:0;padding:12px;overflow:hidden; }
.sb-illustration { width:clamp(280px,85vw,440px);height:clamp(180px,35vh,280px);border-radius:20px;overflow:hidden;position:relative;box-shadow:0 8px 40px rgba(0,0,0,0.3);margin-bottom:12px;flex-shrink:0; }
.sb-illustration svg { width:100%;height:100%;display:block; }

.sb-text-box { width:clamp(280px,85vw,440px);background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);border:1.5px solid rgba(206,147,216,0.2);border-radius:16px;padding:14px 18px;position:relative; }
.sb-text { font-size:clamp(14px,3.8vw,18px);line-height:1.6;color:#e1bee7;min-height:60px;transition:opacity .3s; }
.sb-text .sb-name { color:#ffd54f;font-weight:700; }
.sb-text .sb-highlight { color:#f48fb1;font-weight:600; }

.sb-nav { display:flex;justify-content:space-between;align-items:center;width:clamp(280px,85vw,440px);margin-top:10px;gap:10px; }
.sb-nav-btn { padding:10px 22px;border-radius:50px;border:2px solid rgba(206,147,216,0.3);background:rgba(255,255,255,0.08);color:#e1bee7;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;font-family:'Quicksand',sans-serif;backdrop-filter:blur(6px); }
.sb-nav-btn:active { transform:scale(0.93); }
.sb-nav-btn.primary { background:linear-gradient(135deg,rgba(248,164,200,0.3),rgba(186,104,200,0.2));border-color:rgba(248,164,200,0.4);color:#f8a4c8; }
.sb-page-num { font-size:12px;color:rgba(225,190,231,0.5);font-weight:600; }

.sb-choices { display:flex;flex-direction:column;gap:8px;width:clamp(280px,85vw,440px);margin-top:8px; }
.sb-choice { padding:12px 18px;border-radius:14px;border:2px solid rgba(248,164,200,0.25);background:rgba(248,164,200,0.08);color:#f8a4c8;font-size:clamp(13px,3.5vw,16px);font-weight:600;cursor:pointer;transition:all .2s;text-align:left;font-family:'Quicksand',sans-serif; }
.sb-choice:active { transform:scale(0.97);background:rgba(248,164,200,0.2); }

/* Page transition */
.sb-scene.transitioning .sb-illustration,.sb-scene.transitioning .sb-text-box { opacity:0;transform:translateX(30px);transition:opacity .3s,transform .3s; }
.sb-scene .sb-illustration,.sb-scene .sb-text-box { opacity:1;transform:translateX(0);transition:opacity .3s,transform .3s; }

/* =============================================
   ROYAL TEA PARTY PAGE
   ============================================= */
#page-tea { background:linear-gradient(165deg,#fff8e1 0%,#fce4ec 25%,#f8e1f4 50%,#f3e5f5 100%); }
.tp-layout { flex:1;display:flex;flex-direction:column;padding-top:58px;overflow:hidden; }

.tp-table-area { flex:1;display:flex;align-items:center;justify-content:center;min-height:0;position:relative;padding:10px; }
.tp-table { position:relative;width:clamp(280px,85vw,420px);height:clamp(220px,40vh,320px);background:radial-gradient(ellipse at 50% 60%,#fff8e1,#ffe0b2);border-radius:50% / 40%;border:3px solid rgba(188,170,164,0.3);box-shadow:0 8px 30px rgba(0,0,0,0.08),inset 0 -4px 15px rgba(188,170,164,0.1);overflow:visible; }

/* Table cloth pattern */
.tp-table::before { content:'';position:absolute;inset:8px;border-radius:50% / 40%;border:2px dashed rgba(248,164,200,0.2); }

/* Place settings */
.tp-plate { position:absolute;width:clamp(55px,15vw,75px);height:clamp(55px,15vw,75px);border-radius:50%;background:white;border:2.5px solid rgba(206,147,216,0.25);box-shadow:0 2px 8px rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:center;font-size:clamp(24px,6vw,34px);transition:all .3s; }
.tp-plate.filled { border-color:rgba(255,213,79,0.4);box-shadow:0 2px 12px rgba(255,213,79,0.15); }

/* Guest seats */
.tp-guest { position:absolute;width:clamp(44px,12vw,58px);text-align:center;transition:transform .3s; }
.tp-guest-emoji { font-size:clamp(28px,7vw,40px);display:block; }
.tp-guest-name { font-size:clamp(8px,2.2vw,11px);font-weight:700;color:var(--purple-deep);margin-top:2px; }
.tp-guest.happy { animation:tpBounce .5s ease; }
@keyframes tpBounce { 0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)} }

/* Center teapot */
.tp-teapot { position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(36px,9vw,52px);z-index:5;cursor:pointer;transition:transform .2s;filter:drop-shadow(0 3px 8px rgba(0,0,0,0.1)); }
.tp-teapot:active { transform:translate(-50%,-50%) scale(0.9) rotate(-15deg); }

.tp-toolbar { flex-shrink:0;background:linear-gradient(0deg,rgba(255,255,255,0.96) 0%,rgba(255,243,224,0.9) 100%);backdrop-filter:blur(20px);border-top:1px solid rgba(255,213,79,0.2);padding:6px 10px env(safe-area-inset-bottom,8px);box-shadow:0 -4px 20px rgba(186,104,200,0.04); }
.tp-section-label { font-size:10px;font-weight:700;color:var(--purple-deep);opacity:.5;padding:2px 6px;text-transform:uppercase;letter-spacing:1px; }
.tp-items { display:flex;gap:6px;padding:4px 4px;overflow-x:auto;scrollbar-width:none; }
.tp-items::-webkit-scrollbar { display:none; }
.tp-item { flex-shrink:0;width:clamp(50px,13vw,64px);height:clamp(50px,13vw,64px);border-radius:14px;border:2.5px solid rgba(206,147,216,0.2);background:rgba(255,255,255,0.7);display:flex;align-items:center;justify-content:center;font-size:clamp(26px,6vw,34px);cursor:pointer;transition:all .2s; }
.tp-item:active { transform:scale(0.88); }
.tp-item.selected { border-color:var(--gold);background:linear-gradient(135deg,rgba(255,213,79,0.15),rgba(255,183,77,0.1));box-shadow:0 2px 10px rgba(255,213,79,0.2); }

.tp-msg { position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Dancing Script',cursive;font-size:clamp(22px,5vw,30px);color:var(--purple-deep);text-shadow:0 0 15px rgba(186,104,200,0.2);pointer-events:none;opacity:0;transition:opacity .4s;z-index:20;text-align:center;background:rgba(255,255,255,0.85);padding:12px 20px;border-radius:16px;backdrop-filter:blur(6px); }
.tp-msg.show { opacity:1; }

/* =============================================
   MERMAID DRESS-UP PAGE
   ============================================= */
#page-mermaid { background:linear-gradient(180deg,#e0f7fa 0%,#b2ebf2 25%,#80deea 50%,#4dd0e1 75%,#00acc1 100%); }
.md-layout { flex:1;display:flex;flex-direction:column;padding-top:58px;overflow:hidden; }
.md-stage { flex:1;display:flex;align-items:center;justify-content:center;position:relative;min-height:0; }
.md-canvas-wrap { position:relative;width:clamp(200px,50vw,300px);height:clamp(300px,55vh,440px); }
.md-canvas-wrap svg { width:100%;height:100%; }

.md-toolbar { flex-shrink:0;background:linear-gradient(0deg,rgba(255,255,255,0.95) 0%,rgba(178,235,242,0.9) 100%);backdrop-filter:blur(20px);border-top:1px solid rgba(0,172,193,0.15);padding:6px 10px env(safe-area-inset-bottom,8px);box-shadow:0 -4px 20px rgba(0,172,193,0.05); }
.md-tabs { display:flex;gap:4px;padding-bottom:4px; }
.md-tab { padding:6px 12px;border-radius:12px;font-size:11px;font-weight:700;color:rgba(0,0,0,0.4);cursor:pointer;transition:all .2s;border:2px solid transparent;font-family:'Quicksand',sans-serif; }
.md-tab.act { color:#00695c;background:rgba(0,172,193,0.1);border-color:rgba(0,172,193,0.25); }
.md-tab:active { transform:scale(0.93); }
.md-options { display:flex;gap:6px;padding:4px;overflow-x:auto;scrollbar-width:none; }
.md-options::-webkit-scrollbar { display:none; }
.md-opt { flex-shrink:0;width:clamp(50px,13vw,64px);height:clamp(50px,13vw,64px);border-radius:14px;border:2.5px solid rgba(0,172,193,0.2);background:rgba(255,255,255,0.7);display:flex;align-items:center;justify-content:center;font-size:clamp(24px,6vw,32px);cursor:pointer;transition:all .2s; }
.md-opt:active { transform:scale(0.88); }
.md-opt.act { border-color:#00acc1;background:linear-gradient(135deg,rgba(77,208,225,0.15),rgba(0,172,193,0.08));box-shadow:0 2px 10px rgba(0,172,193,0.15); }

/* Bubbles */
.md-bubble { position:absolute;border-radius:50%;border:1px solid rgba(255,255,255,0.3);background:radial-gradient(circle at 30% 30%,rgba(255,255,255,0.2),transparent);pointer-events:none;z-index:1;animation:mdFloat var(--d,5s) ease-in-out infinite;animation-delay:var(--dl,0s); }
@keyframes mdFloat { 0%,100%{transform:translateY(0)}50%{transform:translateY(-15px)} }
.col-layout { flex:1;display:flex;flex-direction:column;padding-top:58px;overflow:hidden; }
.col-canvas-wrap { flex:1;display:flex;align-items:center;justify-content:center;position:relative;min-height:0;overflow:hidden; }
.col-canvas-inner { position:relative;width:clamp(280px,85vw,500px);height:clamp(250px,48vh,460px); }
#coloring-canvas { width:100%;height:100%;border-radius:20px;background:white;box-shadow:0 8px 40px rgba(0,0,0,0.08);cursor:crosshair;touch-action:none; }

/* Coloring toolbar */
.col-toolbar { flex-shrink:0;background:linear-gradient(0deg,rgba(255,255,255,0.96) 0%,rgba(255,243,224,0.9) 100%);backdrop-filter:blur(20px);border-top:1px solid rgba(255,213,79,0.2);padding:8px 10px env(safe-area-inset-bottom,10px);box-shadow:0 -6px 30px rgba(186,104,200,0.05); }

/* Page selector */
.col-pages { display:flex;gap:6px;padding:0 4px 6px;overflow-x:auto;scrollbar-width:none; }
.col-pages::-webkit-scrollbar { display:none; }
.col-pg { flex-shrink:0;width:56px;height:56px;border-radius:14px;border:2.5px solid rgba(206,147,216,0.2);background:rgba(255,255,255,0.7);display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;transition:all .25s; }
.col-pg.act { border-color:var(--pink);background:linear-gradient(135deg,rgba(248,164,200,0.15),rgba(206,147,216,0.1));box-shadow:0 3px 14px rgba(248,164,200,0.2);transform:scale(1.05); }
.col-pg:active { transform:scale(0.9); }
.col-pg.lck { opacity:0.4; }

/* Color palette */
.col-palette { display:flex;gap:6px;padding:6px 4px;overflow-x:auto;scrollbar-width:none;align-items:center; }
.col-palette::-webkit-scrollbar { display:none; }
.col-swatch { flex-shrink:0;width:40px;height:40px;border-radius:50%;border:3px solid rgba(255,255,255,0.8);cursor:pointer;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.col-swatch:active { transform:scale(0.88); }
.col-swatch.act { transform:scale(1.15);border-color:var(--purple-deep);box-shadow:0 4px 16px rgba(0,0,0,0.15); }

/* Tools row */
.col-tools { display:flex;gap:6px;padding:4px 4px 0;align-items:center; }
.col-tool { flex-shrink:0;padding:8px 14px;border-radius:14px;border:2px solid rgba(206,147,216,0.2);background:rgba(255,255,255,0.6);font-size:12px;font-weight:700;color:rgba(0,0,0,0.55);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px; }
.col-tool:active { transform:scale(0.93); }
.col-tool.act { border-color:var(--gold);background:linear-gradient(135deg,rgba(255,213,79,0.2),rgba(255,183,77,0.1));color:var(--gold-deep); }
.col-tool .tool-icon { font-size:16px; }

@media (min-width:768px) {
  .du-layout { flex-direction:row; }
  .du-stage { flex:1; }
  .wardrobe { width:320px;height:calc(100vh - 58px);overflow-y:auto;border-top:none;border-left:1px solid rgba(206,147,216,0.2); }
  .items-row { flex-wrap:wrap;overflow-x:visible;justify-content:center; }
}
@media (max-width:400px) {
  .portal-grid { grid-template-columns:repeat(2,1fr);gap:10px; }
  .portal { padding:14px 8px;min-height:110px; }
}
</style>
</head>
<body>

<canvas id="sparkle-canvas"></canvas>
<div class="toast-box" id="toast"></div>
<button class="snd-toggle" id="snd-toggle" onclick="toggleSound(event)">üîä</button>

<!-- ============================================
     PAGE: HOME
     ============================================ -->
<div class="page active" id="page-home">
  <div class="hdr">
    <div class="hdr-title" id="greeting">üëë Welcome, Princess Shiloh!</div>
    <div class="star-counter"><span class="si">‚≠ê</span><span id="star-home">0</span></div>
  </div>
  <div class="scroll-wrap">
    <!-- CASTLE REALM -->
    <div class="realm realm-castle">
      <div class="fdeco" style="top:8%;left:8%;--d:7s;--fy:-16px;--sz:20px;--o:0.45">ü¶ã</div>
      <div class="fdeco" style="top:5%;right:10%;--d:5s;--dl:1s;--fy:-12px;--sz:18px;--o:0.35">üå∏</div>
      <div class="fdeco" style="top:15%;left:3%;--d:8s;--dl:.5s;--fy:-18px;--sz:15px;--o:0.3">üå∑</div>
      <div class="fdeco" style="top:3%;left:42%;--d:6s;--dl:2s;--fy:-12px;--sz:18px;--o:0.35">ü¶ã</div>

      <div class="castle-scene">
        <svg viewBox="0 0 500 200">
          <defs>
            <linearGradient id="cg1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#f0d4f0"/><stop offset="50%" style="stop-color:#e8d5f5"/><stop offset="100%" style="stop-color:#f8c8dc"/></linearGradient>
            <linearGradient id="rg1" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#d1b3f0"/><stop offset="100%" style="stop-color:#ba68c8"/></linearGradient>
            <linearGradient id="hg1" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#c8e6c9"/><stop offset="100%" style="stop-color:#a5d6a7;stop-opacity:0.3"/></linearGradient>
          </defs>
          <ellipse cx="250" cy="200" rx="280" ry="50" fill="url(#hg1)" opacity="0.45"/>
          <path d="M 80 170 Q 250 20 420 170" fill="none" stroke="#ff8a80" stroke-width="3.5" opacity="0.15"/>
          <path d="M 85 170 Q 250 25 415 170" fill="none" stroke="#ffd54f" stroke-width="3.5" opacity="0.15"/>
          <path d="M 90 170 Q 250 30 410 170" fill="none" stroke="#a5d6a7" stroke-width="3.5" opacity="0.15"/>
          <path d="M 95 170 Q 250 35 405 170" fill="none" stroke="#80deea" stroke-width="3.5" opacity="0.15"/>
          <rect x="190" y="90" width="120" height="90" rx="4" fill="url(#cg1)" stroke="#d1b3f0" stroke-width="1.2"/>
          <rect x="160" y="62" width="38" height="118" rx="3" fill="url(#cg1)" stroke="#d1b3f0" stroke-width="1.2"/>
          <polygon points="160,62 179,30 198,62" fill="url(#rg1)" stroke="#ba68c8" stroke-width="1.2"/>
          <rect x="302" y="62" width="38" height="118" rx="3" fill="url(#cg1)" stroke="#d1b3f0" stroke-width="1.2"/>
          <polygon points="302,62 321,30 340,62" fill="url(#rg1)" stroke="#ba68c8" stroke-width="1.2"/>
          <rect x="222" y="45" width="56" height="135" rx="4" fill="url(#cg1)" stroke="#d1b3f0" stroke-width="1.2"/>
          <polygon points="222,45 250,12 278,45" fill="url(#rg1)" stroke="#ba68c8" stroke-width="1.2"/>
          <rect x="238" y="148" width="24" height="32" rx="12" fill="#7b1fa2" opacity="0.45"/>
          <circle cx="250" cy="72" r="9" fill="#fce4ec" stroke="#d1b3f0" stroke-width="0.8"/>
          <circle cx="179" cy="88" r="7" fill="#fce4ec" stroke="#d1b3f0" stroke-width="0.8"/>
          <circle cx="321" cy="88" r="7" fill="#fce4ec" stroke="#d1b3f0" stroke-width="0.8"/>
          <circle cx="220" cy="112" r="6" fill="#fce4ec" stroke="#d1b3f0" stroke-width="0.8"/>
          <circle cx="280" cy="112" r="6" fill="#fce4ec" stroke="#d1b3f0" stroke-width="0.8"/>
          <line x1="179" y1="30" x2="179" y2="18" stroke="#ba68c8" stroke-width="1.2"/>
          <polygon points="179,18 190,22 179,26" fill="#ff8a80" opacity="0.7"/>
          <line x1="250" y1="12" x2="250" y2="0" stroke="#ba68c8" stroke-width="1.2"/>
          <polygon points="250,0 261,4 250,8" fill="#ffd54f" opacity="0.7"/>
          <line x1="321" y1="30" x2="321" y2="18" stroke="#ba68c8" stroke-width="1.2"/>
          <polygon points="321,18 332,22 321,26" fill="#f8a4c8" opacity="0.7"/>
          <circle cx="250" cy="5" r="2.5" fill="#ffd54f" opacity="0.7"><animate attributeName="opacity" values="0.7;0.2;0.7" dur="2s" repeatCount="indefinite"/></circle>
        </svg>
      </div>

      <div class="realm-title ct">Castle Kingdom</div>
      <div class="portal-grid">
        <div class="portal p-c1" onclick="goTo('dressup')"><div class="portal-icon">üëó</div><div class="portal-label">Dress-Up<br>Studio</div></div>
        <div class="portal p-c2" onclick="goTo('puzzle')"><div class="portal-icon">üß©</div><div class="portal-label">Puzzle<br>Palace</div></div>
        <div class="portal p-c3" onclick="goTo('coloring')"><div class="portal-icon">üé®</div><div class="portal-label">Coloring<br>Book</div></div>
        <div class="portal p-c4" onclick="goTo('dance')"><div class="portal-icon">üíÉ</div><div class="portal-label">Dance<br>Party</div></div>
        <div class="portal p-c5" onclick="goTo('tea')"><div class="portal-icon">üè∞</div><div class="portal-label">Royal<br>Tea Party</div></div>
      </div>
    </div>

    <!-- WAVE -->
    <svg class="wave-div" viewBox="0 0 1200 50" preserveAspectRatio="none">
      <path d="M0,25 Q150,0 300,25 T600,25 T900,25 T1200,25 L1200,50 L0,50 Z" fill="#b8e8f0" opacity="0.45">
        <animate attributeName="d" values="M0,25 Q150,0 300,25 T600,25 T900,25 T1200,25 L1200,50 L0,50 Z;M0,25 Q150,50 300,25 T600,25 T900,25 T1200,25 L1200,50 L0,50 Z;M0,25 Q150,0 300,25 T600,25 T900,25 T1200,25 L1200,50 L0,50 Z" dur="6s" repeatCount="indefinite"/>
      </path>
    </svg>

    <!-- MERMAID REALM -->
    <div class="realm realm-mermaid">
      <div class="bubble" style="width:12px;height:12px;left:12%;bottom:28%;--d:7s"></div>
      <div class="bubble" style="width:8px;height:8px;left:28%;bottom:18%;--d:9s;--dl:1s"></div>
      <div class="bubble" style="width:16px;height:16px;right:14%;bottom:35%;--d:6s;--dl:2s"></div>
      <div class="bubble" style="width:6px;height:6px;right:32%;bottom:12%;--d:10s;--dl:.5s"></div>
      <div class="fdeco" style="top:8%;left:5%;--d:8s;--dl:.5s;--fy:-10px;--sz:18px;--o:0.35">üêö</div>
      <div class="fdeco" style="top:12%;right:7%;--d:6s;--dl:1.5s;--fy:-16px;--sz:20px;--o:0.3">üê†</div>

      <div class="mermaid-scene">
        <svg viewBox="0 0 500 180">
          <defs>
            <linearGradient id="pg1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#b2ebf2"/><stop offset="50%" style="stop-color:#e0f7fa"/><stop offset="100%" style="stop-color:#b2dfdb"/></linearGradient>
          </defs>
          <ellipse cx="250" cy="180" rx="260" ry="25" fill="#ffe0b2" opacity="0.25"/>
          <path d="M60,165 Q50,130 70,110 Q60,90 75,82" fill="none" stroke="#f48fb1" stroke-width="5" stroke-linecap="round" opacity="0.45"/>
          <path d="M420,165 Q430,125 410,102" fill="none" stroke="#ce93d8" stroke-width="5" stroke-linecap="round" opacity="0.4"/>
          <path d="M100,175 Q108,145 96,118 Q106,92 98,70" fill="none" stroke="#81c784" stroke-width="3.5" stroke-linecap="round" opacity="0.35">
            <animate attributeName="d" values="M100,175 Q108,145 96,118 Q106,92 98,70;M100,175 Q92,145 104,118 Q94,92 102,70;M100,175 Q108,145 96,118 Q106,92 98,70" dur="5s" repeatCount="indefinite"/>
          </path>
          <rect x="195" y="72" width="110" height="90" rx="5" fill="url(#pg1)" stroke="#80deea" stroke-width="1.2" opacity="0.75"/>
          <rect x="175" y="50" width="32" height="112" rx="4" fill="url(#pg1)" stroke="#80deea" stroke-width="1.2" opacity="0.75"/>
          <ellipse cx="191" cy="50" rx="16" ry="10" fill="#b2ebf2" stroke="#80deea" stroke-width="1.2" opacity="0.75"/>
          <rect x="293" y="50" width="32" height="112" rx="4" fill="url(#pg1)" stroke="#80deea" stroke-width="1.2" opacity="0.75"/>
          <ellipse cx="309" cy="50" rx="16" ry="10" fill="#b2ebf2" stroke="#80deea" stroke-width="1.2" opacity="0.75"/>
          <ellipse cx="250" cy="72" rx="32" ry="22" fill="#e0f7fa" stroke="#80deea" stroke-width="1.2" opacity="0.75"/>
          <circle cx="250" cy="58" r="4" fill="#ffd54f" opacity="0.5"><animate attributeName="opacity" values="0.5;0.2;0.5" dur="2s" repeatCount="indefinite"/></circle>
          <ellipse cx="225" cy="105" rx="7" ry="9" fill="#e0f7fa" stroke="#80deea" stroke-width="0.8"/>
          <ellipse cx="250" cy="100" rx="9" ry="10" fill="#e0f7fa" stroke="#80deea" stroke-width="0.8"/>
          <ellipse cx="275" cy="105" rx="7" ry="9" fill="#e0f7fa" stroke="#80deea" stroke-width="0.8"/>
          <rect x="240" y="135" width="20" height="27" rx="10" fill="#00acc1" opacity="0.3"/>
        </svg>
      </div>

      <div class="realm-title mt">Mermaid Palace</div>
      <div class="portal-grid">
        <div class="portal p-m1" onclick="goTo('mermaid')"><div class="portal-icon">üßú‚Äç‚ôÄÔ∏è</div><div class="portal-label">Mermaid<br>Dress-Up</div></div>
        <div class="portal p-m2" onclick="goTo('stars')"><div class="portal-icon">‚≠ê</div><div class="portal-label">Catch the<br>Stars</div></div>
        <div class="portal p-m3" onclick="goTo('treasure')"><div class="portal-icon">üêö</div><div class="portal-label">Treasure<br>Hunt</div></div>
        <div class="portal p-m4" onclick="goTo('story')"><div class="portal-icon">üìñ</div><div class="portal-label">Story<br>Time</div></div>
        <div class="portal p-m5" onclick="goTo('academy')"><div class="portal-icon">üî¢</div><div class="portal-label">Princess<br>Academy</div></div>
      </div>
      <div style="height:40px"></div>
    </div>
  </div>
</div>

<!-- ============================================
     PAGE: DRESS-UP
     ============================================ -->
<div class="page" id="page-dressup">
  <div class="hdr">
    <button class="hdr-btn" onclick="goTo('home')">üè∞</button>
    <div class="hdr-title">‚ú® Dress-Up Studio ‚ú®</div>
    <button class="hdr-btn" style="border-color:rgba(255,213,79,0.5);font-size:16px" onclick="showMirror()">üëë</button>
  </div>
  <div class="du-layout">
    <div class="du-stage">
      <div class="du-stage-glow"></div>
      <div class="princess-container" id="princess-container">
        <svg class="princess-svg" viewBox="0 0 300 480" id="princess-svg">
          <defs>
            <linearGradient id="skinG" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#fdd9b5"/><stop offset="100%" style="stop-color:#f5c6a0"/></linearGradient>
            <linearGradient id="hairG" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#6d4c41"/><stop offset="100%" style="stop-color:#4e342e"/></linearGradient>
            <linearGradient id="blnG" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#ffe082"/><stop offset="100%" style="stop-color:#ffc107"/></linearGradient>
            <linearGradient id="redG" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#ef5350"/><stop offset="100%" style="stop-color:#c62828"/></linearGradient>
            <radialGradient id="cheekG" cx="50%" cy="50%" r="50%"><stop offset="0%" style="stop-color:#f8a4c8;stop-opacity:0.5"/><stop offset="100%" style="stop-color:#f8a4c8;stop-opacity:0"/></radialGradient>
            <filter id="ss"><feDropShadow dx="0" dy="3" stdDeviation="4" flood-color="rgba(0,0,0,0.1)"/></filter>
          </defs>
          <g id="hair-back"></g>
          <g id="wings-layer"></g>
          <g id="dress-layer" filter="url(#ss)"><g id="current-dress"></g></g>
          <g id="body-layer">
            <rect x="140" y="140" width="20" height="22" rx="5" fill="url(#skinG)"/>
            <path d="M120,158 Q130,150 150,148 Q170,150 180,158 Q185,165 182,175 Q170,170 150,168 Q130,170 118,175 Q115,165 120,158 Z" fill="url(#skinG)"/>
            <path d="M118,168 Q108,185 102,210 Q98,225 100,235 Q103,238 107,234 Q108,220 113,200 Q118,185 120,175 Z" fill="url(#skinG)"/>
            <path d="M182,168 Q192,185 198,210 Q202,225 200,235 Q197,238 193,234 Q192,220 187,200 Q182,185 180,175 Z" fill="url(#skinG)"/>
            <ellipse cx="103" cy="237" rx="7" ry="6" fill="url(#skinG)"/>
            <ellipse cx="197" cy="237" rx="7" ry="6" fill="url(#skinG)"/>
          </g>
          <g id="head-layer">
            <ellipse cx="150" cy="105" rx="38" ry="44" fill="url(#skinG)"/>
            <ellipse cx="112" cy="108" rx="6" ry="8" fill="url(#skinG)"/>
            <ellipse cx="188" cy="108" rx="6" ry="8" fill="url(#skinG)"/>
            <ellipse cx="135" cy="102" rx="8" ry="6" fill="white"/><circle cx="136" cy="102" r="4.5" fill="#5d4037"/><circle cx="137.5" cy="100.5" r="1.8" fill="white"/><circle cx="134" cy="103" r="0.8" fill="white" opacity="0.5"/>
            <path d="M127,100 Q135,95 143,100" fill="none" stroke="#5d4037" stroke-width="1.2" stroke-linecap="round"/>
            <ellipse cx="165" cy="102" rx="8" ry="6" fill="white"/><circle cx="164" cy="102" r="4.5" fill="#5d4037"/><circle cx="165.5" cy="100.5" r="1.8" fill="white"/><circle cx="162" cy="103" r="0.8" fill="white" opacity="0.5"/>
            <path d="M157,100 Q165,95 173,100" fill="none" stroke="#5d4037" stroke-width="1.2" stroke-linecap="round"/>
            <path d="M128,92 Q135,88 142,91" fill="none" stroke="#6d4c41" stroke-width="1.2" stroke-linecap="round"/>
            <path d="M158,91 Q165,88 172,92" fill="none" stroke="#6d4c41" stroke-width="1.2" stroke-linecap="round"/>
            <path d="M148,110 Q150,114 152,110" fill="none" stroke="#d4a574" stroke-width="1" stroke-linecap="round"/>
            <path d="M139,122 Q144,128 150,129 Q156,128 161,122" fill="none" stroke="#e57373" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M142,123 Q150,131 158,123" fill="#f48fb1" opacity="0.3"/>
            <circle cx="125" cy="116" r="8" fill="url(#cheekG)"/><circle cx="175" cy="116" r="8" fill="url(#cheekG)"/>
          </g>
          <g id="hair-front"></g>
          <g id="crown-layer"></g>
          <g id="shoes-layer"></g>
          <g id="wand-layer"></g>
        </svg>
      </div>
    </div>
    <div class="wardrobe">
      <div class="cat-tabs" id="cat-tabs"></div>
      <div class="items-row" id="items-row"></div>
    </div>
  </div>
</div>

<!-- Mirror overlay -->
<div class="mirror-ov" id="mirror-ov" onclick="hideMirror()">
  <div class="mirror-fr">
    <svg viewBox="0 0 360 440" width="100%" height="100%">
      <defs>
        <linearGradient id="mfg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ffd54f"/><stop offset="50%" style="stop-color:#ffe082"/><stop offset="100%" style="stop-color:#ffca28"/></linearGradient>
        <radialGradient id="mgl" cx="50%" cy="40%" r="50%"><stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.9"/><stop offset="100%" style="stop-color:#e1bee7;stop-opacity:0.4"/></radialGradient>
      </defs>
      <ellipse cx="180" cy="200" rx="160" ry="200" fill="url(#mfg)" stroke="#f9a825" stroke-width="3"/>
      <ellipse cx="180" cy="200" rx="143" ry="183" fill="url(#mgl)" stroke="#ffe082" stroke-width="2"/>
      <circle cx="180" cy="8" r="9" fill="#e91e8c" opacity="0.6"/><circle cx="25" cy="200" r="6" fill="#7b1fa2" opacity="0.5"/><circle cx="335" cy="200" r="6" fill="#7b1fa2" opacity="0.5"/>
      <rect x="165" y="392" width="30" height="38" rx="8" fill="url(#mfg)" stroke="#f9a825" stroke-width="2"/>
      <circle cx="130" cy="130" r="4" fill="white" opacity="0.7"><animate attributeName="opacity" values="0.7;0.2;0.7" dur="2s" repeatCount="indefinite"/></circle>
    </svg>
  </div>
  <div class="mirror-txt">You look beautiful,<br>Princess Shiloh! üíñ</div>
</div>

<!-- ============================================
     PAGE: COLORING
     ============================================ -->
<div class="page" id="page-coloring">
  <div class="hdr">
    <button class="hdr-btn" onclick="goTo('home')">üè∞</button>
    <div class="hdr-title">üé® Enchanted Coloring Book ‚ú®</div>
    <button class="hdr-btn" style="font-size:16px" onclick="coloringDone()">‚≠ê</button>
  </div>
  <div class="col-layout">
    <div class="col-canvas-wrap" id="col-canvas-wrap">
      <div class="col-canvas-inner" id="col-canvas-inner">
        <canvas id="coloring-canvas"></canvas>
        <!-- Hidden SVG for rendering outlines -->
        <svg id="col-svg-src" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:0"></svg>
      </div>
    </div>
    <div class="col-toolbar">
      <div class="col-pages" id="col-pages"></div>
      <div class="col-palette" id="col-palette"></div>
      <div class="col-tools" id="col-tools"></div>
    </div>
  </div>
</div>

<!-- ============================================
     PAGE: PUZZLE
     ============================================ -->
<div class="page" id="page-puzzle">
  <div class="hdr">
    <button class="hdr-btn" onclick="goTo('home')">üè∞</button>
    <div class="hdr-title">üß© Puzzle Palace ‚ú®</div>
    <div class="star-counter"><span class="si">‚≠ê</span><span id="star-puzzle">0</span></div>
  </div>
  <div class="pz-layout">
    <div class="pz-board-wrap" id="pz-board-wrap">
      <div class="pz-board" id="pz-board">
        <div class="pz-complete" id="pz-complete">
          <div class="pz-complete-title">‚ú® Amazing! ‚ú®</div>
          <div class="pz-complete-sub">You did it, Princess Shiloh!</div>
          <button class="pz-complete-btn" onclick="pzNextPuzzle()">Next Puzzle üß©</button>
        </div>
      </div>
    </div>
    <div class="pz-toolbar">
      <div class="pz-chooser" id="pz-chooser"></div>
      <div class="pz-diff" id="pz-diff"></div>
    </div>
  </div>
</div>

<!-- ============================================
     PAGE: DANCE PARTY
     ============================================ -->
<div class="page" id="page-dance">
  <div class="hdr dn-hdr-override">
    <button class="hdr-btn" onclick="dnStop();goTo('home')" style="border-color:rgba(206,147,216,0.3)">üè∞</button>
    <div class="hdr-title">üíÉ Princess Dance Party üé∂</div>
    <div class="dn-score" id="dn-score">0</div>
  </div>
  <div class="dn-layout" id="dn-layout">
    <!-- Disco lights -->
    <div class="dn-light" style="width:180px;height:180px;background:rgba(233,30,140,0.2);top:10%;left:-5%;--d:3s;--o1:0.1;--o2:0.25"></div>
    <div class="dn-light" style="width:200px;height:200px;background:rgba(123,31,162,0.2);top:5%;right:-5%;--d:4s;--o1:0.08;--o2:0.2"></div>
    <div class="dn-light" style="width:160px;height:160px;background:rgba(255,213,79,0.15);top:25%;left:20%;--d:3.5s;--o1:0.05;--o2:0.18"></div>
    <div class="dn-light" style="width:140px;height:140px;background:rgba(129,212,250,0.15);top:20%;right:15%;--d:5s;--o1:0.08;--o2:0.22"></div>

    <!-- Dance floor tiles -->
    <div class="dn-floor" id="dn-floor"></div>

    <!-- Dancer -->
    <div class="dn-dancer" id="dn-dancer">
      <svg viewBox="0 0 120 200">
        <ellipse cx="60" cy="42" rx="22" ry="26" fill="#fdd9b5"/>
        <path d="M38,30 Q38,8 60,5 Q82,8 82,30 Q84,50 80,65 Q74,70 60,72 Q46,70 40,65 Q36,50 38,30Z" fill="#6d4c41"/>
        <ellipse cx="50" cy="40" rx="5" ry="4" fill="white"/><circle cx="51" cy="40" r="3" fill="#5d4037"/><circle cx="52" cy="39" r="1" fill="white"/>
        <ellipse cx="70" cy="40" rx="5" ry="4" fill="white"/><circle cx="69" cy="40" r="3" fill="#5d4037"/><circle cx="70" cy="39" r="1" fill="white"/>
        <path d="M55,52 Q60,56 65,52" fill="none" stroke="#e57373" stroke-width="1.5" stroke-linecap="round"/>
        <circle cx="42" cy="48" r="4" fill="#f8a4c8" opacity="0.4"/>
        <circle cx="78" cy="48" r="4" fill="#f8a4c8" opacity="0.4"/>
        <path d="M52,22 L54,12 L56,19 L60,8 L64,19 L66,12 L68,22" fill="#ffd54f" stroke="#f9a825" stroke-width="0.8"/>
        <path d="M45,68 Q60,65 75,68 L78,80 Q60,82 42,80Z" fill="#e91e8c"/>
        <path d="M42,78 Q32,100 25,140 Q60,148 95,140 Q88,100 78,78" fill="#f48fb1"/>
        <path d="M45,68 Q35,75 28,90" fill="none" stroke="#fdd9b5" stroke-width="6" stroke-linecap="round"/>
        <path d="M75,68 Q85,75 92,90" fill="none" stroke="#fdd9b5" stroke-width="6" stroke-linecap="round"/>
        <ellipse cx="26" cy="92" rx="5" ry="4.5" fill="#fdd9b5"/>
        <ellipse cx="94" cy="92" rx="5" ry="4.5" fill="#fdd9b5"/>
        <path d="M55,140 L52,185" fill="none" stroke="#fdd9b5" stroke-width="5" stroke-linecap="round"/>
        <path d="M65,140 L68,185" fill="none" stroke="#fdd9b5" stroke-width="5" stroke-linecap="round"/>
        <ellipse cx="50" cy="188" rx="8" ry="4" fill="#ffd54f"/>
        <ellipse cx="70" cy="188" rx="8" ry="4" fill="#ffd54f"/>
        <circle cx="60" cy="78" r="3" fill="#ffd54f" opacity="0.7"/>
      </svg>
    </div>

    <div class="dn-combo" id="dn-combo">üî• Combo x3!</div>

    <!-- Hit buttons -->
    <div class="dn-btn-row" id="dn-btn-row">
      <div class="dn-hit-btn dn-btn-pink" data-lane="0" ontouchstart="dnHit(0,event)" onmousedown="dnHit(0,event)">üíñ</div>
      <div class="dn-hit-btn dn-btn-purple" data-lane="1" ontouchstart="dnHit(1,event)" onmousedown="dnHit(1,event)">üíú</div>
      <div class="dn-hit-btn dn-btn-gold" data-lane="2" ontouchstart="dnHit(2,event)" onmousedown="dnHit(2,event)">‚≠ê</div>
      <div class="dn-hit-btn dn-btn-blue" data-lane="3" ontouchstart="dnHit(3,event)" onmousedown="dnHit(3,event)">üíé</div>
    </div>

    <!-- Start overlay -->
    <div class="dn-overlay" id="dn-overlay">
      <div class="dn-overlay-title">üíÉ Dance Party! üé∂</div>
      <div class="dn-overlay-sub">Tap the buttons when the notes<br>reach them! Don't miss!</div>
      <button class="dn-start-btn" onclick="dnStart()">Let's Dance! ‚ú®</button>
    </div>
  </div>
</div>

<!-- ============================================
     PAGE: CATCH THE STARS
     ============================================ -->
<div class="page" id="page-stars">
  <div class="hdr st-hdr-override">
    <button class="hdr-btn" onclick="stStop();goTo('home')" style="border-color:rgba(197,202,233,0.3);background:rgba(255,255,255,0.15)">üè∞</button>
    <div class="hdr-title">‚≠ê Catch the Stars ‚ú®</div>
    <div style="width:44px"></div>
  </div>
  <div class="st-layout" id="st-layout">
    <div class="st-moon"></div>
    <div class="st-ocean"></div>
    <div id="st-bg-stars"></div>

    <div class="st-score-bar">
      <div class="st-score-val" id="st-score">‚≠ê 0</div>
      <div class="st-lives" id="st-lives">üíñüíñüíñ</div>
      <div class="st-timer" id="st-timer">0:30</div>
    </div>

    <div class="st-overlay" id="st-overlay">
      <div class="st-ov-title">‚≠ê Catch the Stars! ‚≠ê</div>
      <div class="st-ov-sub">Tap the falling stars and gems!<br>Don't tap the crabs! ü¶Ä</div>
      <button class="st-ov-btn" onclick="stStart()">Start! ‚≠ê</button>
    </div>
  </div>
</div>

<!-- ============================================
     PAGE: PRINCESS ACADEMY
     ============================================ -->
<div class="page" id="page-academy">
  <div class="hdr">
    <button class="hdr-btn" onclick="goTo('home')">üè∞</button>
    <div class="hdr-title">üéì Princess Academy ‚ú®</div>
    <div class="star-counter"><span class="si">‚≠ê</span><span id="star-academy">0</span></div>
  </div>
  <div class="ac-layout">
    <div class="ac-question-area" id="ac-question-area">
      <div class="ac-prompt" id="ac-prompt">How many stars?</div>
      <div class="ac-display" id="ac-display">‚≠ê ‚≠ê ‚≠ê</div>
      <div class="ac-answers" id="ac-answers"></div>
      <div class="ac-feedback" id="ac-feedback">üåü Correct!</div>
    </div>
    <div class="ac-toolbar">
      <div class="ac-cat-label" id="ac-cat-label">Counting</div>
      <div class="ac-progress" id="ac-progress"></div>
      <div class="ac-streak" id="ac-streak">üî• 0</div>
    </div>
  </div>
</div>

<!-- ============================================
     PAGE: TREASURE HUNT (Memory Match)
     ============================================ -->
<div class="page" id="page-treasure">
  <div class="hdr">
    <button class="hdr-btn" onclick="goTo('home')">üè∞</button>
    <div class="hdr-title">üêö Treasure Hunt ‚ú®</div>
    <div class="star-counter"><span class="si">‚≠ê</span><span id="star-treasure">0</span></div>
  </div>
  <div class="th-layout" id="th-layout">
    <!-- Bubbles -->
    <div class="th-bubble" style="width:20px;height:20px;top:20%;left:8%;--d:5s;--dl:0s"></div>
    <div class="th-bubble" style="width:14px;height:14px;top:40%;right:10%;--d:7s;--dl:1s"></div>
    <div class="th-bubble" style="width:18px;height:18px;top:60%;left:15%;--d:6s;--dl:2s"></div>
    <div class="th-bubble" style="width:12px;height:12px;top:30%;right:20%;--d:4s;--dl:0.5s"></div>
    <div class="th-bubble" style="width:16px;height:16px;top:50%;left:80%;--d:8s;--dl:1.5s"></div>

    <div class="th-info">
      <div class="th-moves" id="th-moves">Moves: 0</div>
      <div class="th-pairs" id="th-pairs">Pairs: 0/0</div>
    </div>
    <div class="th-grid-wrap">
      <div class="th-grid" id="th-grid"></div>
    </div>

    <div class="th-complete" id="th-complete">
      <div class="th-complete-title">üêö All Treasures Found! üêö</div>
      <div class="th-complete-sub" id="th-complete-sub">Amazing, Princess Shiloh!</div>
      <button class="th-complete-btn" onclick="buildThGrid()">Play Again! üêö</button>
    </div>

    <div class="th-toolbar">
      <div class="th-diff-btn act" onclick="selectThDiff(0,this)">Easy</div>
      <div class="th-diff-btn" onclick="selectThDiff(1,this)">Medium</div>
      <div class="th-diff-btn" onclick="selectThDiff(2,this)">Hard</div>
      <div class="th-reset-btn" onclick="buildThGrid()">üîÄ New Game</div>
    </div>
  </div>
</div>

<!-- ============================================
     PAGE: STORY TIME
     ============================================ -->
<div class="page" id="page-story">
  <div class="hdr sb-hdr-override">
    <button class="hdr-btn" onclick="goTo('home')" style="border-color:rgba(206,147,216,0.3);background:rgba(255,255,255,0.1)">üè∞</button>
    <div class="hdr-title">üìñ Story Time ‚ú®</div>
    <div style="width:44px"></div>
  </div>
  <div class="sb-layout">
    <div class="sb-scene" id="sb-scene">
      <div class="sb-illustration" id="sb-illustration"></div>
      <div class="sb-text-box">
        <div class="sb-text" id="sb-text"></div>
      </div>
      <div class="sb-choices" id="sb-choices"></div>
      <div class="sb-nav" id="sb-nav">
        <div class="sb-nav-btn" onclick="sbPrev()">‚Üê Back</div>
        <div class="sb-page-num" id="sb-page-num">1 / 10</div>
        <div class="sb-nav-btn primary" onclick="sbNext()">Next ‚Üí</div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================
     PAGE: ROYAL TEA PARTY
     ============================================ -->
<div class="page" id="page-tea">
  <div class="hdr">
    <button class="hdr-btn" onclick="goTo('home')">üè∞</button>
    <div class="hdr-title">ü´ñ Royal Tea Party ‚ú®</div>
    <div class="star-counter"><span class="si">‚≠ê</span><span id="star-tea">0</span></div>
  </div>
  <div class="tp-layout">
    <div class="tp-table-area">
      <div class="tp-table" id="tp-table">
        <div class="tp-teapot" id="tp-teapot" onclick="tpPourTea()">ü´ñ</div>
        <div class="tp-msg" id="tp-msg"></div>
      </div>
    </div>
    <div class="tp-toolbar" id="tp-toolbar">
      <div class="tp-section-label" id="tp-section-label">Pick a treat</div>
      <div class="tp-items" id="tp-items"></div>
    </div>
  </div>
</div>

<!-- ============================================
     PAGE: MERMAID DRESS-UP
     ============================================ -->
<div class="page" id="page-mermaid">
  <div class="hdr">
    <button class="hdr-btn" onclick="goTo('home')" style="border-color:rgba(0,172,193,0.3)">üè∞</button>
    <div class="hdr-title">üßú‚Äç‚ôÄÔ∏è Mermaid Dress-Up ‚ú®</div>
    <div class="star-counter"><span class="si">‚≠ê</span><span id="star-mermaid">0</span></div>
  </div>
  <div class="md-layout">
    <div class="md-stage" id="md-stage">
      <div class="md-bubble" style="width:16px;height:16px;top:15%;left:10%;--d:4s"></div>
      <div class="md-bubble" style="width:12px;height:12px;top:35%;right:12%;--d:6s;--dl:1s"></div>
      <div class="md-bubble" style="width:20px;height:20px;top:55%;left:8%;--d:5s;--dl:2s"></div>
      <div class="md-bubble" style="width:10px;height:10px;top:25%;right:20%;--d:7s;--dl:0.5s"></div>
      <div class="md-canvas-wrap" id="md-canvas"></div>
    </div>
    <div class="md-toolbar">
      <div class="md-tabs" id="md-tabs"></div>
      <div class="md-options" id="md-options"></div>
    </div>
  </div>
</div>

<script>
let currentPage = 'home';
let soundOn = true;
let stars = parseInt(localStorage.getItem('shiloh_stars')||'0');
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();

function updateStarDisplays() {
  document.querySelectorAll('[id^="star-"]').forEach(el => el.textContent = stars);
  document.getElementById('star-home').textContent = stars;
}
updateStarDisplays();

// ===== NAVIGATION =====
function goTo(page) {
  // Stop dance if leaving
  if (currentPage === 'dance' && typeof dnStop === 'function') dnStop();
  if (currentPage === 'stars' && typeof stStop === 'function') stStop();
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  currentPage = page;
  playPortalChime();
  burstCenter(25);
  if (page === 'dressup') initDressup();
  if (page === 'coloring') initColoring();
  if (page === 'puzzle') initPuzzle();
  if (page === 'dance') initDance();
  if (page === 'stars') initStars();
  if (page === 'academy') initAcademy();
  if (page === 'treasure') initTreasure();
  if (page === 'story') initStory();
  if (page === 'tea') initTea();
  if (page === 'mermaid') initMermaid();
}
function comingSoon(name) { showToast(name + ' ‚Äî Coming Soon! ‚ú®'); playChime(); }

// ===== SPARKLE SYSTEM =====
const canvas = document.getElementById('sparkle-canvas');
const ctx = canvas.getContext('2d');
let parts = [];
function resizeSC() { canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
resizeSC(); window.addEventListener('resize', resizeSC);

class P {
  constructor(x,y,s=false){
    this.x=x;this.y=y;const a=Math.random()*Math.PI*2,sp=s?Math.random()*0.5:Math.random()*3+1;
    this.vx=Math.cos(a)*sp;this.vy=Math.sin(a)*sp-(s?0.3:1.5);
    this.life=1;this.decay=s?Math.random()*.004+.002:Math.random()*.02+.012;
    this.sz=s?Math.random()*2.5+1:Math.random()*5+2;
    this.rot=Math.random()*360;this.rs=(Math.random()-0.5)*6;
    this.col=['#ffd54f','#f8a4c8','#d1b3f0','#80deea','#fff','#ff8a80'][Math.floor(Math.random()*6)];
  }
  update(){this.x+=this.vx;this.y+=this.vy;this.vy+=0.025;this.life-=this.decay;this.rot+=this.rs;return this.life>0;}
  draw(c){
    c.save();c.globalAlpha=this.life;c.translate(this.x,this.y);c.rotate(this.rot*Math.PI/180);
    const s=this.sz;c.beginPath();
    for(let i=0;i<4;i++){const a=i*Math.PI/2;c.moveTo(0,0);c.lineTo(Math.cos(a-.15)*s*.4,Math.sin(a-.15)*s*.4);c.lineTo(Math.cos(a)*s,Math.sin(a)*s);c.lineTo(Math.cos(a+.15)*s*.4,Math.sin(a+.15)*s*.4);}
    c.fillStyle=this.col;c.fill();c.restore();
  }
}
let at=0;
function animLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(++at%10===0) parts.push(new P(Math.random()*canvas.width,Math.random()*canvas.height,true));
  parts=parts.filter(p=>{p.draw(ctx);return p.update();});
  requestAnimationFrame(animLoop);
}
animLoop();
function burst(x,y,n=15){for(let i=0;i<n;i++) parts.push(new P(x,y));}
function burstCenter(n=20){burst(window.innerWidth/2,window.innerHeight/2,n);}
document.addEventListener('click',e=>{burst(e.clientX,e.clientY,8);});

// ===== SOUND =====
function playChime(){if(!soundOn)return;try{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.setValueAtTime([523,659,784,1047][Math.floor(Math.random()*4)],audioCtx.currentTime);o.type='sine';g.gain.setValueAtTime(.05,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.3);o.start();o.stop(audioCtx.currentTime+.3);}catch(e){}}
function playPortalChime(){if(!soundOn)return;try{[523,659,784,1047].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.setValueAtTime(f,audioCtx.currentTime+i*.08);o.type='sine';g.gain.setValueAtTime(.04,audioCtx.currentTime+i*.08);g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+i*.08+.45);o.start(audioCtx.currentTime+i*.08);o.stop(audioCtx.currentTime+i*.08+.45);});}catch(e){}}
function playMagicChime(){if(!soundOn)return;try{[523,659,784,1047,1319].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.setValueAtTime(f,audioCtx.currentTime+i*.1);o.type='sine';g.gain.setValueAtTime(.04,audioCtx.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+i*.1+.55);o.start(audioCtx.currentTime+i*.1);o.stop(audioCtx.currentTime+i*.1+.55);});}catch(e){}}
function toggleSound(e){e.stopPropagation();soundOn=!soundOn;document.getElementById('snd-toggle').textContent=soundOn?'üîä':'üîá';}
document.addEventListener('click',()=>{if(audioCtx.state==='suspended')audioCtx.resume();},{once:true});

// ===== TOAST =====
function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);}

// ===== GREETING CYCLE =====
const greets=["üëë Welcome, Princess Shiloh!","‚ú® Hello, Princess Shiloh!","üíñ Shiloh's Magical Kingdom","üåü Ready for adventure, Shiloh?"];
let gi=0;
setInterval(()=>{gi=(gi+1)%greets.length;const el=document.getElementById('greeting');el.style.opacity='0';setTimeout(()=>{el.textContent=greets[gi];el.style.transition='opacity .4s';el.style.opacity='1';},350);},6000);

// =============================================
// DRESS-UP LOGIC
// =============================================
const WD = {
  dresses:[
    {id:'pink-bg',label:'Rose Gown',color:'#f48fb1',locked:false,svg:`<path d="M120,185 Q115,175 118,165 Q130,155 150,152 Q170,155 182,165 Q185,175 180,185 Z" fill="#f48fb1" stroke="#ec407a" stroke-width="0.8"/><path d="M118,185 Q150,190 182,185 Q184,195 182,200 Q150,205 118,200 Z" fill="#ec407a"/><path d="M118,198 Q110,240 85,320 Q80,350 78,400 Q78,440 100,460 Q130,475 150,478 Q170,475 200,460 Q222,440 222,400 Q220,350 215,320 Q190,240 182,198 Z" fill="#f48fb1" stroke="#ec407a" stroke-width="0.5"/><path d="M122,200 Q115,245 95,325 Q90,365 92,410 Q95,445 115,462 Q140,473 150,475 Q160,473 185,462 Q205,445 208,410 Q210,365 205,325 Q185,245 178,200 Z" fill="#f8bbd0" opacity="0.4"/><path d="M125,160 Q150,168 175,160" fill="none" stroke="#fce4ec" stroke-width="1.5" opacity="0.6"/><circle cx="130" cy="280" r="1.5" fill="#ffd54f" opacity="0.6"><animate attributeName="opacity" values="0.6;0.2;0.6" dur="3s" repeatCount="indefinite"/></circle><circle cx="170" cy="320" r="1.5" fill="#ffd54f" opacity="0.5"><animate attributeName="opacity" values="0.5;0.1;0.5" dur="2.5s" repeatCount="indefinite"/></circle>`},
    {id:'purple-r',label:'Lavender Royal',color:'#ce93d8',locked:false,svg:`<path d="M120,185 Q115,175 118,162 Q130,152 150,149 Q170,152 182,162 Q185,175 180,185 Z" fill="#ce93d8" stroke="#ab47bc" stroke-width="0.8"/><path d="M118,185 Q150,190 182,185 Q184,195 182,200 Q150,205 118,200 Z" fill="#ab47bc"/><path d="M116,198 Q105,250 82,330 Q76,365 75,410 Q76,445 100,462 Q130,477 150,480 Q170,477 200,462 Q224,445 225,410 Q224,365 218,330 Q195,250 184,198 Z" fill="#ce93d8" stroke="#ab47bc" stroke-width="0.5"/><path d="M120,200 Q112,250 92,335 Q88,370 90,415 Q93,448 115,463 Q140,475 150,477 Q160,475 185,463 Q207,448 210,415 Q212,370 208,335 Q188,250 180,200 Z" fill="#e1bee7" opacity="0.35"/><circle cx="150" cy="192" r="3" fill="#ffd54f" opacity="0.7"><animate attributeName="opacity" values="0.7;0.3;0.7" dur="2s" repeatCount="indefinite"/></circle>`},
    {id:'blue-i',label:'Ice Crystal',color:'#81d4fa',locked:false,svg:`<path d="M120,185 Q115,175 118,163 Q130,153 150,150 Q170,153 182,163 Q185,175 180,185 Z" fill="#81d4fa" stroke="#4fc3f7" stroke-width="0.8"/><path d="M118,185 Q150,190 182,185 Q184,195 182,200 Q150,205 118,200 Z" fill="#4fc3f7"/><path d="M118,198 Q108,248 88,328 Q82,360 80,405 Q80,442 102,460 Q132,476 150,478 Q168,476 198,460 Q220,442 220,405 Q218,360 212,328 Q192,248 182,198 Z" fill="#81d4fa" stroke="#4fc3f7" stroke-width="0.5"/><path d="M122,202 Q114,250 96,332 Q92,368 94,410 Q96,444 116,461 Q142,474 150,476 Q184,461 206,410 Q208,368 204,332 Q186,250 178,202 Z" fill="#b3e5fc" opacity="0.4"/><circle cx="135" cy="260" r="2" fill="white" opacity="0.7"><animate attributeName="opacity" values="0.7;0.2;0.7" dur="2s" repeatCount="indefinite"/></circle><circle cx="165" cy="310" r="2" fill="white" opacity="0.6"><animate attributeName="opacity" values="0.6;0.1;0.6" dur="2.5s" repeatCount="indefinite"/></circle>`},
    {id:'gold-s',label:'Golden Sun',color:'#ffd54f',locked:false,svg:`<path d="M120,185 Q115,175 118,163 Q130,153 150,150 Q170,153 182,163 Q185,175 180,185 Z" fill="#ffe082" stroke="#ffc107" stroke-width="0.8"/><path d="M118,185 Q150,190 182,185 Q184,195 182,200 Q150,205 118,200 Z" fill="#ffc107"/><path d="M116,198 Q106,248 86,325 Q80,358 78,405 Q78,442 100,460 Q130,476 150,479 Q170,476 200,460 Q222,442 222,405 Q220,358 214,325 Q194,248 184,198 Z" fill="#ffe082" stroke="#ffc107" stroke-width="0.5"/><path d="M120,202 Q113,250 95,330 Q90,365 92,410 Q95,445 115,462 Q140,474 150,476 Q185,462 208,410 Q210,365 205,330 Q187,250 180,202 Z" fill="#fff8e1" opacity="0.4"/><circle cx="150" cy="190" r="4" fill="#ffd54f" stroke="#f9a825" stroke-width="0.5" opacity="0.8"/>`},
    {id:'green-f',label:'Forest Fairy',color:'#a5d6a7',locked:true,svg:`<path d="M120,185 Q115,175 118,163 Q130,153 150,150 Q170,153 182,163 Q185,175 180,185 Z" fill="#a5d6a7" stroke="#66bb6a" stroke-width="0.8"/><path d="M118,185 Q150,190 182,185 Q184,195 182,200 Q150,205 118,200 Z" fill="#66bb6a"/><path d="M118,198 Q108,248 88,328 Q82,360 80,405 Q80,442 102,460 Q132,476 150,478 Q168,476 198,460 Q220,442 220,405 Q218,360 212,328 Q192,248 182,198 Z" fill="#a5d6a7" stroke="#66bb6a" stroke-width="0.5"/>`},
  ],
  crowns:[
    {id:'t-gold',label:'Gold Tiara',color:'#ffd54f',locked:false,svg:`<path d="M122,68 Q125,55 132,50 L135,58 L140,45 L145,56 L150,40 L155,56 L160,45 L165,58 L168,50 Q175,55 178,68 Z" fill="#ffd54f" stroke="#f9a825" stroke-width="0.8"/><path d="M122,68 Q150,72 178,68 Q178,65 177,62 Q150,66 123,62 Z" fill="#ffe082"/><circle cx="150" cy="48" r="3" fill="#e91e8c" opacity="0.7"/><circle cx="150" cy="48" r="1" fill="white" opacity="0.7"><animate attributeName="opacity" values="0.7;0.2;0.7" dur="2s" repeatCount="indefinite"/></circle>`},
    {id:'t-silver',label:'Silver Crystal',color:'#e0e0e0',locked:false,svg:`<path d="M124,68 Q127,58 133,52 L137,60 L142,48 L147,58 L150,43 L153,58 L158,48 L163,60 L167,52 Q173,58 176,68 Z" fill="#e0e0e0" stroke="#bdbdbd" stroke-width="0.8"/><path d="M124,68 Q150,72 176,68 Q176,65 175,62 Q150,66 125,62 Z" fill="#f5f5f5"/><circle cx="150" cy="50" r="3" fill="#81d4fa" opacity="0.8"/>`},
    {id:'c-rose',label:'Rose Crown',color:'#f48fb1',locked:false,svg:`<path d="M123,70 Q123,60 128,55 Q132,58 135,52 Q139,56 142,48 Q146,54 150,44 Q154,54 158,48 Q161,56 165,52 Q168,58 172,55 Q177,60 177,70 Z" fill="#f48fb1" stroke="#ec407a" stroke-width="0.8"/><path d="M123,70 Q150,74 177,70 L177,66 Q150,70 123,66 Z" fill="#f8bbd0"/><circle cx="150" cy="52" r="2.5" fill="#ffd54f" opacity="0.8"/>`},
    {id:'fl-cr',label:'Flower Crown',color:'#f8a4c8',locked:true,svg:`<ellipse cx="150" cy="68" rx="32" ry="6" fill="#a5d6a7" opacity="0.5"/><circle cx="125" cy="66" r="5" fill="#f48fb1" opacity="0.8"/><circle cx="137" cy="62" r="5" fill="#ce93d8" opacity="0.8"/><circle cx="150" cy="60" r="6" fill="#f8a4c8" opacity="0.8"/><circle cx="163" cy="62" r="5" fill="#81d4fa" opacity="0.7"/><circle cx="175" cy="66" r="5" fill="#f48fb1" opacity="0.8"/>`},
  ],
  hair:[
    {id:'h-brown',label:'Brown Waves',color:'#6d4c41',locked:false,hb:`<path d="M105,95 Q100,180 95,280 Q93,310 105,310 Q110,250 115,180 Z" fill="url(#hairG)" opacity="0.9"/><path d="M195,95 Q200,180 205,280 Q207,310 195,310 Q190,250 185,180 Z" fill="url(#hairG)" opacity="0.9"/>`,hf:`<path d="M112,82 Q115,65 130,58 Q145,52 150,52 Q155,52 170,58 Q185,65 188,82 Q190,95 188,105 Q185,95 180,85 Q175,78 165,72 Q155,68 150,68 Q145,68 135,72 Q125,78 120,85 Q115,95 112,105 Q110,95 112,82 Z" fill="url(#hairG)"/><path d="M112,95 Q108,110 107,130 Q106,140 108,145 Q112,140 113,125 Z" fill="url(#hairG)" opacity="0.85"/><path d="M188,95 Q192,110 193,130 Q194,140 192,145 Q188,140 187,125 Z" fill="url(#hairG)" opacity="0.85"/>`},
    {id:'h-blonde',label:'Golden Blonde',color:'#ffe082',locked:false,hb:`<path d="M105,95 Q100,180 95,280 Q93,310 105,310 Q110,250 115,180 Z" fill="url(#blnG)" opacity="0.9"/><path d="M195,95 Q200,180 205,280 Q207,310 195,310 Q190,250 185,180 Z" fill="url(#blnG)" opacity="0.9"/>`,hf:`<path d="M112,82 Q115,65 130,58 Q145,52 150,52 Q155,52 170,58 Q185,65 188,82 Q190,95 188,105 Q185,95 180,85 Q175,78 165,72 Q155,68 150,68 Q145,68 135,72 Q125,78 120,85 Q115,95 112,105 Q110,95 112,82 Z" fill="url(#blnG)"/><path d="M112,95 Q108,110 107,130 Q106,140 108,145 Q112,140 113,125 Z" fill="url(#blnG)" opacity="0.85"/><path d="M188,95 Q192,110 193,130 Q194,140 192,145 Q188,140 187,125 Z" fill="url(#blnG)" opacity="0.85"/>`},
    {id:'h-red',label:'Red Curls',color:'#ef5350',locked:false,hb:`<path d="M105,95 Q98,150 92,220 Q88,260 90,290 Q95,300 102,295 Q100,260 104,220 Q108,170 112,120 Z" fill="url(#redG)" opacity="0.85"/><path d="M195,95 Q202,150 208,220 Q212,260 210,290 Q205,300 198,295 Q200,260 196,220 Q192,170 188,120 Z" fill="url(#redG)" opacity="0.85"/><circle cx="95" cy="250" r="12" fill="url(#redG)" opacity="0.4"/><circle cx="205" cy="245" r="12" fill="url(#redG)" opacity="0.4"/>`,hf:`<path d="M112,82 Q115,63 132,56 Q145,50 150,50 Q155,50 168,56 Q185,63 188,82 Q190,95 188,108 Q184,92 178,82 Q170,72 158,67 Q150,65 142,67 Q130,72 122,82 Q116,92 112,108 Q110,95 112,82 Z" fill="url(#redG)"/><circle cx="118" cy="80" r="8" fill="url(#redG)" opacity="0.6"/><circle cx="182" cy="80" r="8" fill="url(#redG)" opacity="0.6"/><path d="M112,95 Q106,115 105,140 Q104,150 107,152 Q111,147 112,130 Z" fill="url(#redG)" opacity="0.8"/><path d="M188,95 Q194,115 195,140 Q196,150 193,152 Q189,147 188,130 Z" fill="url(#redG)" opacity="0.8"/>`},
  ],
  shoes:[
    {id:'s-pink',label:'Pink Ballet',color:'#f48fb1',locked:false,svg:`<ellipse cx="125" cy="472" rx="16" ry="6" fill="#f48fb1"/><ellipse cx="175" cy="472" rx="16" ry="6" fill="#f48fb1"/><ellipse cx="125" cy="470" rx="14" ry="4" fill="#f8bbd0" opacity="0.5"/><ellipse cx="175" cy="470" rx="14" ry="4" fill="#f8bbd0" opacity="0.5"/>`},
    {id:'s-glass',label:'Glass Slippers',color:'#b3e5fc',locked:false,svg:`<ellipse cx="125" cy="472" rx="16" ry="6" fill="#b3e5fc" opacity="0.7" stroke="#81d4fa" stroke-width="0.5"/><ellipse cx="175" cy="472" rx="16" ry="6" fill="#b3e5fc" opacity="0.7" stroke="#81d4fa" stroke-width="0.5"/><circle cx="125" cy="469" r="1.5" fill="white" opacity="0.8"><animate attributeName="opacity" values="0.8;0.3;0.8" dur="2s" repeatCount="indefinite"/></circle><circle cx="175" cy="469" r="1.5" fill="white" opacity="0.8"><animate attributeName="opacity" values="0.8;0.3;0.8" dur="2.2s" repeatCount="indefinite"/></circle>`},
    {id:'s-gold',label:'Gold Sparkle',color:'#ffd54f',locked:false,svg:`<ellipse cx="125" cy="473" rx="15" ry="5.5" fill="#ffd54f" stroke="#f9a825" stroke-width="0.5"/><ellipse cx="175" cy="473" rx="15" ry="5.5" fill="#ffd54f" stroke="#f9a825" stroke-width="0.5"/><path d="M115,468 Q125,462 135,468" fill="#ffe082" stroke="#ffc107" stroke-width="0.5"/><path d="M165,468 Q175,462 185,468" fill="#ffe082" stroke="#ffc107" stroke-width="0.5"/>`},
  ],
  wands:[
    {id:'w-star',label:'Star Wand',color:'#ffd54f',locked:false,svg:`<line x1="100" y1="238" x2="72" y2="320" stroke="#f8a4c8" stroke-width="3" stroke-linecap="round"/><polygon points="72,295 66,310 72,307 60,320 68,315 65,325 72,318 79,325 76,315 84,320 72,307 78,310" fill="#ffd54f" stroke="#f9a825" stroke-width="0.5"/><circle cx="72" cy="310" r="3" fill="white" opacity="0.6"><animate attributeName="opacity" values="0.6;0.2;0.6" dur="1.5s" repeatCount="indefinite"/></circle>`},
    {id:'w-heart',label:'Heart Wand',color:'#f48fb1',locked:false,svg:`<line x1="100" y1="238" x2="75" y2="318" stroke="#d1b3f0" stroke-width="3" stroke-linecap="round"/><path d="M75,308 Q68,298 62,303 Q58,308 65,315 L75,325 L85,315 Q92,308 88,303 Q82,298 75,308 Z" fill="#f48fb1" stroke="#ec407a" stroke-width="0.5"/>`},
  ],
  wings:[
    {id:'wg-fairy',label:'Fairy Wings',color:'#f8bbd0',locked:false,svg:`<path d="M118,170 Q80,140 65,160 Q55,175 60,195 Q65,210 85,215 Q100,218 115,200 Z" fill="#f8bbd0" opacity="0.5" stroke="#f48fb1" stroke-width="0.5"/><path d="M182,170 Q220,140 235,160 Q245,175 240,195 Q235,210 215,215 Q200,218 185,200 Z" fill="#f8bbd0" opacity="0.5" stroke="#f48fb1" stroke-width="0.5"/><path d="M116,185 Q88,165 78,180 Q72,192 80,205 Q88,212 105,210 Z" fill="#fce4ec" opacity="0.4"/><path d="M184,185 Q212,165 222,180 Q228,192 220,205 Q212,212 195,210 Z" fill="#fce4ec" opacity="0.4"/>`},
    {id:'wg-bfly',label:'Butterfly',color:'#ce93d8',locked:false,svg:`<path d="M115,170 Q75,130 55,155 Q45,175 55,200 Q65,220 90,222 Q110,220 115,200 Z" fill="#ce93d8" opacity="0.45" stroke="#ab47bc" stroke-width="0.5"/><path d="M185,170 Q225,130 245,155 Q255,175 245,200 Q235,220 210,222 Q190,220 185,200 Z" fill="#ce93d8" opacity="0.45" stroke="#ab47bc" stroke-width="0.5"/><path d="M115,195 Q85,200 72,215 Q65,228 75,238 Q90,242 108,230 Q115,220 115,205 Z" fill="#e1bee7" opacity="0.4"/><path d="M185,195 Q215,200 228,215 Q235,228 225,238 Q210,242 192,230 Q185,220 185,205 Z" fill="#e1bee7" opacity="0.4"/>`},
  ],
};

const cats = ['dresses','crowns','hair','shoes','wands','wings'];
const catIcons = {'dresses':'üëó','crowns':'üëë','hair':'üíá‚Äç‚ôÄÔ∏è','shoes':'üë†','wands':'ü™Ñ','wings':'ü¶ã'};
let duCat = 'dresses';
let eq = {dresses:'pink-bg',crowns:null,hair:'h-brown',shoes:'s-pink',wands:null,wings:null};

function initDressup() {
  const tabs = document.getElementById('cat-tabs');
  tabs.innerHTML = cats.map(c=>`<div class="ct-tab ${c===duCat?'act':''}" onclick="switchDuCat('${c}',this)"><span class="ct-tab-i">${catIcons[c]}</span><span class="ct-tab-l">${c.charAt(0).toUpperCase()+c.slice(1)}</span></div>`).join('');
  renderDuItems();
  updatePrincess();
}

function switchDuCat(c,el){duCat=c;document.querySelectorAll('.ct-tab').forEach(t=>t.classList.remove('act'));el.classList.add('act');renderDuItems();playChime();}

function renderDuItems(){
  const row=document.getElementById('items-row');
  const items=WD[duCat];
  let h='';
  if(duCat!=='dresses'&&duCat!=='hair') h+=`<div class="clr-btn" onclick="clearDuSlot('${duCat}')"><span class="ci">‚úï</span>Remove</div>`;
  items.forEach(it=>{
    const sel=eq[duCat]===it.id;
    h+=`<div class="itm-card ${sel?'sel':''} ${it.locked?'lck':''}" onclick="${it.locked?`showToast('Earn more ‚≠ê to unlock!')`:`equipDu('${duCat}','${it.id}')`}"><svg class="ip" viewBox="0 0 52 52"><circle cx="26" cy="26" r="22" fill="${it.color}" opacity="0.25"/><circle cx="26" cy="26" r="14" fill="${it.color}" opacity="0.5"/><circle cx="26" cy="26" r="6" fill="${it.color}" opacity="0.8"/></svg>${it.locked?'<div class="lk-b">üîí</div>':''}</div>`;
  });
  row.innerHTML=h;
}

function equipDu(c,id){if(eq[c]===id)return;eq[c]=id;renderDuItems();updatePrincess();playMagicChime();const r=document.getElementById('princess-container').getBoundingClientRect();burst(r.left+r.width/2,r.top+r.height*.4,20);}
function clearDuSlot(c){eq[c]=null;renderDuItems();updatePrincess();playChime();}

function updatePrincess(){
  const d=WD.dresses.find(x=>x.id===eq.dresses)||WD.dresses[0];
  document.getElementById('current-dress').innerHTML=d.svg;
  document.getElementById('crown-layer').innerHTML=(WD.crowns.find(x=>x.id===eq.crowns)||{svg:''}).svg;
  const hr=WD.hair.find(x=>x.id===eq.hair);
  document.getElementById('hair-back').innerHTML=hr?hr.hb:'';
  document.getElementById('hair-front').innerHTML=hr?hr.hf:'';
  document.getElementById('shoes-layer').innerHTML=(WD.shoes.find(x=>x.id===eq.shoes)||{svg:''}).svg;
  document.getElementById('wand-layer').innerHTML=(WD.wands.find(x=>x.id===eq.wands)||{svg:''}).svg;
  document.getElementById('wings-layer').innerHTML=(WD.wings.find(x=>x.id===eq.wings)||{svg:''}).svg;
}

function showMirror(){document.getElementById('mirror-ov').classList.add('act');playMagicChime();for(let i=0;i<6;i++)setTimeout(()=>burst(window.innerWidth*(.2+Math.random()*.6),window.innerHeight*(.2+Math.random()*.5),18),i*200);}
function hideMirror(){document.getElementById('mirror-ov').classList.remove('act');}

// =============================================
// COLORING BOOK ‚Äî SVG + FLOOD FILL
// =============================================
const COLORS = ['#f48fb1','#e91e8c','#ce93d8','#7b1fa2','#81d4fa','#2196f3','#4dd0e1','#66bb6a','#ffd54f','#ff9800','#ef5350','#8d6e63','#ffffff','#37474f'];
const COLOR_NAMES = ['Pink','Hot Pink','Lavender','Purple','Sky Blue','Blue','Teal','Green','Yellow','Orange','Red','Brown','White','Charcoal'];

let colTool = 'fill';
let colColor = '#f48fb1';
let colPageIdx = 0;
let colCanvasW, colCanvasH;
let outlineImg = null; // stores the outline-only image data for re-compositing

const coloringPages = [
  { icon:'üë∏', label:'Princess', locked:false },
  { icon:'üè∞', label:'Castle', locked:false },
  { icon:'üßú‚Äç‚ôÄÔ∏è', label:'Mermaid', locked:false },
  { icon:'ü¶Ñ', label:'Unicorn', locked:false },
  { icon:'üêâ', label:'Dragon', locked:true },
  { icon:'üßö', label:'Fairy', locked:true },
];

// Detailed SVG illustrations ‚Äî smooth, hand-drawn style outlines
function getPageSVG(idx, w, h) {
  const vb = `0 0 ${w} ${h}`;
  const sc = Math.min(w, h);
  const sw = Math.max(1.5, sc / 220); // line width scales
  const cx = w / 2, cy = h / 2;

  const style = `fill="none" stroke="#4a3728" stroke-width="${sw}" stroke-linecap="round" stroke-linejoin="round"`;
  const thin = `fill="none" stroke="#4a3728" stroke-width="${sw*0.6}" stroke-linecap="round" stroke-linejoin="round"`;
  const dot = `fill="none" stroke="#4a3728" stroke-width="${sw*0.4}" stroke-linecap="round" stroke-linejoin="round"`;

  switch(idx) {
    case 0: return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${vb}" width="${w}" height="${h}">
      <!-- Princess in Garden -->
      <!-- Ground line -->
      <path d="M 0,${cy+sc*0.34} Q ${w*0.25},${cy+sc*0.32} ${w*0.5},${cy+sc*0.34} Q ${w*0.75},${cy+sc*0.36} ${w},${cy+sc*0.34}" ${thin}/>
      <!-- Flowers on ground -->
      <circle cx="${cx-sc*0.32}" cy="${cy+sc*0.31}" r="${sc*0.02}" ${thin}/>
      <line x1="${cx-sc*0.32}" y1="${cy+sc*0.31}" x2="${cx-sc*0.32}" y2="${cy+sc*0.34}" ${dot}/>
      <circle cx="${cx+sc*0.28}" cy="${cy+sc*0.30}" r="${sc*0.018}" ${thin}/>
      <line x1="${cx+sc*0.28}" y1="${cy+sc*0.30}" x2="${cx+sc*0.28}" y2="${cy+sc*0.34}" ${dot}/>
      <circle cx="${cx+sc*0.36}" cy="${cy+sc*0.32}" r="${sc*0.015}" ${thin}/>
      <!-- Hair back (flowing) -->
      <path d="M ${cx-sc*0.08},${cy-sc*0.16} Q ${cx-sc*0.14},${cy+sc*0.02} ${cx-sc*0.13},${cy+sc*0.14} Q ${cx-sc*0.12},${cy+sc*0.2} ${cx-sc*0.09},${cy+sc*0.22}" ${style}/>
      <path d="M ${cx+sc*0.08},${cy-sc*0.16} Q ${cx+sc*0.14},${cy+sc*0.02} ${cx+sc*0.13},${cy+sc*0.14} Q ${cx+sc*0.12},${cy+sc*0.2} ${cx+sc*0.09},${cy+sc*0.22}" ${style}/>
      <!-- Wavy hair strands -->
      <path d="M ${cx-sc*0.10},${cy-sc*0.10} Q ${cx-sc*0.16},${cy+sc*0.0} ${cx-sc*0.14},${cy+sc*0.10} Q ${cx-sc*0.11},${cy+sc*0.18} ${cx-sc*0.10},${cy+sc*0.20}" ${thin}/>
      <path d="M ${cx+sc*0.10},${cy-sc*0.10} Q ${cx+sc*0.16},${cy+sc*0.0} ${cx+sc*0.14},${cy+sc*0.10} Q ${cx+sc*0.11},${cy+sc*0.18} ${cx+sc*0.10},${cy+sc*0.20}" ${thin}/>
      <!-- Head -->
      <ellipse cx="${cx}" cy="${cy-sc*0.20}" rx="${sc*0.085}" ry="${sc*0.10}" ${style}/>
      <!-- Hair top -->
      <path d="M ${cx-sc*0.085},${cy-sc*0.22} Q ${cx-sc*0.09},${cy-sc*0.32} ${cx},${cy-sc*0.33} Q ${cx+sc*0.09},${cy-sc*0.32} ${cx+sc*0.085},${cy-sc*0.22}" ${style}/>
      <!-- Bangs -->
      <path d="M ${cx-sc*0.06},${cy-sc*0.26} Q ${cx-sc*0.03},${cy-sc*0.22} ${cx},${cy-sc*0.24} Q ${cx+sc*0.03},${cy-sc*0.22} ${cx+sc*0.06},${cy-sc*0.26}" ${thin}/>
      <!-- Eyes -->
      <ellipse cx="${cx-sc*0.035}" cy="${cy-sc*0.20}" rx="${sc*0.02}" ry="${sc*0.015}" ${style}/>
      <circle cx="${cx-sc*0.03}" cy="${cy-sc*0.20}" r="${sc*0.008}" fill="#4a3728"/>
      <ellipse cx="${cx+sc*0.035}" cy="${cy-sc*0.20}" rx="${sc*0.02}" ry="${sc*0.015}" ${style}/>
      <circle cx="${cx+sc*0.03}" cy="${cy-sc*0.20}" r="${sc*0.008}" fill="#4a3728"/>
      <!-- Eyelashes -->
      <path d="M ${cx-sc*0.055},${cy-sc*0.21} Q ${cx-sc*0.045},${cy-sc*0.225} ${cx-sc*0.035},${cy-sc*0.215}" ${dot}/>
      <path d="M ${cx+sc*0.055},${cy-sc*0.21} Q ${cx+sc*0.045},${cy-sc*0.225} ${cx+sc*0.035},${cy-sc*0.215}" ${dot}/>
      <!-- Smile -->
      <path d="M ${cx-sc*0.025},${cy-sc*0.155} Q ${cx},${cy-sc*0.135} ${cx+sc*0.025},${cy-sc*0.155}" ${thin}/>
      <!-- Nose dot -->
      <circle cx="${cx}" cy="${cy-sc*0.17}" r="${sc*0.005}" fill="#4a3728"/>
      <!-- Cheek blush circles -->
      <circle cx="${cx-sc*0.055}" cy="${cy-sc*0.16}" r="${sc*0.012}" ${dot}/>
      <circle cx="${cx+sc*0.055}" cy="${cy-sc*0.16}" r="${sc*0.012}" ${dot}/>
      <!-- Crown/Tiara -->
      <path d="M ${cx-sc*0.055},${cy-sc*0.295} L ${cx-sc*0.035},${cy-sc*0.34} L ${cx-sc*0.015},${cy-sc*0.305} L ${cx},${cy-sc*0.35} L ${cx+sc*0.015},${cy-sc*0.305} L ${cx+sc*0.035},${cy-sc*0.34} L ${cx+sc*0.055},${cy-sc*0.295}" ${style}/>
      <path d="M ${cx-sc*0.055},${cy-sc*0.295} Q ${cx},${cy-sc*0.285} ${cx+sc*0.055},${cy-sc*0.295}" ${thin}/>
      <circle cx="${cx}" cy="${cy-sc*0.34}" r="${sc*0.008}" ${thin}/>
      <!-- Neck -->
      <line x1="${cx-sc*0.02}" y1="${cy-sc*0.10}" x2="${cx-sc*0.025}" y2="${cy-sc*0.07}" ${thin}/>
      <line x1="${cx+sc*0.02}" y1="${cy-sc*0.10}" x2="${cx+sc*0.025}" y2="${cy-sc*0.07}" ${thin}/>
      <!-- Bodice -->
      <path d="M ${cx-sc*0.06},${cy-sc*0.07} Q ${cx},${cy-sc*0.08} ${cx+sc*0.06},${cy-sc*0.07} L ${cx+sc*0.07},${cy+sc*0.02} Q ${cx},${cy+sc*0.03} ${cx-sc*0.07},${cy+sc*0.02} Z" ${style}/>
      <!-- Neckline detail -->
      <path d="M ${cx-sc*0.045},${cy-sc*0.065} Q ${cx},${cy-sc*0.05} ${cx+sc*0.045},${cy-sc*0.065}" ${thin}/>
      <!-- Arms -->
      <path d="M ${cx-sc*0.06},${cy-sc*0.06} Q ${cx-sc*0.10},${cy-sc*0.02} ${cx-sc*0.12},${cy+sc*0.04} Q ${cx-sc*0.13},${cy+sc*0.07} ${cx-sc*0.11},${cy+sc*0.08}" ${style}/>
      <path d="M ${cx+sc*0.06},${cy-sc*0.06} Q ${cx+sc*0.10},${cy-sc*0.02} ${cx+sc*0.12},${cy+sc*0.04} Q ${cx+sc*0.13},${cy+sc*0.07} ${cx+sc*0.11},${cy+sc*0.08}" ${style}/>
      <!-- Hands (small circles) -->
      <circle cx="${cx-sc*0.115}" cy="${cy+sc*0.085}" r="${sc*0.015}" ${style}/>
      <circle cx="${cx+sc*0.115}" cy="${cy+sc*0.085}" r="${sc*0.015}" ${style}/>
      <!-- Skirt - flowing ball gown -->
      <path d="M ${cx-sc*0.07},${cy+sc*0.02} Q ${cx-sc*0.12},${cy+sc*0.12} ${cx-sc*0.18},${cy+sc*0.24} Q ${cx-sc*0.20},${cy+sc*0.30} ${cx-sc*0.19},${cy+sc*0.34} Q ${cx},${cy+sc*0.37} ${cx+sc*0.19},${cy+sc*0.34} Q ${cx+sc*0.20},${cy+sc*0.30} ${cx+sc*0.18},${cy+sc*0.24} Q ${cx+sc*0.12},${cy+sc*0.12} ${cx+sc*0.07},${cy+sc*0.02}" ${style}/>
      <!-- Skirt folds -->
      <path d="M ${cx-sc*0.04},${cy+sc*0.04} Q ${cx-sc*0.06},${cy+sc*0.18} ${cx-sc*0.10},${cy+sc*0.32}" ${thin} stroke-dasharray="${sc*0.01} ${sc*0.015}"/>
      <path d="M ${cx},${cy+sc*0.03} Q ${cx},${cy+sc*0.18} ${cx},${cy+sc*0.35}" ${dot}/>
      <path d="M ${cx+sc*0.04},${cy+sc*0.04} Q ${cx+sc*0.06},${cy+sc*0.18} ${cx+sc*0.10},${cy+sc*0.32}" ${thin} stroke-dasharray="${sc*0.01} ${sc*0.015}"/>
      <!-- Skirt scallop hem -->
      <path d="M ${cx-sc*0.19},${cy+sc*0.34} Q ${cx-sc*0.16},${cy+sc*0.36} ${cx-sc*0.13},${cy+sc*0.345} Q ${cx-sc*0.10},${cy+sc*0.36} ${cx-sc*0.07},${cy+sc*0.35} Q ${cx-sc*0.035},${cy+sc*0.37} ${cx},${cy+sc*0.355} Q ${cx+sc*0.035},${cy+sc*0.37} ${cx+sc*0.07},${cy+sc*0.35} Q ${cx+sc*0.10},${cy+sc*0.36} ${cx+sc*0.13},${cy+sc*0.345} Q ${cx+sc*0.16},${cy+sc*0.36} ${cx+sc*0.19},${cy+sc*0.34}" ${thin}/>
      <!-- Gem on bodice -->
      <path d="M ${cx},${cy-sc*0.01} L ${cx-sc*0.012},${cy+sc*0.0} L ${cx},${cy+sc*0.015} L ${cx+sc*0.012},${cy+sc*0.0} Z" ${thin}/>
      <!-- Stars around -->
      <path d="M ${cx-sc*0.28},${cy-sc*0.24} l ${sc*0.01},${sc*0.025} l ${sc*0.025},${sc*0.005} l ${-sc*0.02},${sc*0.015} l ${sc*0.005},${sc*0.025} l ${-sc*0.02},-${sc*0.015} l ${-sc*0.02},${sc*0.015} l ${sc*0.005},-${sc*0.025} l ${-sc*0.02},-${sc*0.015} l ${sc*0.025},-${sc*0.005} Z" ${thin}/>
      <path d="M ${cx+sc*0.26},${cy-sc*0.18} l ${sc*0.008},${sc*0.02} l ${sc*0.02},${sc*0.004} l ${-sc*0.016},${sc*0.012} l ${sc*0.004},${sc*0.02} l ${-sc*0.016},-${sc*0.012} l ${-sc*0.016},${sc*0.012} l ${sc*0.004},-${sc*0.02} l ${-sc*0.016},-${sc*0.012} l ${sc*0.02},-${sc*0.004} Z" ${thin}/>
      <path d="M ${cx+sc*0.30},${cy+sc*0.10} l ${sc*0.006},${sc*0.015} l ${sc*0.015},${sc*0.003} l ${-sc*0.012},${sc*0.009} l ${sc*0.003},${sc*0.015} l ${-sc*0.012},-${sc*0.009} l ${-sc*0.012},${sc*0.009} l ${sc*0.003},-${sc*0.015} l ${-sc*0.012},-${sc*0.009} l ${sc*0.015},-${sc*0.003} Z" ${thin}/>
    </svg>`;

    case 1: return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${vb}" width="${w}" height="${h}">
      <!-- Fairy Tale Castle -->
      <!-- Ground / Hill -->
      <path d="M 0,${cy+sc*0.28} Q ${w*0.2},${cy+sc*0.22} ${w*0.5},${cy+sc*0.20} Q ${w*0.8},${cy+sc*0.22} ${w},${cy+sc*0.28}" ${style}/>
      <line x1="0" y1="${cy+sc*0.28}" x2="0" y2="${h}" ${dot}/>
      <line x1="${w}" y1="${cy+sc*0.28}" x2="${w}" y2="${h}" ${dot}/>
      <!-- Grass tufts -->
      <path d="M ${cx-sc*0.30},${cy+sc*0.265} Q ${cx-sc*0.295},${cy+sc*0.245} ${cx-sc*0.29},${cy+sc*0.265}" ${dot}/>
      <path d="M ${cx+sc*0.26},${cy+sc*0.24} Q ${cx+sc*0.265},${cy+sc*0.22} ${cx+sc*0.27},${cy+sc*0.24}" ${dot}/>
      <!-- Left tower -->
      <rect x="${cx-sc*0.22}" y="${cy-sc*0.15}" width="${sc*0.08}" height="${sc*0.35}" rx="${sc*0.005}" ${style}/>
      <path d="M ${cx-sc*0.23},${cy-sc*0.15} L ${cx-sc*0.18},${cy-sc*0.26} L ${cx-sc*0.13},${cy-sc*0.15}" ${style}/>
      <!-- Left tower window -->
      <path d="M ${cx-sc*0.19},${cy-sc*0.04} Q ${cx-sc*0.18},${cy-sc*0.065} ${cx-sc*0.17},${cy-sc*0.04} L ${cx-sc*0.17},${cy+sc*0.0} L ${cx-sc*0.19},${cy+sc*0.0} Z" ${thin}/>
      <line x1="${cx-sc*0.18}" y1="${cy-sc*0.065}" x2="${cx-sc*0.18}" y2="${cy+sc*0.0}" ${dot}/>
      <!-- Left battlement -->
      <path d="M ${cx-sc*0.225},${cy-sc*0.15} v ${-sc*0.015} h ${sc*0.015} v ${sc*0.015} h ${sc*0.012} v ${-sc*0.015} h ${sc*0.015} v ${sc*0.015} h ${sc*0.012} v ${-sc*0.015} h ${sc*0.015} v ${sc*0.015}" ${thin}/>
      <!-- Right tower -->
      <rect x="${cx+sc*0.14}" y="${cy-sc*0.15}" width="${sc*0.08}" height="${sc*0.35}" rx="${sc*0.005}" ${style}/>
      <path d="M ${cx+sc*0.13},${cy-sc*0.15} L ${cx+sc*0.18},${cy-sc*0.26} L ${cx+sc*0.23},${cy-sc*0.15}" ${style}/>
      <!-- Right tower window -->
      <path d="M ${cx+sc*0.17},${cy-sc*0.04} Q ${cx+sc*0.18},${cy-sc*0.065} ${cx+sc*0.19},${cy-sc*0.04} L ${cx+sc*0.19},${cy+sc*0.0} L ${cx+sc*0.17},${cy+sc*0.0} Z" ${thin}/>
      <line x1="${cx+sc*0.18}" y1="${cy-sc*0.065}" x2="${cx+sc*0.18}" y2="${cy+sc*0.0}" ${dot}/>
      <!-- Right battlement -->
      <path d="M ${cx+sc*0.135},${cy-sc*0.15} v ${-sc*0.015} h ${sc*0.015} v ${sc*0.015} h ${sc*0.012} v ${-sc*0.015} h ${sc*0.015} v ${sc*0.015} h ${sc*0.012} v ${-sc*0.015} h ${sc*0.015} v ${sc*0.015}" ${thin}/>
      <!-- Main wall -->
      <rect x="${cx-sc*0.14}" y="${cy-sc*0.06}" width="${sc*0.28}" height="${sc*0.26}" rx="${sc*0.005}" ${style}/>
      <!-- Center tower (tallest) -->
      <rect x="${cx-sc*0.06}" y="${cy-sc*0.22}" width="${sc*0.12}" height="${sc*0.16}" rx="${sc*0.005}" ${style}/>
      <path d="M ${cx-sc*0.07},${cy-sc*0.22} L ${cx},${cy-sc*0.35} L ${cx+sc*0.07},${cy-sc*0.22}" ${style}/>
      <!-- Center tower window (round) -->
      <circle cx="${cx}" cy="${cy-sc*0.15}" r="${sc*0.022}" ${style}/>
      <line x1="${cx}" y1="${cy-sc*0.172}" x2="${cx}" y2="${cy-sc*0.128}" ${dot}/>
      <line x1="${cx-sc*0.022}" y1="${cy-sc*0.15}" x2="${cx+sc*0.022}" y2="${cy-sc*0.15}" ${dot}/>
      <!-- Flag on top -->
      <line x1="${cx}" y1="${cy-sc*0.35}" x2="${cx}" y2="${cy-sc*0.40}" ${style}/>
      <path d="M ${cx},${cy-sc*0.40} Q ${cx+sc*0.03},${cy-sc*0.385} ${cx+sc*0.04},${cy-sc*0.375} Q ${cx+sc*0.03},${cy-sc*0.365} ${cx},${cy-sc*0.36}" ${style}/>
      <!-- Main door (arched) -->
      <path d="M ${cx-sc*0.03},${cy+sc*0.20} L ${cx-sc*0.03},${cy+sc*0.12} Q ${cx-sc*0.03},${cy+sc*0.08} ${cx},${cy+sc*0.08} Q ${cx+sc*0.03},${cy+sc*0.08} ${cx+sc*0.03},${cy+sc*0.12} L ${cx+sc*0.03},${cy+sc*0.20}" ${style}/>
      <circle cx="${cx+sc*0.015}" cy="${cy+sc*0.14}" r="${sc*0.005}" fill="#4a3728"/>
      <!-- Main wall windows -->
      <path d="M ${cx-sc*0.10},${cy+sc*0.02} Q ${cx-sc*0.09},${cy-sc*0.005} ${cx-sc*0.08},${cy+sc*0.02} L ${cx-sc*0.08},${cy+sc*0.06} L ${cx-sc*0.10},${cy+sc*0.06} Z" ${thin}/>
      <path d="M ${cx+sc*0.08},${cy+sc*0.02} Q ${cx+sc*0.09},${cy-sc*0.005} ${cx+sc*0.10},${cy+sc*0.02} L ${cx+sc*0.10},${cy+sc*0.06} L ${cx+sc*0.08},${cy+sc*0.06} Z" ${thin}/>
      <!-- Clouds -->
      <path d="M ${cx-sc*0.32},${cy-sc*0.30} Q ${cx-sc*0.30},${cy-sc*0.34} ${cx-sc*0.26},${cy-sc*0.34} Q ${cx-sc*0.24},${cy-sc*0.37} ${cx-sc*0.20},${cy-sc*0.35} Q ${cx-sc*0.18},${cy-sc*0.30} ${cx-sc*0.22},${cy-sc*0.29} Q ${cx-sc*0.26},${cy-sc*0.28} ${cx-sc*0.32},${cy-sc*0.30}" ${thin}/>
      <path d="M ${cx+sc*0.18},${cy-sc*0.33} Q ${cx+sc*0.21},${cy-sc*0.37} ${cx+sc*0.26},${cy-sc*0.36} Q ${cx+sc*0.29},${cy-sc*0.38} ${cx+sc*0.32},${cy-sc*0.35} Q ${cx+sc*0.34},${cy-sc*0.31} ${cx+sc*0.30},${cy-sc*0.30} Q ${cx+sc*0.24},${cy-sc*0.30} ${cx+sc*0.18},${cy-sc*0.33}" ${thin}/>
      <!-- Sun -->
      <circle cx="${cx+sc*0.34}" cy="${cy-sc*0.28}" r="${sc*0.03}" ${thin}/>
      <line x1="${cx+sc*0.34}" y1="${cy-sc*0.33}" x2="${cx+sc*0.34}" y2="${cy-sc*0.35}" ${dot}/>
      <line x1="${cx+sc*0.34}" y1="${cy-sc*0.23}" x2="${cx+sc*0.34}" y2="${cy-sc*0.21}" ${dot}/>
      <line x1="${cx+sc*0.29}" y1="${cy-sc*0.28}" x2="${cx+sc*0.27}" y2="${cy-sc*0.28}" ${dot}/>
      <line x1="${cx+sc*0.39}" y1="${cy-sc*0.28}" x2="${cx+sc*0.41}" y2="${cy-sc*0.28}" ${dot}/>
      <!-- Path to castle -->
      <path d="M ${cx-sc*0.04},${cy+sc*0.20} Q ${cx-sc*0.06},${cy+sc*0.25} ${cx-sc*0.08},${cy+sc*0.28}" ${dot}/>
      <path d="M ${cx+sc*0.04},${cy+sc*0.20} Q ${cx+sc*0.06},${cy+sc*0.25} ${cx+sc*0.08},${cy+sc*0.28}" ${dot}/>
    </svg>`;

    case 2: return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${vb}" width="${w}" height="${h}">
      <!-- Mermaid Underwater -->
      <!-- Wavy water lines -->
      <path d="M 0,${cy-sc*0.36} Q ${w*0.15},${cy-sc*0.38} ${w*0.3},${cy-sc*0.36} Q ${w*0.5},${cy-sc*0.34} ${w*0.7},${cy-sc*0.36} Q ${w*0.85},${cy-sc*0.38} ${w},${cy-sc*0.36}" ${dot}/>
      <path d="M 0,${cy-sc*0.32} Q ${w*0.2},${cy-sc*0.34} ${w*0.4},${cy-sc*0.32} Q ${w*0.6},${cy-sc*0.30} ${w*0.8},${cy-sc*0.32} Q ${w*0.9},${cy-sc*0.34} ${w},${cy-sc*0.32}" ${dot}/>
      <!-- Bubbles -->
      <circle cx="${cx-sc*0.25}" cy="${cy-sc*0.22}" r="${sc*0.015}" ${dot}/>
      <circle cx="${cx-sc*0.22}" cy="${cy-sc*0.28}" r="${sc*0.010}" ${dot}/>
      <circle cx="${cx+sc*0.28}" cy="${cy-sc*0.18}" r="${sc*0.012}" ${dot}/>
      <circle cx="${cx+sc*0.32}" cy="${cy-sc*0.26}" r="${sc*0.008}" ${dot}/>
      <!-- Sand floor -->
      <path d="M 0,${cy+sc*0.30} Q ${w*0.3},${cy+sc*0.32} ${w*0.5},${cy+sc*0.30} Q ${w*0.7},${cy+sc*0.33} ${w},${cy+sc*0.30}" ${thin}/>
      <!-- Seaweed left -->
      <path d="M ${cx-sc*0.30},${cy+sc*0.30} Q ${cx-sc*0.33},${cy+sc*0.18} ${cx-sc*0.28},${cy+sc*0.10} Q ${cx-sc*0.32},${cy+sc*0.02} ${cx-sc*0.29},${cy-sc*0.05}" ${thin}/>
      <path d="M ${cx-sc*0.28},${cy+sc*0.30} Q ${cx-sc*0.25},${cy+sc*0.20} ${cx-sc*0.27},${cy+sc*0.12}" ${dot}/>
      <!-- Seaweed right -->
      <path d="M ${cx+sc*0.28},${cy+sc*0.31} Q ${cx+sc*0.31},${cy+sc*0.20} ${cx+sc*0.27},${cy+sc*0.12} Q ${cx+sc*0.30},${cy+sc*0.05} ${cx+sc*0.27},${cy-sc*0.02}" ${thin}/>
      <!-- Coral left -->
      <path d="M ${cx-sc*0.35},${cy+sc*0.31} Q ${cx-sc*0.37},${cy+sc*0.24} ${cx-sc*0.34},${cy+sc*0.20}" ${thin}/>
      <path d="M ${cx-sc*0.34},${cy+sc*0.31} Q ${cx-sc*0.32},${cy+sc*0.25} ${cx-sc*0.35},${cy+sc*0.22}" ${dot}/>
      <!-- Starfish on sand -->
      <path d="M ${cx+sc*0.22},${cy+sc*0.30} l ${sc*0.008},${-sc*0.02} l ${sc*0.01},${sc*0.018} l ${-sc*0.016},${-sc*0.008} l ${sc*0.018},${sc*0.002} l ${-sc*0.014},${sc*0.012}" ${dot}/>
      <!-- Hair flowing -->
      <path d="M ${cx-sc*0.07},${cy-sc*0.16} Q ${cx-sc*0.14},${cy-sc*0.08} ${cx-sc*0.16},${cy+sc*0.04} Q ${cx-sc*0.17},${cy+sc*0.12} ${cx-sc*0.14},${cy+sc*0.16}" ${style}/>
      <path d="M ${cx+sc*0.07},${cy-sc*0.16} Q ${cx+sc*0.14},${cy-sc*0.06} ${cx+sc*0.15},${cy+sc*0.06} Q ${cx+sc*0.14},${cy+sc*0.14} ${cx+sc*0.11},${cy+sc*0.18}" ${style}/>
      <path d="M ${cx-sc*0.09},${cy-sc*0.12} Q ${cx-sc*0.15},${cy-sc*0.02} ${cx-sc*0.15},${cy+sc*0.08}" ${thin}/>
      <path d="M ${cx+sc*0.09},${cy-sc*0.12} Q ${cx+sc*0.16},${cy-sc*0.0} ${cx+sc*0.14},${cy+sc*0.10}" ${thin}/>
      <!-- Head -->
      <ellipse cx="${cx}" cy="${cy-sc*0.18}" rx="${sc*0.08}" ry="${sc*0.095}" ${style}/>
      <!-- Hair top -->
      <path d="M ${cx-sc*0.08},${cy-sc*0.20} Q ${cx-sc*0.085},${cy-sc*0.30} ${cx},${cy-sc*0.31} Q ${cx+sc*0.085},${cy-sc*0.30} ${cx+sc*0.08},${cy-sc*0.20}" ${style}/>
      <!-- Eyes -->
      <ellipse cx="${cx-sc*0.03}" cy="${cy-sc*0.185}" rx="${sc*0.018}" ry="${sc*0.013}" ${style}/>
      <circle cx="${cx-sc*0.026}" cy="${cy-sc*0.185}" r="${sc*0.007}" fill="#4a3728"/>
      <ellipse cx="${cx+sc*0.03}" cy="${cy-sc*0.185}" rx="${sc*0.018}" ry="${sc*0.013}" ${style}/>
      <circle cx="${cx+sc*0.026}" cy="${cy-sc*0.185}" r="${sc*0.007}" fill="#4a3728"/>
      <!-- Smile -->
      <path d="M ${cx-sc*0.02},${cy-sc*0.145} Q ${cx},${cy-sc*0.125} ${cx+sc*0.02},${cy-sc*0.145}" ${thin}/>
      <!-- Shell crown -->
      <path d="M ${cx-sc*0.04},${cy-sc*0.27} Q ${cx-sc*0.02},${cy-sc*0.30} ${cx},${cy-sc*0.29} Q ${cx+sc*0.02},${cy-sc*0.30} ${cx+sc*0.04},${cy-sc*0.27}" ${thin}/>
      <!-- Body/torso -->
      <path d="M ${cx-sc*0.05},${cy-sc*0.08} Q ${cx},${cy-sc*0.09} ${cx+sc*0.05},${cy-sc*0.08} L ${cx+sc*0.04},${cy+sc*0.03} Q ${cx},${cy+sc*0.04} ${cx-sc*0.04},${cy+sc*0.03} Z" ${style}/>
      <!-- Shell bra detail -->
      <path d="M ${cx-sc*0.04},${cy-sc*0.06} Q ${cx-sc*0.025},${cy-sc*0.08} ${cx-sc*0.01},${cy-sc*0.06}" ${thin}/>
      <path d="M ${cx+sc*0.01},${cy-sc*0.06} Q ${cx+sc*0.025},${cy-sc*0.08} ${cx+sc*0.04},${cy-sc*0.06}" ${thin}/>
      <!-- Tail -->
      <path d="M ${cx-sc*0.04},${cy+sc*0.02} Q ${cx-sc*0.06},${cy+sc*0.10} ${cx-sc*0.04},${cy+sc*0.18} Q ${cx-sc*0.02},${cy+sc*0.24} ${cx},${cy+sc*0.26} Q ${cx+sc*0.02},${cy+sc*0.24} ${cx+sc*0.04},${cy+sc*0.18} Q ${cx+sc*0.06},${cy+sc*0.10} ${cx+sc*0.04},${cy+sc*0.02}" ${style}/>
      <!-- Tail scales pattern -->
      <path d="M ${cx-sc*0.035},${cy+sc*0.08} Q ${cx},${cy+sc*0.10} ${cx+sc*0.035},${cy+sc*0.08}" ${dot}/>
      <path d="M ${cx-sc*0.03},${cy+sc*0.14} Q ${cx},${cy+sc*0.16} ${cx+sc*0.03},${cy+sc*0.14}" ${dot}/>
      <path d="M ${cx-sc*0.02},${cy+sc*0.20} Q ${cx},${cy+sc*0.22} ${cx+sc*0.02},${cy+sc*0.20}" ${dot}/>
      <!-- Fin -->
      <path d="M ${cx},${cy+sc*0.25} Q ${cx-sc*0.06},${cy+sc*0.30} ${cx-sc*0.07},${cy+sc*0.34} Q ${cx-sc*0.03},${cy+sc*0.31} ${cx},${cy+sc*0.28}" ${style}/>
      <path d="M ${cx},${cy+sc*0.25} Q ${cx+sc*0.06},${cy+sc*0.30} ${cx+sc*0.07},${cy+sc*0.34} Q ${cx+sc*0.03},${cy+sc*0.31} ${cx},${cy+sc*0.28}" ${style}/>
      <!-- Arms -->
      <path d="M ${cx-sc*0.05},${cy-sc*0.06} Q ${cx-sc*0.09},${cy-sc*0.02} ${cx-sc*0.10},${cy+sc*0.04}" ${style}/>
      <path d="M ${cx+sc*0.05},${cy-sc*0.06} Q ${cx+sc*0.09},${cy-sc*0.02} ${cx+sc*0.10},${cy+sc*0.04}" ${style}/>
      <!-- Small fish -->
      <ellipse cx="${cx+sc*0.24}" cy="${cy+sc*0.05}" rx="${sc*0.025}" ry="${sc*0.012}" ${thin}/>
      <path d="M ${cx+sc*0.265},${cy+sc*0.05} L ${cx+sc*0.28},${cy+sc*0.035} L ${cx+sc*0.28},${cy+sc*0.065} Z" ${thin}/>
      <circle cx="${cx+sc*0.23}" cy="${cy+sc*0.047}" r="${sc*0.003}" fill="#4a3728"/>
    </svg>`;

    case 3: return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${vb}" width="${w}" height="${h}">
      <!-- Unicorn in Meadow -->
      <!-- Ground -->
      <path d="M 0,${cy+sc*0.22} Q ${w*0.25},${cy+sc*0.20} ${w*0.5},${cy+sc*0.22} Q ${w*0.75},${cy+sc*0.24} ${w},${cy+sc*0.22}" ${thin}/>
      <!-- Flowers -->
      <circle cx="${cx-sc*0.28}" cy="${cy+sc*0.19}" r="${sc*0.015}" ${dot}/><line x1="${cx-sc*0.28}" y1="${cy+sc*0.19}" x2="${cx-sc*0.28}" y2="${cy+sc*0.22}" ${dot}/>
      <circle cx="${cx+sc*0.30}" cy="${cy+sc*0.21}" r="${sc*0.012}" ${dot}/><line x1="${cx+sc*0.30}" y1="${cy+sc*0.21}" x2="${cx+sc*0.30}" y2="${cy+sc*0.24}" ${dot}/>
      <circle cx="${cx-sc*0.12}" cy="${cy+sc*0.20}" r="${sc*0.013}" ${dot}/><line x1="${cx-sc*0.12}" y1="${cy+sc*0.20}" x2="${cx-sc*0.12}" y2="${cy+sc*0.23}" ${dot}/>
      <!-- Body (rounded, soft) -->
      <ellipse cx="${cx}" cy="${cy+sc*0.02}" rx="${sc*0.16}" ry="${sc*0.10}" ${style}/>
      <!-- Legs -->
      <path d="M ${cx-sc*0.10},${cy+sc*0.10} L ${cx-sc*0.10},${cy+sc*0.22}" ${style}/>
      <path d="M ${cx-sc*0.05},${cy+sc*0.10} L ${cx-sc*0.05},${cy+sc*0.22}" ${style}/>
      <path d="M ${cx+sc*0.05},${cy+sc*0.10} L ${cx+sc*0.05},${cy+sc*0.22}" ${style}/>
      <path d="M ${cx+sc*0.10},${cy+sc*0.10} L ${cx+sc*0.10},${cy+sc*0.22}" ${style}/>
      <!-- Hooves -->
      <ellipse cx="${cx-sc*0.10}" cy="${cy+sc*0.22}" rx="${sc*0.012}" ry="${sc*0.006}" ${thin}/>
      <ellipse cx="${cx-sc*0.05}" cy="${cy+sc*0.22}" rx="${sc*0.012}" ry="${sc*0.006}" ${thin}/>
      <ellipse cx="${cx+sc*0.05}" cy="${cy+sc*0.22}" rx="${sc*0.012}" ry="${sc*0.006}" ${thin}/>
      <ellipse cx="${cx+sc*0.10}" cy="${cy+sc*0.22}" rx="${sc*0.012}" ry="${sc*0.006}" ${thin}/>
      <!-- Neck -->
      <path d="M ${cx+sc*0.10},${cy-sc*0.04} Q ${cx+sc*0.14},${cy-sc*0.12} ${cx+sc*0.16},${cy-sc*0.18}" ${style}/>
      <path d="M ${cx+sc*0.14},${cy-sc*0.02} Q ${cx+sc*0.18},${cy-sc*0.10} ${cx+sc*0.20},${cy-sc*0.16}" ${style}/>
      <!-- Head -->
      <path d="M ${cx+sc*0.16},${cy-sc*0.18} Q ${cx+sc*0.18},${cy-sc*0.24} ${cx+sc*0.22},${cy-sc*0.22} Q ${cx+sc*0.27},${cy-sc*0.20} ${cx+sc*0.27},${cy-sc*0.16} Q ${cx+sc*0.26},${cy-sc*0.12} ${cx+sc*0.22},${cy-sc*0.12} Q ${cx+sc*0.18},${cy-sc*0.13} ${cx+sc*0.16},${cy-sc*0.16} Z" ${style}/>
      <!-- Eye -->
      <ellipse cx="${cx+sc*0.225}" cy="${cy-sc*0.17}" rx="${sc*0.012}" ry="${sc*0.010}" ${style}/>
      <circle cx="${cx+sc*0.222}" cy="${cy-sc*0.17}" r="${sc*0.005}" fill="#4a3728"/>
      <!-- Nostril -->
      <circle cx="${cx+sc*0.26}" cy="${cy-sc*0.135}" r="${sc*0.004}" fill="#4a3728"/>
      <!-- Ear -->
      <path d="M ${cx+sc*0.19},${cy-sc*0.22} Q ${cx+sc*0.195},${cy-sc*0.27} ${cx+sc*0.21},${cy-sc*0.24}" ${thin}/>
      <!-- Horn (spiral) -->
      <path d="M ${cx+sc*0.20},${cy-sc*0.24} L ${cx+sc*0.215},${cy-sc*0.34}" ${style}/>
      <path d="M ${cx+sc*0.205},${cy-sc*0.27} L ${cx+sc*0.215},${cy-sc*0.265}" ${dot}/>
      <path d="M ${cx+sc*0.208},${cy-sc*0.29} L ${cx+sc*0.218},${cy-sc*0.285}" ${dot}/>
      <path d="M ${cx+sc*0.210},${cy-sc*0.31} L ${cx+sc*0.220},${cy-sc*0.305}" ${dot}/>
      <!-- Mane (flowing curves) -->
      <path d="M ${cx+sc*0.18},${cy-sc*0.22} Q ${cx+sc*0.12},${cy-sc*0.20} ${cx+sc*0.14},${cy-sc*0.15} Q ${cx+sc*0.10},${cy-sc*0.14} ${cx+sc*0.12},${cy-sc*0.09} Q ${cx+sc*0.08},${cy-sc*0.08} ${cx+sc*0.10},${cy-sc*0.03}" ${style}/>
      <path d="M ${cx+sc*0.17},${cy-sc*0.20} Q ${cx+sc*0.13},${cy-sc*0.18} ${cx+sc*0.13},${cy-sc*0.13} Q ${cx+sc*0.09},${cy-sc*0.11} ${cx+sc*0.11},${cy-sc*0.06}" ${thin}/>
      <!-- Tail (flowing) -->
      <path d="M ${cx-sc*0.15},${cy-sc*0.02} Q ${cx-sc*0.22},${cy-sc*0.06} ${cx-sc*0.24},${cy+sc*0.0} Q ${cx-sc*0.26},${cy+sc*0.06} ${cx-sc*0.22},${cy+sc*0.10} Q ${cx-sc*0.25},${cy+sc*0.14} ${cx-sc*0.21},${cy+sc*0.16}" ${style}/>
      <path d="M ${cx-sc*0.15},${cy+sc*0.0} Q ${cx-sc*0.21},${cy-sc*0.02} ${cx-sc*0.23},${cy+sc*0.04} Q ${cx-sc*0.24},${cy+sc*0.10} ${cx-sc*0.20},${cy+sc*0.14}" ${thin}/>
      <!-- Stars -->
      <path d="M ${cx-sc*0.24},${cy-sc*0.20} l ${sc*0.008},${sc*0.02} l ${sc*0.02},${sc*0.004} l ${-sc*0.016},${sc*0.012} l ${sc*0.004},${sc*0.02} l ${-sc*0.016},-${sc*0.012} l ${-sc*0.016},${sc*0.012} l ${sc*0.004},-${sc*0.02} l ${-sc*0.016},-${sc*0.012} l ${sc*0.02},-${sc*0.004} Z" ${thin}/>
      <path d="M ${cx+sc*0.30},${cy-sc*0.24} l ${sc*0.006},${sc*0.015} l ${sc*0.015},${sc*0.003} l ${-sc*0.012},${sc*0.009} l ${sc*0.003},${sc*0.015} l ${-sc*0.012},-${sc*0.009} l ${-sc*0.012},${sc*0.009} l ${sc*0.003},-${sc*0.015} l ${-sc*0.012},-${sc*0.009} l ${sc*0.015},-${sc*0.003} Z" ${thin}/>
      <!-- Rainbow arc -->
      <path d="M ${cx-sc*0.34},${cy-sc*0.14} Q ${cx-sc*0.10},${cy-sc*0.38} ${cx+sc*0.34},${cy-sc*0.14}" ${dot}/>
      <path d="M ${cx-sc*0.32},${cy-sc*0.14} Q ${cx-sc*0.08},${cy-sc*0.36} ${cx+sc*0.32},${cy-sc*0.14}" ${dot}/>
    </svg>`;

    default: return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${vb}" width="${w}" height="${h}"></svg>`;
  }
}

function initColoring() {
  const pgs = document.getElementById('col-pages');
  pgs.innerHTML = coloringPages.map((p,i) =>
    `<div class="col-pg ${i===colPageIdx?'act':''} ${p.locked?'lck':''}" onclick="${p.locked?`showToast('Earn ‚≠ê to unlock!')`:` selectColPage(${i})`}">${p.icon}</div>`
  ).join('');

  const pal = document.getElementById('col-palette');
  pal.innerHTML = COLORS.map((c,i) =>
    `<div class="col-swatch ${c===colColor?'act':''}" style="background:${c}${c==='#ffffff'?';border-color:#ddd':''}" onclick="selectColor('${c}',${i},this)" title="${COLOR_NAMES[i]}"></div>`
  ).join('');

  const tools = document.getElementById('col-tools');
  tools.innerHTML = `
    <div class="col-tool ${colTool==='fill'?'act':''}" onclick="selectColTool('fill',this)"><span class="tool-icon">üé®</span>Fill</div>
    <div class="col-tool ${colTool==='sparkle'?'act':''}" onclick="selectColTool('sparkle',this)"><span class="tool-icon">‚ú®</span>Sparkle</div>
    <div class="col-tool ${colTool==='rainbow'?'act':''}" onclick="selectColTool('rainbow',this)"><span class="tool-icon">üåà</span>Rainbow</div>
    <div class="col-tool ${colTool==='eraser'?'act':''}" onclick="selectColTool('eraser',this)"><span class="tool-icon">üí´</span>Undo All</div>
  `;

  setupColoringCanvas();
  loadColoringPage(colPageIdx);
}

function setupColoringCanvas() {
  const c = document.getElementById('coloring-canvas');
  const wrap = document.getElementById('col-canvas-inner');
  const dpr = window.devicePixelRatio || 1;
  const w = wrap.clientWidth;
  const h = wrap.clientHeight;
  c.width = w * dpr;
  c.height = h * dpr;
  c.style.width = w + 'px';
  c.style.height = h + 'px';
  colCanvasW = w;
  colCanvasH = h;

  c.onpointerdown = (e) => {
    e.preventDefault();
    const rect = c.getBoundingClientRect();
    const x = (e.clientX - rect.left);
    const y = (e.clientY - rect.top);
    handleColoringTap(x, y);
  };
}

function loadColoringPage(idx) {
  const c = document.getElementById('coloring-canvas');
  const ctx2 = c.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const w = colCanvasW, h = colCanvasH;

  // Clear to white
  ctx2.setTransform(1, 0, 0, 1, 0, 0);
  ctx2.fillStyle = '#ffffff';
  ctx2.fillRect(0, 0, c.width, c.height);

  // Render SVG to canvas via Image + blob
  const svgStr = getPageSVG(idx, c.width, c.height);
  const blob = new Blob([svgStr], {type: 'image/svg+xml;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const img = new Image();
  img.onload = () => {
    ctx2.drawImage(img, 0, 0);
    URL.revokeObjectURL(url);
    // Store outline for re-compositing after fills
    outlineImg = ctx2.getImageData(0, 0, c.width, c.height);
  };
  img.onerror = () => {
    URL.revokeObjectURL(url);
    // Fallback: try encoding as data URL
    const encoded = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgStr)));
    const img2 = new Image();
    img2.onload = () => {
      ctx2.drawImage(img2, 0, 0);
      outlineImg = ctx2.getImageData(0, 0, c.width, c.height);
    };
    img2.src = encoded;
  };
  img.src = url;
}

function selectColPage(i) {
  colPageIdx = i;
  document.querySelectorAll('.col-pg').forEach((p,j) => p.classList.toggle('act', j===i));
  loadColoringPage(i);
  playChime();
}

function selectColor(c, i, el) {
  colColor = c;
  document.querySelectorAll('.col-swatch').forEach(s => s.classList.remove('act'));
  el.classList.add('act');
  showToast(COLOR_NAMES[i] + '! üé®');
  playChime();
}

function selectColTool(t, el) {
  colTool = t;
  document.querySelectorAll('.col-tool').forEach(x => x.classList.remove('act'));
  el.classList.add('act');
  if (t === 'eraser') {
    // Reload the page (clears all coloring)
    loadColoringPage(colPageIdx);
    showToast('All clean! üí´');
  }
  playChime();
}

function handleColoringTap(x, y) {
  const c = document.getElementById('coloring-canvas');
  const ctx2 = c.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const px = Math.round(x * dpr);
  const py = Math.round(y * dpr);

  if (colTool === 'sparkle') {
    // Draw sparkles at tap point
    drawSparklesAt(ctx2, px, py, dpr);
    const rect = c.getBoundingClientRect();
    burst(rect.left + x, rect.top + y, 10);
    playChime();
    return;
  }

  if (colTool === 'eraser') return; // handled in selectColTool

  // Flood fill
  let fillColor;
  if (colTool === 'rainbow') {
    const rainbow = ['#ef5350','#ff9800','#ffd54f','#66bb6a','#42a5f5','#7b1fa2','#f48fb1'];
    fillColor = rainbow[Math.floor(Math.random() * rainbow.length)];
  } else {
    fillColor = colColor;
  }

  floodFill(ctx2, c.width, c.height, px, py, fillColor);

  // Re-draw outlines on top so they don't get covered
  if (outlineImg) {
    const currentData = ctx2.getImageData(0, 0, c.width, c.height);
    const cd = currentData.data;
    const od = outlineImg.data;
    for (let i = 0; i < od.length; i += 4) {
      // If the outline pixel is dark (part of the drawing), overlay it
      if (od[i] < 110 && od[i+1] < 90 && od[i+2] < 80 && od[i+3] > 80) {
        cd[i] = od[i];
        cd[i+1] = od[i+1];
        cd[i+2] = od[i+2];
        cd[i+3] = od[i+3];
      }
    }
    ctx2.putImageData(currentData, 0, 0);
  }

  const rect = c.getBoundingClientRect();
  burst(rect.left + x, rect.top + y, 12);
  playChime();
}

function floodFill(ctx2, width, height, startX, startY, fillColorHex) {
  const imageData = ctx2.getImageData(0, 0, width, height);
  const data = imageData.data;
  const fc = hexToRgb(fillColorHex);
  if (!fc) return;

  // Bounds check
  if (startX < 0 || startX >= width || startY < 0 || startY >= height) return;

  const startIdx = (startY * width + startX) * 4;
  const tr = data[startIdx], tg = data[startIdx+1], tb = data[startIdx+2], ta = data[startIdx+3];

  // Don't fill if clicking on an outline (dark pixel)
  if (tr < 110 && tg < 90 && tb < 80 && ta > 80) return;

  // Don't fill if target is same as fill color (within tolerance)
  if (Math.abs(tr - fc.r) < 8 && Math.abs(tg - fc.g) < 8 && Math.abs(tb - fc.b) < 8) return;

  const tolerance = 48; // higher tolerance for anti-aliased SVG edges

  function matches(idx) {
    if (idx < 0 || idx >= data.length) return false;
    // Don't cross dark outline pixels
    if (data[idx] < 110 && data[idx+1] < 90 && data[idx+2] < 80 && data[idx+3] > 80) return false;
    return Math.abs(data[idx] - tr) <= tolerance &&
           Math.abs(data[idx+1] - tg) <= tolerance &&
           Math.abs(data[idx+2] - tb) <= tolerance;
  }

  function setPixel(idx) {
    data[idx] = fc.r;
    data[idx+1] = fc.g;
    data[idx+2] = fc.b;
    data[idx+3] = 255;
  }

  // Scanline flood fill ‚Äî much faster than stack-based
  const visited = new Uint8Array(width * height);
  const queue = [{x: startX, y: startY}];
  let safety = 0;
  const maxPixels = width * height * 0.5;

  while (queue.length > 0 && safety < maxPixels) {
    const {x, y} = queue.shift();
    if (y < 0 || y >= height) continue;

    // Find left boundary
    let lx = x;
    while (lx > 0) {
      const idx = (y * width + (lx - 1)) * 4;
      if (!matches(idx) || visited[y * width + lx - 1]) break;
      lx--;
    }

    // Scan right, filling pixels
    let rx = lx;
    let aboveAdded = false, belowAdded = false;

    while (rx < width) {
      const vi = y * width + rx;
      const idx = vi * 4;

      if (!matches(idx) || visited[vi]) break;

      visited[vi] = 1;
      setPixel(idx);
      safety++;

      // Check pixel above
      if (y > 0) {
        const aboveVi = (y - 1) * width + rx;
        const aboveIdx = aboveVi * 4;
        if (matches(aboveIdx) && !visited[aboveVi]) {
          if (!aboveAdded) {
            queue.push({x: rx, y: y - 1});
            aboveAdded = true;
          }
        } else {
          aboveAdded = false;
        }
      }

      // Check pixel below
      if (y < height - 1) {
        const belowVi = (y + 1) * width + rx;
        const belowIdx = belowVi * 4;
        if (matches(belowIdx) && !visited[belowVi]) {
          if (!belowAdded) {
            queue.push({x: rx, y: y + 1});
            belowAdded = true;
          }
        } else {
          belowAdded = false;
        }
      }

      rx++;
    }
  }

  ctx2.putImageData(imageData, 0, 0);
}

function hexToRgb(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : null;
}

function drawSparklesAt(ctx2, px, py, dpr) {
  for (let i = 0; i < 5; i++) {
    const sx = px + (Math.random() - 0.5) * 50 * dpr;
    const sy = py + (Math.random() - 0.5) * 50 * dpr;
    const size = (4 + Math.random() * 8) * dpr;
    const colors = ['#ffd54f','#ffffff','#f8a4c8','#81d4fa','#ce93d8'];
    const color = colors[Math.floor(Math.random() * colors.length)];

    ctx2.save();
    ctx2.translate(sx, sy);
    ctx2.rotate(Math.random() * Math.PI);
    ctx2.fillStyle = color;
    ctx2.globalAlpha = 0.8;

    // Draw 4-point star sparkle
    ctx2.beginPath();
    for (let j = 0; j < 4; j++) {
      const a = j * Math.PI / 2;
      ctx2.moveTo(0, 0);
      ctx2.lineTo(Math.cos(a - 0.18) * size * 0.3, Math.sin(a - 0.18) * size * 0.3);
      ctx2.lineTo(Math.cos(a) * size, Math.sin(a) * size);
      ctx2.lineTo(Math.cos(a + 0.18) * size * 0.3, Math.sin(a + 0.18) * size * 0.3);
    }
    ctx2.fill();
    ctx2.restore();
  }
}

function coloringDone() {
  stars += 1;
  localStorage.setItem('shiloh_stars', stars.toString());
  updateStarDisplays();
  showToast('Great job, Princess Shiloh! ‚≠ê');
  playMagicChime();
  burstCenter(30);
}

// Handle resize
window.addEventListener('resize', () => {
  resizeSC();
  if (currentPage === 'coloring') {
    setupColoringCanvas();
    loadColoringPage(colPageIdx);
  }
  if (currentPage === 'puzzle' && pzInited) {
    initPuzzle();
  }
});
// =============================================
// PUZZLE PALACE
// =============================================
let pzInited = false;
let pzImgIdx = 0;
let pzDiff = 0;
let pzPieces = [];
let pzPlacedCount = 0;
let pzTotalPieces = 0;
const pzDiffs = [{cols:2,rows:2,label:'Easy'},{cols:3,rows:3,label:'Medium'},{cols:4,rows:4,label:'Hard'}];

const pzImages = [
  { icon:'üë∏', label:'Princess', locked:false },
  { icon:'üè∞', label:'Castle', locked:false },
  { icon:'üßú‚Äç‚ôÄÔ∏è', label:'Mermaid', locked:false },
  { icon:'ü¶Ñ', label:'Unicorn', locked:false },
  { icon:'üåà', label:'Rainbow', locked:true },
];

function getPuzzleSVG(idx, w, h) {
  switch(idx) {
    case 0: return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}" width="${w}" height="${h}">
      <rect width="${w}" height="${h}" fill="#f8e1f4"/>
      <rect y="${h*.7}" width="${w}" height="${h*.3}" fill="#c8e6c9"/>
      <path d="M0,${h*.72} Q${w*.25},${h*.68} ${w*.5},${h*.72} Q${w*.75},${h*.76} ${w},${h*.70}" fill="#a5d6a7"/>
      ${[.15,.35,.65,.82].map(x=>`<circle cx="${w*x}" cy="${h*(.68+Math.random()*.04)}" r="${w*.012}" fill="${['#f48fb1','#ffd54f','#ce93d8','#81d4fa'][Math.floor(x*4)%4]}"/>`).join('')}
      <path d="M${w*.42},${h*.3} Q${w*.42},${h*.18} ${w*.5},${h*.16} Q${w*.58},${h*.18} ${w*.58},${h*.3} Q${w*.6},${h*.42} ${w*.58},${h*.54} Q${w*.55},${h*.58} ${w*.5},${h*.59} Q${w*.45},${h*.58} ${w*.42},${h*.54} Q${w*.4},${h*.42} ${w*.42},${h*.3}Z" fill="#6d4c41"/>
      <ellipse cx="${w*.5}" cy="${h*.36}" rx="${w*.08}" ry="${h*.085}" fill="#fdd9b5"/>
      <ellipse cx="${w*.47}" cy="${h*.35}" rx="${w*.018}" ry="${h*.013}" fill="white"/><circle cx="${w*.473}" cy="${h*.35}" r="${w*.009}" fill="#5d4037"/><circle cx="${w*.476}" cy="${h*.347}" r="${w*.003}" fill="white"/>
      <ellipse cx="${w*.53}" cy="${h*.35}" rx="${w*.018}" ry="${h*.013}" fill="white"/><circle cx="${w*.527}" cy="${h*.35}" r="${w*.009}" fill="#5d4037"/><circle cx="${w*.530}" cy="${h*.347}" r="${w*.003}" fill="white"/>
      <path d="M${w*.48},${h*.41} Q${w*.5},${h*.43} ${w*.52},${h*.41}" fill="none" stroke="#e57373" stroke-width="${w*.005}" stroke-linecap="round"/>
      <circle cx="${w*.44}" cy="${h*.39}" r="${w*.013}" fill="#f8a4c8" opacity=".45"/>
      <circle cx="${w*.56}" cy="${h*.39}" r="${w*.013}" fill="#f8a4c8" opacity=".45"/>
      <path d="M${w*.44},${h*.21} L${w*.46},${h*.155} L${w*.48},${h*.19} L${w*.5},${h*.135} L${w*.52},${h*.19} L${w*.54},${h*.155} L${w*.56},${h*.21}" fill="#ffd54f" stroke="#f9a825" stroke-width="${w*.003}"/>
      <circle cx="${w*.5}" cy="${h*.15}" r="${w*.007}" fill="#e91e8c"/>
      <path d="M${w*.44},${h*.46} Q${w*.5},${h*.45} ${w*.56},${h*.46} L${w*.58},${h*.52} Q${w*.5},${h*.53} ${w*.42},${h*.52}Z" fill="#f48fb1"/>
      <path d="M${w*.42},${h*.51} Q${w*.35},${h*.59} ${w*.3},${h*.68} Q${w*.5},${h*.72} ${w*.7},${h*.68} Q${w*.65},${h*.59} ${w*.58},${h*.51}" fill="#f48fb1"/>
      <path d="M${w*.36},${h*.60} Q${w*.5},${h*.64} ${w*.64},${h*.60}" fill="none" stroke="#ec407a" stroke-width="${w*.003}" opacity=".35"/>
      <path d="M${w*.44},${h*.46} Q${w*.39},${h*.50} ${w*.36},${h*.55}" fill="none" stroke="#fdd9b5" stroke-width="${w*.014}" stroke-linecap="round"/>
      <path d="M${w*.56},${h*.46} Q${w*.61},${h*.50} ${w*.64},${h*.55}" fill="none" stroke="#fdd9b5" stroke-width="${w*.014}" stroke-linecap="round"/>
      <circle cx="${w*.5}" cy="${h*.515}" r="${w*.009}" fill="#ffd54f" opacity=".7"/>
      ${[{x:.2,y:.22},{x:.8,y:.18},{x:.15,y:.48},{x:.85,y:.42}].map(s=>`<path d="M${w*s.x},${h*s.y} l${w*.006},${w*.015} l${w*.015},${w*.003} l${-w*.012},${w*.009} l${w*.003},${w*.015} l${-w*.012},-${w*.009} l${-w*.012},${w*.009} l${w*.003},-${w*.015} l${-w*.012},-${w*.009} l${w*.015},-${w*.003}Z" fill="#ffd54f" opacity=".5"/>`).join('')}
    </svg>`;

    case 1: return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}" width="${w}" height="${h}">
      <rect width="${w}" height="${h}" fill="#e3f2fd"/>
      <rect y="${h*.65}" width="${w}" height="${h*.35}" fill="#a5d6a7"/>
      <path d="M0,${h*.67} Q${w*.3},${h*.62} ${w*.5},${h*.65} Q${w*.7},${h*.68} ${w},${h*.65}" fill="#c8e6c9"/>
      <path d="M${w*.12},${h*.15} Q${w*.16},${h*.10} ${w*.22},${h*.11} Q${w*.26},${h*.07} ${w*.32},${h*.09} Q${w*.35},${h*.12} ${w*.32},${h*.16} Q${w*.22},${h*.18} ${w*.12},${h*.15}" fill="white" opacity=".6"/>
      <path d="M${w*.65},${h*.12} Q${w*.70},${h*.08} ${w*.78},${h*.09} Q${w*.84},${h*.06} ${w*.88},${h*.10} Q${w*.88},${h*.15} ${w*.82},${h*.16} Q${w*.72},${h*.16} ${w*.65},${h*.12}" fill="white" opacity=".5"/>
      <circle cx="${w*.9}" cy="${h*.10}" r="${w*.035}" fill="#ffd54f" opacity=".5"/>
      <rect x="${w*.38}" y="${h*.30}" width="${w*.24}" height="${h*.35}" rx="${w*.008}" fill="#f0d4f0" stroke="#d1b3f0" stroke-width="${w*.004}"/>
      <rect x="${w*.28}" y="${h*.22}" width="${w*.08}" height="${h*.43}" rx="${w*.006}" fill="#f0d4f0" stroke="#d1b3f0" stroke-width="${w*.004}"/>
      <polygon points="${w*.27},${h*.22} ${w*.32},${h*.12} ${w*.37},${h*.22}" fill="#d1b3f0" stroke="#ba68c8" stroke-width="${w*.003}"/>
      <rect x="${w*.64}" y="${h*.22}" width="${w*.08}" height="${h*.43}" rx="${w*.006}" fill="#f0d4f0" stroke="#d1b3f0" stroke-width="${w*.004}"/>
      <polygon points="${w*.63},${h*.22} ${w*.68},${h*.12} ${w*.73},${h*.22}" fill="#d1b3f0" stroke="#ba68c8" stroke-width="${w*.003}"/>
      <rect x="${w*.44}" y="${h*.18}" width="${w*.12}" height="${h*.47}" rx="${w*.006}" fill="#f0d4f0" stroke="#d1b3f0" stroke-width="${w*.004}"/>
      <polygon points="${w*.43},${h*.18} ${w*.5},${h*.06} ${w*.57},${h*.18}" fill="#d1b3f0" stroke="#ba68c8" stroke-width="${w*.003}"/>
      <line x1="${w*.5}" y1="${h*.06}" x2="${w*.5}" y2="${h*.02}" stroke="#ba68c8" stroke-width="${w*.004}"/>
      <polygon points="${w*.5},${h*.02} ${w*.525},${h*.04} ${w*.5},${h*.035}" fill="#ff8a80"/>
      <path d="M${w*.47},${h*.55} L${w*.47},${h*.50} Q${w*.47},${h*.47} ${w*.5},${h*.47} Q${w*.53},${h*.47} ${w*.53},${h*.50} L${w*.53},${h*.55}" fill="#7b1fa2" opacity=".4" stroke="#7b1fa2" stroke-width="${w*.003}"/>
      <circle cx="${w*.5}" cy="${h*.28}" r="${w*.016}" fill="#fce4ec" stroke="#d1b3f0" stroke-width="${w*.003}"/>
      <circle cx="${w*.32}" cy="${h*.35}" r="${w*.01}" fill="#fce4ec" stroke="#d1b3f0" stroke-width="${w*.002}"/>
      <circle cx="${w*.68}" cy="${h*.35}" r="${w*.01}" fill="#fce4ec" stroke="#d1b3f0" stroke-width="${w*.002}"/>
    </svg>`;

    case 2: return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}" width="${w}" height="${h}">
      <rect width="${w}" height="${h}" fill="#e0f7fa"/>
      <rect y="${h*.78}" width="${w}" height="${h*.22}" fill="#ffe0b2" opacity=".4"/>
      <path d="M0,${h*.80} Q${w*.3},${h*.78} ${w*.5},${h*.80} Q${w*.7},${h*.82} ${w},${h*.79}" fill="#ffcc80" opacity=".3"/>
      <path d="M${w*.08},${h*.80} Q${w*.06},${h*.65} ${w*.10},${h*.55} Q${w*.07},${h*.45} ${w*.09},${h*.38}" fill="none" stroke="#66bb6a" stroke-width="${w*.007}" stroke-linecap="round" opacity=".45"/>
      <path d="M${w*.88},${h*.79} Q${w*.90},${h*.68} ${w*.87},${h*.58}" fill="none" stroke="#66bb6a" stroke-width="${w*.006}" stroke-linecap="round" opacity=".35"/>
      <circle cx="${w*.2}" cy="${h*.25}" r="${w*.012}" fill="rgba(255,255,255,.4)"/>
      <circle cx="${w*.78}" cy="${h*.20}" r="${w*.008}" fill="rgba(255,255,255,.3)"/>
      <path d="M${w*.43},${h*.27} Q${w*.42},${h*.18} ${w*.5},${h*.16} Q${w*.58},${h*.18} ${w*.57},${h*.27} Q${w*.60},${h*.35} ${w*.58},${h*.48} Q${w*.55},${h*.54} ${w*.5},${h*.55} Q${w*.45},${h*.54} ${w*.42},${h*.48} Q${w*.40},${h*.35} ${w*.43},${h*.27}Z" fill="#6d4c41"/>
      <ellipse cx="${w*.5}" cy="${h*.32}" rx="${w*.07}" ry="${h*.07}" fill="#fdd9b5"/>
      <ellipse cx="${w*.47}" cy="${h*.31}" rx="${w*.015}" ry="${h*.011}" fill="white"/><circle cx="${w*.473}" cy="${h*.31}" r="${w*.007}" fill="#5d4037"/>
      <ellipse cx="${w*.53}" cy="${h*.31}" rx="${w*.015}" ry="${h*.011}" fill="white"/><circle cx="${w*.527}" cy="${h*.31}" r="${w*.007}" fill="#5d4037"/>
      <path d="M${w*.48},${h*.36} Q${w*.5},${h*.375} ${w*.52},${h*.36}" fill="none" stroke="#e57373" stroke-width="${w*.004}" stroke-linecap="round"/>
      <path d="M${w*.46},${h*.43} Q${w*.5},${h*.42} ${w*.54},${h*.43} L${w*.53},${h*.48} Q${w*.5},${h*.49} ${w*.47},${h*.48}Z" fill="#ce93d8"/>
      <path d="M${w*.47},${h*.47} Q${w*.44},${h*.55} ${w*.42},${h*.64} Q${w*.5},${h*.67} ${w*.58},${h*.64} Q${w*.56},${h*.55} ${w*.53},${h*.47}" fill="#4dd0e1"/>
      <path d="M${w*.42},${h*.63} Q${w*.38},${h*.68} ${w*.35},${h*.74} Q${w*.5},${h*.76} ${w*.65},${h*.74} Q${w*.62},${h*.68} ${w*.58},${h*.63}" fill="#4dd0e1"/>
      <path d="M${w*.5},${h*.73} Q${w*.42},${h*.78} ${w*.38},${h*.82}" fill="none" stroke="#00acc1" stroke-width="${w*.007}" stroke-linecap="round" opacity=".6"/>
      <path d="M${w*.5},${h*.73} Q${w*.58},${h*.78} ${w*.62},${h*.82}" fill="none" stroke="#00acc1" stroke-width="${w*.007}" stroke-linecap="round" opacity=".6"/>
      <ellipse cx="${w*.72}" cy="${h*.55}" rx="${w*.025}" ry="${h*.012}" fill="#ff9800" opacity=".5"/>
      <polygon points="${w*.745},${h*.55} ${w*.78},${h*.545} ${w*.78},${h*.555}" fill="#ff9800" opacity=".4"/>
      <circle cx="${w*.71}" cy="${h*.548}" r="${w*.003}" fill="#5d4037"/>
    </svg>`;

    case 3: return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}" width="${w}" height="${h}">
      <rect width="${w}" height="${h}" fill="#e8f5e9"/>
      <rect y="${h*.72}" width="${w}" height="${h*.28}" fill="#a5d6a7"/>
      <path d="M0,${h*.74} Q${w*.25},${h*.70} ${w*.5},${h*.74} Q${w*.75},${h*.78} ${w},${h*.72}" fill="#c8e6c9"/>
      ${[0,1,2,3,4,5].map(i=>`<path d="M${w*(.1+i*.04)},${h*.15} Q${w*.3},${h*(.02+i*.02)} ${w*(.5-i*.04)},${h*.15}" fill="none" stroke="${['#ef5350','#ff9800','#ffd54f','#66bb6a','#42a5f5','#ab47bc'][i]}" stroke-width="${w*.005}" opacity=".4"/>`).join('')}
      ${[{x:.15,y:.70,c:'#f48fb1'},{x:.25,y:.72,c:'#ffd54f'},{x:.78,y:.71,c:'#ce93d8'},{x:.68,y:.73,c:'#81d4fa'}].map(f=>`<circle cx="${w*f.x}" cy="${h*f.y}" r="${w*.01}" fill="${f.c}"/>`).join('')}
      <ellipse cx="${w*.5}" cy="${h*.48}" rx="${w*.14}" ry="${h*.095}" fill="white" stroke="#e0e0e0" stroke-width="${w*.003}"/>
      ${[.36,.41,.59,.64].map(x=>`<line x1="${w*x}" y1="${h*.48}" x2="${w*x}" y2="${h*.68}" stroke="#e0e0e0" stroke-width="${w*.011}" stroke-linecap="round"/>`).join('')}
      <ellipse cx="${w*.385}" cy="${h*.69}" rx="${w*.018}" ry="${h*.007}" fill="#e0e0e0"/>
      <ellipse cx="${w*.615}" cy="${h*.69}" rx="${w*.018}" ry="${h*.007}" fill="#e0e0e0"/>
      <path d="M${w*.55},${h*.38} Q${w*.58},${h*.30} ${w*.62},${h*.28} Q${w*.67},${h*.26} ${w*.68},${h*.30} Q${w*.68},${h*.34} ${w*.65},${h*.36} Q${w*.60},${h*.38} ${w*.56},${h*.40}" fill="white" stroke="#e0e0e0" stroke-width="${w*.003}"/>
      <ellipse cx="${w*.635}" cy="${h*.325}" rx="${w*.011}" ry="${h*.008}" fill="white"/><circle cx="${w*.633}" cy="${h*.325}" r="${w*.005}" fill="#5d4037"/>
      <circle cx="${w*.66}" cy="${h*.315}" r="${w*.003}" fill="#f48fb1" opacity=".4"/>
      <path d="M${w*.645},${h*.28} L${w*.66},${h*.22}" fill="none" stroke="#ffd54f" stroke-width="${w*.005}" stroke-linecap="round"/>
      <path d="M${w*.56},${h*.35} Q${w*.52},${h*.28} ${w*.48},${h*.30} Q${w*.42},${h*.28} ${w*.40},${h*.32} Q${w*.38},${h*.30} ${w*.36},${h*.33} Q${w*.35},${h*.36} ${w*.38},${h*.40} Q${w*.42},${h*.42} ${w*.48},${h*.40} Q${w*.52},${h*.42} ${w*.55},${h*.38}" fill="#f8bbd0" opacity=".4" stroke="#f48fb1" stroke-width="${w*.003}"/>
    </svg>`;

    default: return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}" width="${w}" height="${h}"><rect width="${w}" height="${h}" fill="#f3e5f5"/></svg>`;
  }
}

function initPuzzle() {
  pzInited = true;
  document.getElementById('star-puzzle').textContent = stars;

  const chooser = document.getElementById('pz-chooser');
  chooser.innerHTML = pzImages.map((img, i) =>
    `<div class="pz-img-thumb ${i===pzImgIdx?'act':''} ${img.locked?'lck':''}" onclick="${img.locked?`showToast('Earn ‚≠ê to unlock!')`:`selectPzImg(${i})`}">${img.icon}</div>`
  ).join('');

  const diff = document.getElementById('pz-diff');
  diff.innerHTML = pzDiffs.map((d, i) =>
    `<div class="pz-diff-btn ${i===pzDiff?'act':''}" onclick="selectPzDiff(${i})">${d.label}</div>`
  ).join('') + `<div class="pz-shuffle-btn" onclick="shufflePuzzle()">üîÄ Shuffle</div>`;

  buildPuzzle();
}

function selectPzImg(i) {
  pzImgIdx = i;
  document.querySelectorAll('.pz-img-thumb').forEach((t, j) => t.classList.toggle('act', j===i));
  buildPuzzle();
  playChime();
}

function selectPzDiff(i) {
  pzDiff = i;
  document.querySelectorAll('.pz-diff-btn').forEach((t, j) => t.classList.toggle('act', j===i));
  buildPuzzle();
  playChime();
}

function buildPuzzle() {
  const board = document.getElementById('pz-board');
  const wrap = document.getElementById('pz-board-wrap');
  const complete = document.getElementById('pz-complete');
  complete.classList.remove('show');

  // Remove old pieces from wrap (they live in wrap, not board)
  wrap.querySelectorAll('.pz-piece').forEach(p => {
    if (p._cleanup) p._cleanup();
    p.remove();
  });
  board.querySelectorAll('.pz-ghost').forEach(g => g.remove());
  pzPieces = [];
  pzPlacedCount = 0;

  const {cols, rows} = pzDiffs[pzDiff];
  pzTotalPieces = cols * rows;

  const wrapRect = wrap.getBoundingClientRect();
  const wrapW = wrapRect.width - 20;
  const wrapH = wrapRect.height - 20;
  const boardSize = Math.min(wrapW, wrapH, 400);

  board.style.width = boardSize + 'px';
  board.style.height = boardSize + 'px';

  const pieceW = boardSize / cols;
  const pieceH = boardSize / rows;

  // Render full image to hidden canvas
  const dpr = Math.min(window.devicePixelRatio || 1, 2);
  const imgW = Math.round(boardSize * dpr);
  const imgH = Math.round(boardSize * dpr);
  const imgCanvas = document.createElement('canvas');
  imgCanvas.width = imgW;
  imgCanvas.height = imgH;

  const svgStr = getPuzzleSVG(pzImgIdx, imgW, imgH);
  const encoded = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgStr)));
  const img = new Image();

  img.onload = () => {
    const ictx = imgCanvas.getContext('2d');
    ictx.drawImage(img, 0, 0);

    // Create ghost slots
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const ghost = document.createElement('div');
        ghost.className = 'pz-ghost';
        ghost.style.left = (c * pieceW) + 'px';
        ghost.style.top = (r * pieceH) + 'px';
        ghost.style.width = pieceW + 'px';
        ghost.style.height = pieceH + 'px';
        ghost.dataset.col = c;
        ghost.dataset.row = r;
        board.appendChild(ghost);
      }
    }

    // Create pieces with cropped image
    const pieces = [];
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const pc = document.createElement('canvas');
        const pcW = Math.round(pieceW * dpr);
        const pcH = Math.round(pieceH * dpr);
        pc.width = pcW;
        pc.height = pcH;
        const pctx = pc.getContext('2d');
        pctx.drawImage(imgCanvas, c * pcW, r * pcH, pcW, pcH, 0, 0, pcW, pcH);

        const piece = document.createElement('div');
        piece.className = 'pz-piece';
        piece.style.width = pieceW + 'px';
        piece.style.height = pieceH + 'px';
        piece.appendChild(pc);
        piece.dataset.col = c;
        piece.dataset.row = r;

        pieces.push({el: piece, col: c, row: r});
      }
    }

    // Shuffle positions ‚Äî scatter around the wrap area
    const boardRect = board.getBoundingClientRect();
    const bx = boardRect.left - wrapRect.left;
    const by = boardRect.top - wrapRect.top;

    pieces.sort(() => Math.random() - 0.5);
    pieces.forEach((p, i) => {
      // Random position around board edges
      let px, py;
      const margin = 10;
      const side = Math.floor(Math.random() * 4);

      // Scatter in available space around the board
      px = margin + Math.random() * (wrapW - pieceW - margin*2);
      py = margin + Math.random() * (wrapH - pieceH - margin*2);

      // Avoid placing directly on the board for clarity
      const boardCx = bx + boardSize / 2;
      const boardCy = by + boardSize / 2;
      const dx = px + pieceW/2 - boardCx;
      const dy = py + pieceH/2 - boardCy;
      if (Math.abs(dx) < boardSize/2 + 10 && Math.abs(dy) < boardSize/2 + 10) {
        // Push to edge
        if (Math.random() > 0.5) {
          px = Math.random() > 0.5 ? margin : wrapW - pieceW - margin;
        } else {
          py = Math.random() > 0.5 ? margin : wrapH - pieceH - margin;
        }
      }

      p.el.style.left = px + 'px';
      p.el.style.top = py + 'px';
      wrap.appendChild(p.el);

      // Set up drag
      setupPieceDrag(p.el, pieceW, pieceH, boardSize, cols, rows, wrapRect, boardRect);
      pzPieces.push(p);
    });
  };
  img.src = encoded;
}

function setupPieceDrag(el, pieceW, pieceH, boardSize, cols, rows, wrapRect, boardRect) {
  let startX, startY, elX, elY, dragging = false;
  const wrap = document.getElementById('pz-board-wrap');

  function onStart(e) {
    if (el.classList.contains('placed')) return;
    e.preventDefault();
    const touch = e.touches ? e.touches[0] : e;
    const rect = el.getBoundingClientRect();
    startX = touch.clientX;
    startY = touch.clientY;
    elX = parseFloat(el.style.left);
    elY = parseFloat(el.style.top);
    dragging = true;
    el.style.zIndex = '100';
    el.style.boxShadow = '0 8px 30px rgba(0,0,0,0.2)';
    el.style.transform = 'scale(1.08)';
    playChime();
  }

  function onMove(e) {
    if (!dragging) return;
    e.preventDefault();
    const touch = e.touches ? e.touches[0] : e;
    const dx = touch.clientX - startX;
    const dy = touch.clientY - startY;
    el.style.left = (elX + dx) + 'px';
    el.style.top = (elY + dy) + 'px';
  }

  function onEnd(e) {
    if (!dragging) return;
    dragging = false;
    el.style.zIndex = '10';
    el.style.boxShadow = '0 3px 12px rgba(0,0,0,0.12),0 1px 3px rgba(0,0,0,0.08)';
    el.style.transform = 'scale(1)';

    // Check if piece is near its correct slot
    const board = document.getElementById('pz-board');
    const bRect = board.getBoundingClientRect();
    const wRect = wrap.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();

    const col = parseInt(el.dataset.col);
    const row = parseInt(el.dataset.row);

    // Target position on board
    const targetX = bRect.left + col * pieceW;
    const targetY = bRect.top + row * pieceH;

    // Snap distance
    const snapDist = pieceW * 0.4;

    const ecx = elRect.left + elRect.width / 2;
    const ecy = elRect.top + elRect.height / 2;
    const tcx = targetX + pieceW / 2;
    const tcy = targetY + pieceH / 2;

    if (Math.abs(ecx - tcx) < snapDist && Math.abs(ecy - tcy) < snapDist) {
      // Snap into place!
      const snapX = targetX - wRect.left;
      const snapY = targetY - wRect.top;
      el.style.left = snapX + 'px';
      el.style.top = snapY + 'px';
      el.classList.add('placed');
      el.style.zIndex = '5';
      el.style.boxShadow = '0 1px 4px rgba(0,0,0,0.06)';
      el.style.transform = 'scale(1)';

      // Mark ghost as filled
      board.querySelectorAll('.pz-ghost').forEach(g => {
        if (parseInt(g.dataset.col) === col && parseInt(g.dataset.row) === row) {
          g.classList.add('filled');
        }
      });

      pzPlacedCount++;
      playMagicChime();

      const elBR = el.getBoundingClientRect();
      burst(elBR.left + elBR.width/2, elBR.top + elBR.height/2, 15);

      // Check completion
      if (pzPlacedCount >= pzTotalPieces) {
        setTimeout(() => {
          document.getElementById('pz-complete').classList.add('show');
          stars += 2;
          localStorage.setItem('shiloh_stars', stars.toString());
          updateStarDisplays();
          document.getElementById('star-puzzle').textContent = stars;
          showToast('Puzzle complete! +2 ‚≠ê');
          playMagicChime();
          for (let i = 0; i < 8; i++) {
            setTimeout(() => burst(Math.random() * window.innerWidth, Math.random() * window.innerHeight * 0.6, 20), i * 150);
          }
        }, 400);
      }
    }
  }

  el.addEventListener('pointerdown', onStart);
  window.addEventListener('pointermove', onMove);
  window.addEventListener('pointerup', onEnd);

  // Store cleanup ref
  el._cleanup = () => {
    window.removeEventListener('pointermove', onMove);
    window.removeEventListener('pointerup', onEnd);
  };
}

function shufflePuzzle() {
  buildPuzzle();
  showToast('Pieces shuffled! üîÄ');
  playChime();
}

function pzNextPuzzle() {
  pzImgIdx = (pzImgIdx + 1) % pzImages.filter(p => !p.locked).length;
  document.querySelectorAll('.pz-img-thumb').forEach((t, j) => t.classList.toggle('act', j===pzImgIdx));
  buildPuzzle();
  playMagicChime();
}


// =============================================
// DANCE PARTY
// =============================================
let dnRunning = false;
let dnScore = 0;
let dnCombo = 0;
let dnBestCombo = 0;
let dnNotes = []; // active falling notes
let dnBPM = 110;
let dnBeatTimer = null;
let dnAnimFrame = null;
let dnLastBeat = 0;
let dnPoseIdx = 0;
let dnFloorInited = false;
let dnMusicOsc = null;
let dnMusicGain = null;

const dnLanes = [
  { cls:'n-pink', emoji:'üíñ', color:'#f48fb1' },
  { cls:'n-purple', emoji:'üíú', color:'#ce93d8' },
  { cls:'n-gold', emoji:'‚≠ê', color:'#ffd54f' },
  { cls:'n-blue', emoji:'üíé', color:'#81d4fa' },
];

// Simple princess melody
const dnMelody = [
  {f:523,d:.2},{f:587,d:.2},{f:659,d:.2},{f:784,d:.4},
  {f:659,d:.2},{f:587,d:.2},{f:523,d:.4},
  {f:659,d:.2},{f:784,d:.2},{f:880,d:.2},{f:784,d:.4},
  {f:659,d:.3},{f:523,d:.5},
  {f:784,d:.2},{f:880,d:.2},{f:784,d:.2},{f:659,d:.3},
  {f:587,d:.2},{f:523,d:.2},{f:587,d:.3},{f:659,d:.5},
];

function initDance() {
  dnScore = 0;
  dnCombo = 0;
  document.getElementById('dn-score').textContent = '0';
  document.getElementById('dn-combo').classList.remove('show');
  document.getElementById('dn-overlay').classList.remove('hidden');

  // Build floor tiles
  if (!dnFloorInited) {
    const floor = document.getElementById('dn-floor');
    floor.innerHTML = '';
    const cols = 6, rows = 3;
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const tile = document.createElement('div');
        tile.className = 'dn-tile';
        tile.style.left = (c * 100 / cols) + '%';
        tile.style.top = (r * 100 / rows) + '%';
        tile.style.width = (100 / cols) + '%';
        tile.style.height = (100 / rows) + '%';
        tile.dataset.idx = r * cols + c;
        floor.appendChild(tile);
      }
    }
    dnFloorInited = true;
  }
}

function dnStart() {
  document.getElementById('dn-overlay').classList.add('hidden');
  dnRunning = true;
  dnScore = 0;
  dnCombo = 0;
  dnBestCombo = 0;
  dnNotes = [];
  document.getElementById('dn-score').textContent = '0';

  // Clear any existing notes
  document.querySelectorAll('.dn-note').forEach(n => n.remove());

  // Start spawning notes on beat
  const beatInterval = 60000 / dnBPM;
  let beatCount = 0;

  dnBeatTimer = setInterval(() => {
    if (!dnRunning) return;
    beatCount++;

    // Spawn 1-2 notes per beat
    const numNotes = beatCount % 4 === 0 ? 2 : 1;
    const usedLanes = [];
    for (let i = 0; i < numNotes; i++) {
      let lane;
      do { lane = Math.floor(Math.random() * 4); } while (usedLanes.includes(lane));
      usedLanes.push(lane);
      spawnNote(lane);
    }

    // Animate dancer
    dnPoseIdx = (dnPoseIdx + 1) % 4;
    const dancer = document.getElementById('dn-dancer');
    dancer.className = 'dn-dancer pose' + (dnPoseIdx + 1);

    // Flash random floor tiles
    flashFloorTiles();

    // Play background beat
    dnPlayBeat(beatCount);

  }, beatInterval);

  // Start animation loop
  dnAnimate();

  // Play melody
  dnPlayMelody();

  // End after 45 seconds
  setTimeout(() => {
    if (dnRunning) dnEndRound();
  }, 45000);
}

function spawnNote(lane) {
  const layout = document.getElementById('dn-layout');
  const btnRow = document.getElementById('dn-btn-row');
  const btns = btnRow.children;
  const btn = btns[lane];
  const btnRect = btn.getBoundingClientRect();
  const layoutRect = layout.getBoundingClientRect();

  const note = document.createElement('div');
  note.className = 'dn-note ' + dnLanes[lane].cls;
  note.textContent = dnLanes[lane].emoji;

  // Position at top, centered on lane
  const noteSize = Math.min(60, window.innerWidth * 0.12);
  const centerX = btnRect.left - layoutRect.left + btnRect.width / 2 - noteSize / 2;
  note.style.left = centerX + 'px';
  note.style.top = '60px';
  note.style.width = noteSize + 'px';
  note.style.height = noteSize + 'px';

  layout.appendChild(note);

  const targetY = btnRect.top - layoutRect.top - noteSize / 2;
  const speed = 2.2; // pixels per frame (~60fps)

  dnNotes.push({
    el: note,
    lane: lane,
    y: 60,
    targetY: targetY,
    speed: speed + Math.random() * 0.3,
    hit: false,
    missed: false,
  });
}

function dnAnimate() {
  if (!dnRunning) return;

  for (let i = dnNotes.length - 1; i >= 0; i--) {
    const n = dnNotes[i];
    if (n.hit || n.missed) continue;

    n.y += n.speed;
    n.el.style.top = n.y + 'px';

    // Check if passed target (missed)
    if (n.y > n.targetY + 60) {
      n.missed = true;
      n.el.style.opacity = '0.2';
      n.el.style.transition = 'opacity 0.3s';
      dnCombo = 0;
      updateCombo();

      setTimeout(() => {
        n.el.remove();
        const idx = dnNotes.indexOf(n);
        if (idx > -1) dnNotes.splice(idx, 1);
      }, 400);
    }
  }

  dnAnimFrame = requestAnimationFrame(dnAnimate);
}

function dnHit(lane, e) {
  if (e) e.preventDefault();
  if (!dnRunning) return;

  const btn = document.querySelectorAll('.dn-hit-btn')[lane];
  btn.classList.add('flash');
  setTimeout(() => btn.classList.remove('flash'), 150);

  // Find closest note in this lane near target
  let closest = null;
  let closestDist = Infinity;

  for (const n of dnNotes) {
    if (n.lane !== lane || n.hit || n.missed) continue;
    const dist = Math.abs(n.y - n.targetY);
    if (dist < closestDist && dist < 80) {
      closest = n;
      closestDist = dist;
    }
  }

  if (closest) {
    closest.hit = true;

    // Score based on accuracy
    let points = 10;
    let label = '‚ú®';
    if (closestDist < 15) { points = 30; label = 'üåü Perfect!'; }
    else if (closestDist < 35) { points = 20; label = '‚≠ê Great!'; }
    else { points = 10; label = '‚ú® Nice!'; }

    dnScore += points;
    dnCombo++;
    if (dnCombo > dnBestCombo) dnBestCombo = dnCombo;

    // Combo bonus
    if (dnCombo >= 3) {
      dnScore += dnCombo;
    }

    document.getElementById('dn-score').textContent = dnScore;
    updateCombo();

    // Animate note hit
    closest.el.style.transition = 'transform 0.2s, opacity 0.3s';
    closest.el.style.transform = 'scale(1.5)';
    closest.el.style.opacity = '0';

    // Burst
    const rect = closest.el.getBoundingClientRect();
    burst(rect.left + rect.width / 2, rect.top + rect.height / 2, 12);

    playChime();

    setTimeout(() => {
      closest.el.remove();
      const idx = dnNotes.indexOf(closest);
      if (idx > -1) dnNotes.splice(idx, 1);
    }, 300);
  } else {
    // Missed tap ‚Äî no penalty, just no points
  }
}

function updateCombo() {
  const el = document.getElementById('dn-combo');
  if (dnCombo >= 3) {
    el.textContent = 'üî• Combo x' + dnCombo + '!';
    el.classList.add('show');
  } else {
    el.classList.remove('show');
  }
}

function flashFloorTiles() {
  const tiles = document.querySelectorAll('.dn-tile');
  // Light up 2-3 random tiles
  const num = 2 + Math.floor(Math.random() * 2);
  const indices = [];
  for (let i = 0; i < num; i++) {
    let idx;
    do { idx = Math.floor(Math.random() * tiles.length); } while (indices.includes(idx));
    indices.push(idx);
    tiles[idx].classList.add('lit');
    setTimeout(() => tiles[idx].classList.remove('lit'), 300);
  }
}

function dnPlayBeat(beat) {
  if (!soundOn) return;
  try {
    // Kick on 1,3 ‚Äî snare on 2,4
    const t = audioCtx.currentTime;
    if (beat % 2 === 1) {
      // Kick
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.connect(g); g.connect(audioCtx.destination);
      osc.frequency.setValueAtTime(150, t);
      osc.frequency.exponentialRampToValueAtTime(50, t + 0.1);
      g.gain.setValueAtTime(0.08, t);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
      osc.start(t); osc.stop(t + 0.15);
    } else {
      // Snare-like noise
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.connect(g); g.connect(audioCtx.destination);
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(200, t);
      g.gain.setValueAtTime(0.04, t);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.08);
      osc.start(t); osc.stop(t + 0.08);
    }
  } catch(e) {}
}

let dnMelodyTimeout = null;
function dnPlayMelody() {
  if (!soundOn || !dnRunning) return;
  let noteIdx = 0;
  const beatLen = 60 / dnBPM;

  function playNext() {
    if (!dnRunning || !soundOn) return;
    if (noteIdx >= dnMelody.length) {
      noteIdx = 0; // loop
    }
    const m = dnMelody[noteIdx];
    try {
      const t = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.connect(g); g.connect(audioCtx.destination);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(m.f, t);
      g.gain.setValueAtTime(0.06, t);
      g.gain.setValueAtTime(0.06, t + m.d * beatLen * 0.7);
      g.gain.exponentialRampToValueAtTime(0.001, t + m.d * beatLen);
      osc.start(t);
      osc.stop(t + m.d * beatLen);
    } catch(e) {}
    noteIdx++;
    dnMelodyTimeout = setTimeout(playNext, m.d * beatLen * 1000);
  }
  playNext();
}

function dnEndRound() {
  dnRunning = false;
  if (dnBeatTimer) clearInterval(dnBeatTimer);
  if (dnAnimFrame) cancelAnimationFrame(dnAnimFrame);
  if (dnMelodyTimeout) clearTimeout(dnMelodyTimeout);

  // Clean up notes
  document.querySelectorAll('.dn-note').forEach(n => n.remove());
  dnNotes = [];

  // Award stars
  let earned = 1;
  if (dnScore >= 200) earned = 3;
  else if (dnScore >= 100) earned = 2;

  stars += earned;
  localStorage.setItem('shiloh_stars', stars.toString());
  updateStarDisplays();

  // Show end overlay
  const overlay = document.getElementById('dn-overlay');
  overlay.innerHTML = `
    <div class="dn-overlay-title">üåü Amazing Dance! üåü</div>
    <div class="dn-overlay-sub">Score: ${dnScore} ‚ú® Best Combo: ${dnCombo >= 3 ? dnBestCombo : 'None'}<br>You earned ${earned} ‚≠ê!</div>
    <button class="dn-start-btn" onclick="initDance();dnStart()">Dance Again! üíÉ</button>
  `;
  overlay.classList.remove('hidden');

  showToast(`+${earned} ‚≠ê Great dancing, Princess Shiloh!`);
  playMagicChime();
  for (let i = 0; i < 6; i++) {
    setTimeout(() => burst(Math.random() * window.innerWidth, Math.random() * window.innerHeight * 0.7, 18), i * 200);
  }
}

function dnStop() {
  dnRunning = false;
  if (dnBeatTimer) clearInterval(dnBeatTimer);
  if (dnAnimFrame) cancelAnimationFrame(dnAnimFrame);
  if (dnMelodyTimeout) clearTimeout(dnMelodyTimeout);
  document.querySelectorAll('.dn-note').forEach(n => n.remove());
  dnNotes = [];
}


// =============================================
// CATCH THE STARS
// =============================================
let stRunning = false;
let stScore = 0;
let stLives = 3;
let stTimeLeft = 30;
let stTimer = null;
let stSpawnTimer = null;
let stAnimFrame = null;
let stItems = [];
let stSpawnTimeout = null;
let stBgInited = false;
let stDifficulty = 1;

const stGoodItems = [
  {emoji:'‚≠ê',pts:10,size:1},
  {emoji:'üåü',pts:15,size:1.1},
  {emoji:'üíé',pts:20,size:0.95},
  {emoji:'‚ú®',pts:5,size:0.85},
  {emoji:'ü¶ã',pts:10,size:1},
  {emoji:'üíñ',pts:15,size:1},
  {emoji:'üêö',pts:10,size:0.9},
  {emoji:'üëë',pts:25,size:1.05},
];

const stBadItems = [
  {emoji:'ü¶Ä',pts:-1,size:1},
  {emoji:'üêô',pts:-1,size:1.1},
];

function initStars() {
  stScore = 0;
  stLives = 3;
  stTimeLeft = 30;
  stDifficulty = 1;
  document.getElementById('st-score').textContent = '‚≠ê 0';
  document.getElementById('st-lives').textContent = 'üíñüíñüíñ';
  document.getElementById('st-timer').textContent = '0:30';
  document.getElementById('st-overlay').classList.remove('hidden');

  // Rebuild overlay content in case it was replaced by end screen
  document.getElementById('st-overlay').innerHTML = `
    <div class="st-ov-title">‚≠ê Catch the Stars! ‚≠ê</div>
    <div class="st-ov-sub">Tap the falling stars and gems!<br>Don't tap the crabs! ü¶Ä</div>
    <button class="st-ov-btn" onclick="stStart()">Start! ‚≠ê</button>
  `;

  // Create twinkling bg stars
  if (!stBgInited) {
    const container = document.getElementById('st-bg-stars');
    container.innerHTML = '';
    for (let i = 0; i < 40; i++) {
      const s = document.createElement('div');
      s.className = 'st-bg-star';
      s.style.left = (Math.random() * 100) + '%';
      s.style.top = (Math.random() * 85) + '%';
      s.style.setProperty('--d', (2 + Math.random() * 4) + 's');
      s.style.setProperty('--dl', (Math.random() * 3) + 's');
      s.style.setProperty('--o1', (0.1 + Math.random() * 0.3).toString());
      s.style.setProperty('--o2', (0.5 + Math.random() * 0.5).toString());
      const sz = 1 + Math.random() * 3;
      s.style.width = sz + 'px';
      s.style.height = sz + 'px';
      container.appendChild(s);
    }
    stBgInited = true;
  }

  // Clean up old items
  document.querySelectorAll('.st-item,.st-popup').forEach(e => e.remove());
  stItems = [];
}

function stStart() {
  document.getElementById('st-overlay').classList.add('hidden');
  stRunning = true;
  stScore = 0;
  stLives = 3;
  stTimeLeft = 30;
  stDifficulty = 1;
  stItems = [];

  document.querySelectorAll('.st-item,.st-popup').forEach(e => e.remove());
  document.getElementById('st-score').textContent = '‚≠ê 0';
  document.getElementById('st-lives').textContent = 'üíñüíñüíñ';

  // Countdown timer
  stTimer = setInterval(() => {
    if (!stRunning) return;
    stTimeLeft--;
    const mins = Math.floor(stTimeLeft / 60);
    const secs = stTimeLeft % 60;
    document.getElementById('st-timer').textContent = mins + ':' + secs.toString().padStart(2, '0');

    // Increase difficulty over time
    if (stTimeLeft === 20) stDifficulty = 1.5;
    if (stTimeLeft === 10) stDifficulty = 2;

    if (stTimeLeft <= 0) {
      stEndRound(true);
    }
  }, 1000);

  // Spawn items
  stSpawnItems();

  // Animate
  stAnimate();
}

function stSpawnItems() {
  if (!stRunning) return;

  const layout = document.getElementById('st-layout');
  const rect = layout.getBoundingClientRect();
  const w = rect.width;

  // Decide what to spawn
  const isBad = Math.random() < 0.15 * stDifficulty;
  const pool = isBad ? stBadItems : stGoodItems;
  const template = pool[Math.floor(Math.random() * pool.length)];

  const baseSize = Math.min(50, w * 0.1);
  const size = baseSize * template.size;

  const el = document.createElement('div');
  el.className = 'st-item' + (isBad ? ' bad' : '');
  el.textContent = template.emoji;
  el.style.fontSize = size + 'px';
  el.style.lineHeight = '1';
  el.style.left = (Math.random() * (w - size - 20) + 10) + 'px';
  el.style.top = '-' + (size + 10) + 'px';

  // Tap handler
  el.addEventListener('pointerdown', (e) => {
    e.preventDefault();
    e.stopPropagation();
    stCatchItem(el, template, isBad);
  });

  layout.appendChild(el);

  const speed = (1 + Math.random() * 1.5) * stDifficulty * 0.7;
  const wobble = (Math.random() - 0.5) * 0.8;

  stItems.push({
    el,
    y: -(size + 10),
    speed,
    wobble,
    wobbleOffset: Math.random() * Math.PI * 2,
    isBad,
    caught: false,
  });

  // Schedule next spawn
  const delay = Math.max(300, 900 / stDifficulty - Math.random() * 200);
  stSpawnTimeout = setTimeout(stSpawnItems, delay);
}

function stAnimate() {
  if (!stRunning) return;

  const layout = document.getElementById('st-layout');
  const maxY = layout.clientHeight + 20;

  for (let i = stItems.length - 1; i >= 0; i--) {
    const item = stItems[i];
    if (item.caught) continue;

    item.y += item.speed;
    const wobbleX = Math.sin(item.y * 0.02 + item.wobbleOffset) * 15 * item.wobble;
    item.el.style.top = item.y + 'px';
    item.el.style.transform = `translateX(${wobbleX}px)`;

    // Fell off screen
    if (item.y > maxY) {
      if (!item.isBad) {
        // Missed a good item ‚Äî no penalty for Shiloh, just disappears
      }
      item.el.remove();
      stItems.splice(i, 1);
    }
  }

  stAnimFrame = requestAnimationFrame(stAnimate);
}

function stCatchItem(el, template, isBad) {
  if (!stRunning) return;

  // Find the item
  const idx = stItems.findIndex(it => it.el === el);
  if (idx === -1) return;
  const item = stItems[idx];
  if (item.caught) return;
  item.caught = true;

  const rect = el.getBoundingClientRect();
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + rect.height / 2;

  if (isBad) {
    // Hit a bad item ‚Äî lose a life
    stLives--;
    updateLives();
    el.classList.add('caught');
    showStPopup(el, 'üíî Ouch!', '#ef5350');

    // Vibrate-like visual feedback
    el.style.transition = 'transform .15s';
    el.style.transform = 'scale(1.3) rotate(15deg)';
    setTimeout(() => { el.style.transform = 'scale(0.5)'; el.style.opacity = '0'; }, 150);

    burst(cx, cy, 8);

    if (stLives <= 0) {
      setTimeout(() => stEndRound(false), 400);
    }
  } else {
    // Caught a good item!
    stScore += template.pts;
    document.getElementById('st-score').textContent = '‚≠ê ' + stScore;
    el.classList.add('caught');
    showStPopup(el, '+' + template.pts, '#ffd54f');
    burst(cx, cy, 12);
    playChime();
  }

  setTimeout(() => {
    el.remove();
    const i2 = stItems.indexOf(item);
    if (i2 > -1) stItems.splice(i2, 1);
  }, 350);
}

function updateLives() {
  const hearts = [];
  for (let i = 0; i < 3; i++) {
    hearts.push(i < stLives ? 'üíñ' : 'üñ§');
  }
  document.getElementById('st-lives').textContent = hearts.join('');
}

function showStPopup(el, text, color) {
  const layout = document.getElementById('st-layout');
  const popup = document.createElement('div');
  popup.className = 'st-popup';
  popup.textContent = text;
  popup.style.color = color;
  popup.style.left = el.style.left;
  popup.style.top = (parseFloat(el.style.top) - 20) + 'px';
  layout.appendChild(popup);
  setTimeout(() => popup.remove(), 900);
}

function stEndRound(timeUp) {
  stRunning = false;
  if (stTimer) clearInterval(stTimer);
  if (stAnimFrame) cancelAnimationFrame(stAnimFrame);
  if (stSpawnTimeout) clearTimeout(stSpawnTimeout);

  // Clean up remaining items
  stItems.forEach(it => it.el.remove());
  stItems = [];
  document.querySelectorAll('.st-popup').forEach(p => p.remove());

  // Award stars
  let earned = 1;
  if (stScore >= 200) earned = 3;
  else if (stScore >= 100) earned = 2;

  stars += earned;
  localStorage.setItem('shiloh_stars', stars.toString());
  updateStarDisplays();

  const overlay = document.getElementById('st-overlay');
  overlay.innerHTML = `
    <div class="st-ov-title">${timeUp ? '‚è∞ Time\'s Up!' : 'üíñ Game Over!'}</div>
    <div class="st-ov-sub">You caught ${stScore} points worth of stars!<br>You earned ${earned} ‚≠ê!</div>
    <button class="st-ov-btn" onclick="initStars();stStart()">Play Again! ‚≠ê</button>
  `;
  overlay.classList.remove('hidden');

  showToast(`+${earned} ‚≠ê Sparkly catch, Princess Shiloh!`);
  playMagicChime();
  for (let i = 0; i < 6; i++) {
    setTimeout(() => burst(Math.random() * window.innerWidth, Math.random() * window.innerHeight * 0.6, 16), i * 180);
  }
}

function stStop() {
  stRunning = false;
  if (stTimer) clearInterval(stTimer);
  if (stAnimFrame) cancelAnimationFrame(stAnimFrame);
  if (stSpawnTimeout) clearTimeout(stSpawnTimeout);
  stItems.forEach(it => it.el.remove());
  stItems = [];
}


// =============================================
// PRINCESS ACADEMY ‚Äî Sneaky Learning Games
// =============================================
let acRound = 0;
let acStreak = 0;
let acCorrect = 0;
const acTotalRounds = 10;
let acLocked = false; // prevent double-taps

// Challenge categories with generators
const acCategories = [
  { name:'Counting', gen:genCounting },
  { name:'Colors', gen:genColors },
  { name:'Shapes', gen:genShapes },
  { name:'Which is Bigger?', gen:genBigger },
  { name:'Matching', gen:genMatching },
  { name:'Counting', gen:genCounting },
  { name:'Colors', gen:genColors },
  { name:'Shapes', gen:genShapes },
  { name:'Which is Bigger?', gen:genBigger },
  { name:'Matching', gen:genMatching },
];

function initAcademy() {
  acRound = 0;
  acStreak = 0;
  acCorrect = 0;
  document.getElementById('star-academy').textContent = stars;
  document.getElementById('ac-streak').textContent = 'üî• 0';
  updateAcProgress();
  loadAcRound();
}

function updateAcProgress() {
  const el = document.getElementById('ac-progress');
  let html = '';
  for (let i = 0; i < acTotalRounds; i++) {
    const cls = i < acRound ? 'done' : (i === acRound ? 'current' : '');
    html += `<div class="ac-dot ${cls}"></div>`;
  }
  el.innerHTML = html;
}

function loadAcRound() {
  if (acRound >= acTotalRounds) {
    acFinish();
    return;
  }
  acLocked = false;
  const cat = acCategories[acRound];
  document.getElementById('ac-cat-label').textContent = cat.name;
  const q = cat.gen();
  document.getElementById('ac-prompt').textContent = q.prompt;
  document.getElementById('ac-display').innerHTML = q.display;
  document.getElementById('ac-feedback').classList.remove('show');

  const ansEl = document.getElementById('ac-answers');
  ansEl.innerHTML = q.answers.map((a, i) =>
    `<div class="ac-ans" data-correct="${a.correct}" onclick="acAnswer(${i},${a.correct ? 'true' : 'false'},this)">${a.label}</div>`
  ).join('');

  updateAcProgress();
}

function acAnswer(idx, correct, el) {
  if (acLocked) return;
  acLocked = true;

  const fb = document.getElementById('ac-feedback');

  if (correct) {
    el.classList.add('correct');
    acStreak++;
    acCorrect++;
    document.getElementById('ac-streak').textContent = 'üî• ' + acStreak;
    fb.textContent = ['üåü Correct!','‚≠ê Amazing!','üíñ You got it!','üëë So smart!','‚ú® Perfect!'][Math.floor(Math.random()*5)];
    fb.style.color = '#7b1fa2';
    fb.classList.add('show');
    playMagicChime();
    const rect = el.getBoundingClientRect();
    burst(rect.left + rect.width/2, rect.top + rect.height/2, 15);
  } else {
    el.classList.add('wrong');
    acStreak = 0;
    document.getElementById('ac-streak').textContent = 'üî• 0';
    fb.textContent = ['üí´ Try next time!','Almost! üíú','Keep going! üåà'][Math.floor(Math.random()*3)];
    fb.style.color = '#e91e8c';
    fb.classList.add('show');
    playChime();
    // Highlight the correct answer
    setTimeout(() => {
      document.querySelectorAll('.ac-ans').forEach(a => {
        if (a.dataset.correct === 'true') {
          a.classList.add('correct');
        }
      });
    }, 300);
  }

  acRound++;
  setTimeout(() => {
    fb.classList.remove('show');
    loadAcRound();
  }, 1200);
}

// ===== CHALLENGE GENERATORS =====

function genCounting() {
  const emojis = ['‚≠ê','üå∏','ü¶ã','üíé','üêö','üå∑','üçé','üéÄ','üíñ','üê†'];
  const emoji = emojis[Math.floor(Math.random()*emojis.length)];
  const count = 1 + Math.floor(Math.random() * 5); // 1-5
  const display = Array(count).fill(0).map((_,i) =>
    `<span class="ac-display-item" style="animation-delay:${i*0.08}s">${emoji}</span>`
  ).join(' ');

  const correct = count;
  const answers = generateAnswerSet(correct, 1, 6, 4);

  return {
    prompt: `How many ${emoji} do you see?`,
    display,
    answers,
  };
}

function genColors() {
  const colors = [
    {name:'Red',emoji:'üî¥',hex:'#ef5350'},
    {name:'Blue',emoji:'üîµ',hex:'#42a5f5'},
    {name:'Green',emoji:'üü¢',hex:'#66bb6a'},
    {name:'Yellow',emoji:'üü°',hex:'#ffd54f'},
    {name:'Purple',emoji:'üü£',hex:'#ab47bc'},
    {name:'Pink',emoji:'üíó',hex:'#f48fb1'},
    {name:'Orange',emoji:'üü†',hex:'#ff9800'},
  ];
  const target = colors[Math.floor(Math.random()*colors.length)];
  // Pick 3 wrong answers
  const others = colors.filter(c => c.name !== target.name);
  const shuffled = others.sort(() => Math.random()-0.5).slice(0,3);
  const allAnswers = [
    {label: target.name, correct: true},
    ...shuffled.map(c => ({label: c.name, correct: false}))
  ].sort(() => Math.random()-0.5);

  return {
    prompt: 'What color is this?',
    display: `<span class="ac-display-item" style="font-size:clamp(60px,18vw,100px)">${target.emoji}</span>`,
    answers: allAnswers,
  };
}

function genShapes() {
  const shapes = [
    {name:'Circle',svg:`<svg viewBox="0 0 80 80" width="80" height="80"><circle cx="40" cy="40" r="35" fill="none" stroke="#7b1fa2" stroke-width="4"/></svg>`},
    {name:'Square',svg:`<svg viewBox="0 0 80 80" width="80" height="80"><rect x="8" y="8" width="64" height="64" fill="none" stroke="#e91e8c" stroke-width="4" rx="2"/></svg>`},
    {name:'Triangle',svg:`<svg viewBox="0 0 80 80" width="80" height="80"><polygon points="40,8 75,72 5,72" fill="none" stroke="#f9a825" stroke-width="4"/></svg>`},
    {name:'Star',svg:`<svg viewBox="0 0 80 80" width="80" height="80"><polygon points="40,5 50,30 78,30 55,48 63,75 40,58 17,75 25,48 2,30 30,30" fill="none" stroke="#ff9800" stroke-width="3"/></svg>`},
    {name:'Heart',svg:`<svg viewBox="0 0 80 80" width="80" height="80"><path d="M40,70 L12,42 Q2,28 15,18 Q28,8 40,22 Q52,8 65,18 Q78,28 68,42 Z" fill="none" stroke="#f48fb1" stroke-width="3.5"/></svg>`},
    {name:'Diamond',svg:`<svg viewBox="0 0 80 80" width="80" height="80"><polygon points="40,5 72,40 40,75 8,40" fill="none" stroke="#42a5f5" stroke-width="4"/></svg>`},
  ];
  const target = shapes[Math.floor(Math.random()*shapes.length)];
  const others = shapes.filter(s => s.name !== target.name);
  const shuffled = others.sort(() => Math.random()-0.5).slice(0,3);
  const allAnswers = [
    {label: target.name, correct: true},
    ...shuffled.map(s => ({label: s.name, correct: false}))
  ].sort(() => Math.random()-0.5);

  return {
    prompt: 'What shape is this?',
    display: `<span class="ac-display-item">${target.svg}</span>`,
    answers: allAnswers,
  };
}

function genBigger() {
  const a = 1 + Math.floor(Math.random() * 8);
  let b;
  do { b = 1 + Math.floor(Math.random() * 8); } while (b === a);
  const bigger = Math.max(a, b);
  const emojis = ['üçé','üå∏','‚≠ê','üíé'];
  const emoji = emojis[Math.floor(Math.random()*emojis.length)];

  const displayA = Array(a).fill(emoji).join(' ');
  const displayB = Array(b).fill(emoji).join(' ');

  return {
    prompt: 'Which group has MORE?',
    display: `<div style="display:flex;flex-direction:column;gap:12px;align-items:center">
      <div style="padding:10px 16px;border-radius:14px;background:rgba(248,164,200,0.12);border:2px solid rgba(248,164,200,0.25);font-size:clamp(22px,5vw,32px)">${displayA}</div>
      <div style="font-size:14px;color:#999;font-weight:700">or</div>
      <div style="padding:10px 16px;border-radius:14px;background:rgba(129,212,250,0.12);border:2px solid rgba(129,212,250,0.25);font-size:clamp(22px,5vw,32px)">${displayB}</div>
    </div>`,
    answers: [
      {label: `${a} (top)`, correct: a === bigger},
      {label: `${b} (bottom)`, correct: b === bigger},
    ].sort(() => Math.random()-0.5),
  };
}

function genMatching() {
  const pairs = [
    {emoji:'üê±',name:'Cat'},{emoji:'üê∂',name:'Dog'},{emoji:'üê∞',name:'Bunny'},
    {emoji:'ü¶ã',name:'Butterfly'},{emoji:'üê†',name:'Fish'},{emoji:'ü¶Ñ',name:'Unicorn'},
    {emoji:'üå∏',name:'Flower'},{emoji:'üåà',name:'Rainbow'},{emoji:'üëë',name:'Crown'},
    {emoji:'üè∞',name:'Castle'},{emoji:'‚≠ê',name:'Star'},{emoji:'üêö',name:'Shell'},
  ];
  const target = pairs[Math.floor(Math.random()*pairs.length)];
  const others = pairs.filter(p => p.name !== target.name).sort(() => Math.random()-0.5).slice(0,3);

  const allAnswers = [
    {label: target.name, correct: true},
    ...others.map(p => ({label: p.name, correct: false}))
  ].sort(() => Math.random()-0.5);

  return {
    prompt: 'What is this?',
    display: `<span class="ac-display-item" style="font-size:clamp(65px,18vw,100px)">${target.emoji}</span>`,
    answers: allAnswers,
  };
}

// Helper: generate answer set with one correct and N-1 wrong
function generateAnswerSet(correct, min, max, count) {
  const answers = [{label: correct.toString(), correct: true}];
  const used = new Set([correct]);
  while (answers.length < count) {
    let v;
    do { v = min + Math.floor(Math.random() * (max - min + 1)); } while (used.has(v));
    used.add(v);
    answers.push({label: v.toString(), correct: false});
  }
  return answers.sort(() => Math.random()-0.5);
}

function acFinish() {
  const area = document.getElementById('ac-question-area');
  let earned = 1;
  if (acCorrect >= 9) earned = 3;
  else if (acCorrect >= 7) earned = 2;

  stars += earned;
  localStorage.setItem('shiloh_stars', stars.toString());
  updateStarDisplays();
  document.getElementById('star-academy').textContent = stars;

  area.innerHTML = `
    <div style="text-align:center">
      <div style="font-family:'Dancing Script',cursive;font-size:clamp(28px,7vw,42px);color:var(--purple-deep);margin-bottom:12px">üéì Lesson Complete!</div>
      <div style="font-size:clamp(50px,12vw,80px);margin-bottom:8px">${acCorrect >= 9 ? 'üåüüåüüåü' : acCorrect >= 7 ? 'üåüüåü' : 'üåü'}</div>
      <div style="font-size:16px;font-weight:700;color:var(--pink-deep);margin-bottom:4px">${acCorrect} out of ${acTotalRounds} correct!</div>
      <div style="font-size:14px;color:var(--gold-deep);margin-bottom:20px">You earned ${earned} ‚≠ê</div>
      <button onclick="initAcademy()" style="padding:14px 32px;border-radius:50px;border:none;background:linear-gradient(135deg,var(--pink),var(--purple));color:white;font-size:16px;font-weight:700;cursor:pointer;font-family:'Quicksand',sans-serif;box-shadow:0 4px 20px rgba(186,104,200,0.3)">Play Again! üéì</button>
    </div>
  `;

  showToast(`+${earned} ‚≠ê Great learning, Princess Shiloh!`);
  playMagicChime();
  for (let i = 0; i < 6; i++) {
    setTimeout(() => burst(Math.random() * window.innerWidth, Math.random() * window.innerHeight * 0.6, 15), i * 180);
  }
}


// =============================================
// TREASURE HUNT ‚Äî Memory Card Match
// =============================================
let thDiff = 0;
let thCards = [];
let thFlipped = [];
let thMatched = 0;
let thTotalPairs = 0;
let thMoves = 0;
let thLocked = false;

const thDiffs = [
  { cols:3, rows:2, pairs:3, label:'Easy' },
  { cols:4, rows:3, pairs:6, label:'Medium' },
  { cols:4, rows:4, pairs:8, label:'Hard' },
];

const thEmojis = ['üêö','‚≠ê','üíé','ü¶ã','üê†','üëë','üå∏','üíñ','ü¶Ñ','üê¨','üåä','üêô','üßú‚Äç‚ôÄÔ∏è','üè∞','üåà','‚ú®'];

function initTreasure() {
  document.getElementById('star-treasure').textContent = stars;
  buildThGrid();
}

function selectThDiff(d, el) {
  thDiff = d;
  document.querySelectorAll('.th-diff-btn').forEach((b,i) => b.classList.toggle('act', i===d));
  buildThGrid();
  playChime();
}

function buildThGrid() {
  const {cols, rows, pairs} = thDiffs[thDiff];
  thTotalPairs = pairs;
  thMatched = 0;
  thMoves = 0;
  thFlipped = [];
  thLocked = false;

  document.getElementById('th-moves').textContent = 'Moves: 0';
  document.getElementById('th-pairs').textContent = `Pairs: 0/${pairs}`;
  document.getElementById('th-complete').classList.remove('show');

  // Pick random emojis for pairs
  const shuffledEmojis = thEmojis.slice().sort(() => Math.random() - 0.5).slice(0, pairs);
  // Create pairs
  let cardData = [];
  shuffledEmojis.forEach(e => {
    cardData.push(e);
    cardData.push(e);
  });
  // Shuffle
  cardData.sort(() => Math.random() - 0.5);

  const grid = document.getElementById('th-grid');
  grid.style.gridTemplateColumns = `repeat(${cols}, clamp(60px,18vw,85px))`;
  grid.innerHTML = '';

  thCards = cardData.map((emoji, i) => {
    const card = document.createElement('div');
    card.className = 'th-card';
    card.innerHTML = `
      <div class="th-card-inner">
        <div class="th-card-back">üêö</div>
        <div class="th-card-front">${emoji}</div>
      </div>
    `;
    card.dataset.idx = i;
    card.dataset.emoji = emoji;
    card.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      thFlipCard(card, i);
    });
    grid.appendChild(card);
    return { el: card, emoji, idx: i, matched: false };
  });

  // Brief peek ‚Äî show cards for 1.5 seconds then hide
  thCards.forEach(c => c.el.classList.add('flipped'));
  thLocked = true;
  setTimeout(() => {
    thCards.forEach(c => {
      if (!c.matched) c.el.classList.remove('flipped');
    });
    thLocked = false;
  }, 1500);
}

function thFlipCard(cardEl, idx) {
  if (thLocked) return;
  const card = thCards[idx];
  if (!card || card.matched) return;
  if (cardEl.classList.contains('flipped')) return;
  if (thFlipped.length >= 2) return;

  // Flip it
  cardEl.classList.add('flipped');
  thFlipped.push(card);
  playChime();

  if (thFlipped.length === 2) {
    thMoves++;
    document.getElementById('th-moves').textContent = 'Moves: ' + thMoves;
    thLocked = true;

    const [a, b] = thFlipped;

    if (a.emoji === b.emoji) {
      // Match!
      setTimeout(() => {
        a.el.classList.add('matched');
        b.el.classList.add('matched');
        a.matched = true;
        b.matched = true;
        thMatched++;
        document.getElementById('th-pairs').textContent = `Pairs: ${thMatched}/${thTotalPairs}`;

        const rect = a.el.getBoundingClientRect();
        burst(rect.left + rect.width/2, rect.top + rect.height/2, 12);
        const rect2 = b.el.getBoundingClientRect();
        burst(rect2.left + rect2.width/2, rect2.top + rect2.height/2, 12);
        playMagicChime();

        thFlipped = [];
        thLocked = false;

        // Check win
        if (thMatched >= thTotalPairs) {
          setTimeout(thWin, 500);
        }
      }, 400);
    } else {
      // No match ‚Äî flip back
      setTimeout(() => {
        a.el.classList.remove('flipped');
        b.el.classList.remove('flipped');
        thFlipped = [];
        thLocked = false;
      }, 900);
    }
  }
}

function thWin() {
  let earned = 1;
  const {pairs} = thDiffs[thDiff];
  // Bonus for fewer moves
  if (thMoves <= pairs + 2) earned = 3;
  else if (thMoves <= pairs * 2) earned = 2;

  stars += earned;
  localStorage.setItem('shiloh_stars', stars.toString());
  updateStarDisplays();
  document.getElementById('star-treasure').textContent = stars;

  document.getElementById('th-complete-sub').textContent =
    `Found all ${thTotalPairs} pairs in ${thMoves} moves! +${earned} ‚≠ê`;
  document.getElementById('th-complete').classList.add('show');

  showToast(`+${earned} ‚≠ê Great memory, Princess Shiloh!`);
  playMagicChime();
  for (let i = 0; i < 8; i++) {
    setTimeout(() => burst(Math.random() * window.innerWidth, Math.random() * window.innerHeight * 0.6, 16), i * 150);
  }
}


// =============================================
// STORY TIME ‚Äî Interactive Storybook
// =============================================
let sbPage = 0;
let sbPath = ''; // tracks choices

// Story data: each page has illustration SVG, text, optional choices
function getStoryPages() {
  return [
    {
      text: `Once upon a time, <span class="sb-name">Princess Shiloh</span> lived in a beautiful castle high above the clouds. Every night, she loved to watch the <span class="sb-highlight">stars twinkle</span> from her tower window.`,
      scene: drawCastleNight,
    },
    {
      text: `One magical evening, a tiny <span class="sb-highlight">glowing star</span> floated right up to her window! "Hello, Princess!" it whispered. "I've lost my way home. Will you help me?"`,
      scene: drawStarWindow,
    },
    {
      text: `<span class="sb-name">Princess Shiloh</span> smiled bravely. "Of course I'll help!" But how should she travel to the sky?`,
      scene: drawPrincessThinking,
      choices: [
        { label: 'ü¶ã Ride a magical butterfly', goto: 3 },
        { label: 'üßú‚Äç‚ôÄÔ∏è Swim through the star ocean', goto: 4 },
      ]
    },
    {
      text: `A giant <span class="sb-highlight">rainbow butterfly</span> appeared! Its wings shimmered with every color imaginable. <span class="sb-name">Princess Shiloh</span> climbed on and they soared up, up, up through the cotton candy clouds!`,
      scene: drawButterflyRide,
      next: 5,
    },
    {
      text: `The sky turned into a sparkling <span class="sb-highlight">ocean of stars</span>! <span class="sb-name">Princess Shiloh</span> dove in and swam through warm, glowing water. Friendly fish made of starlight swam beside her!`,
      scene: drawStarOcean,
      next: 5,
    },
    {
      text: `High above the world, she found the <span class="sb-highlight">Star Garden</span> ‚Äî a magical place where baby stars grew like flowers! Each one hummed a tiny, beautiful song.`,
      scene: drawStarGarden,
    },
    {
      text: `"There's my family!" cried the little star happily. It zoomed over to a group of stars that all looked just like it ‚Äî but <span class="sb-highlight">bigger and brighter</span>.`,
      scene: drawStarFamily,
    },
    {
      text: `"Thank you, <span class="sb-name">Princess Shiloh</span>!" said the star. "For being so kind, I want to give you a gift." What did the star give her?`,
      scene: drawStarGift,
      choices: [
        { label: 'üëë A crown of starlight', goto: 8 },
        { label: 'üåü A wish that always comes true', goto: 9 },
      ]
    },
    {
      text: `The star placed a beautiful <span class="sb-highlight">crown of pure starlight</span> on her head. It glowed softly and made her feel warm and brave. "Now everyone will know how kind you are!" said the star.`,
      scene: drawCrownScene,
      next: 10,
    },
    {
      text: `"Close your eyes and make a <span class="sb-highlight">wish</span>," said the star. <span class="sb-name">Princess Shiloh</span> wished for everyone in her kingdom to be happy. The whole sky lit up with beautiful colors!`,
      scene: drawWishScene,
      next: 10,
    },
    {
      text: `<span class="sb-name">Princess Shiloh</span> flew back home, her heart full of joy. She looked up at the night sky and saw her little star friend <span class="sb-highlight">twinkling just for her</span>. "Goodnight, star," she whispered. And they both fell fast asleep. ‚ú®üíñ<br><br><em style="color:#ffd54f">The End</em>`,
      scene: drawEnding,
      isEnd: true,
    },
  ];
}

let sbPages = [];

function initStory() {
  sbPages = getStoryPages();
  sbPage = 0;
  sbPath = '';
  renderStoryPage();
}

function renderStoryPage() {
  const page = sbPages[sbPage];
  if (!page) return;

  // Illustration
  const illEl = document.getElementById('sb-illustration');
  const rect = illEl.getBoundingClientRect();
  const w = rect.width || 400;
  const h = rect.height || 250;
  illEl.innerHTML = page.scene(w, h);

  // Text with typing feel
  document.getElementById('sb-text').innerHTML = page.text;

  // Choices
  const choicesEl = document.getElementById('sb-choices');
  if (page.choices) {
    choicesEl.innerHTML = page.choices.map((c, i) =>
      `<div class="sb-choice" onclick="sbChoose(${c.goto})">${c.label}</div>`
    ).join('');
    choicesEl.style.display = 'flex';
  } else {
    choicesEl.innerHTML = '';
    choicesEl.style.display = 'none';
  }

  // Nav
  const navEl = document.getElementById('sb-nav');
  if (page.choices) {
    navEl.style.display = 'none';
  } else if (page.isEnd) {
    navEl.style.display = 'flex';
    navEl.innerHTML = `
      <div class="sb-nav-btn" onclick="sbPrev()">‚Üê Back</div>
      <div class="sb-page-num">${sbPage + 1} / ${sbPages.length}</div>
      <div class="sb-nav-btn primary" onclick="initStory()">üìñ Again!</div>
    `;
  } else {
    navEl.style.display = 'flex';
    navEl.innerHTML = `
      <div class="sb-nav-btn" onclick="sbPrev()">‚Üê Back</div>
      <div class="sb-page-num" id="sb-page-num">${sbPage + 1} / ${sbPages.length}</div>
      <div class="sb-nav-btn primary" onclick="sbNext()">Next ‚Üí</div>
    `;
  }

  // Award star at end
  if (page.isEnd) {
    stars += 2;
    localStorage.setItem('shiloh_stars', stars.toString());
    updateStarDisplays();
    showToast('+2 ‚≠ê Beautiful story, Princess Shiloh!');
    playMagicChime();
    setTimeout(() => {
      for (let i = 0; i < 5; i++) {
        setTimeout(() => burst(Math.random()*window.innerWidth, Math.random()*window.innerHeight*0.5, 14), i*200);
      }
    }, 500);
  }

  playChime();
}

function sbNext() {
  const page = sbPages[sbPage];
  const nextIdx = page.next !== undefined ? page.next : sbPage + 1;
  if (nextIdx < sbPages.length) {
    sbPage = nextIdx;
    renderStoryPage();
  }
}

function sbPrev() {
  if (sbPage > 0) {
    sbPage--;
    renderStoryPage();
  }
}

function sbChoose(goto) {
  sbPage = goto;
  renderStoryPage();
  burst(window.innerWidth/2, window.innerHeight/2, 15);
}

// ===== ILLUSTRATION GENERATORS =====
function drawCastleNight(w, h) {
  return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <rect width="${w}" height="${h}" fill="#0d1b3e"/>
    <circle cx="${w*.82}" cy="${h*.18}" r="${h*.08}" fill="#fff9c4" opacity=".7"/>
    ${Array.from({length:25},()=>`<circle cx="${w*Math.random()}" cy="${h*Math.random()*.6}" r="${1+Math.random()*2}" fill="white" opacity="${.3+Math.random()*.5}"/>`).join('')}
    <rect x="${w*.25}" y="${h*.35}" width="${w*.5}" height="${h*.65}" fill="#4a1a6b" rx="4"/>
    <rect x="${w*.15}" y="${h*.25}" width="${w*.12}" height="${h*.75}" fill="#4a1a6b" rx="3"/>
    <polygon points="${w*.14},${h*.25} ${w*.21},${h*.1} ${w*.28},${h*.25}" fill="#7b1fa2"/>
    <rect x="${w*.73}" y="${h*.25}" width="${w*.12}" height="${h*.75}" fill="#4a1a6b" rx="3"/>
    <polygon points="${w*.72},${h*.25} ${w*.79},${h*.1} ${w*.86},${h*.25}" fill="#7b1fa2"/>
    <rect x="${w*.42}" y="${h*.2}" width="${w*.16}" height="${h*.8}" fill="#4a1a6b" rx="3"/>
    <polygon points="${w*.41},${h*.2} ${w*.5},${h*.05} ${w*.59},${h*.2}" fill="#7b1fa2"/>
    <rect x="${w*.46}" y="${h*.72}" width="${w*.08}" height="${h*.28}" rx="${w*.04}" fill="#2d1052"/>
    <circle cx="${w*.5}" cy="${h*.42}" r="${h*.04}" fill="#ffd54f" opacity=".6"/>
    <rect x="${w*.18}" y="${h*.5}" width="${w*.06}" height="${h*.08}" rx="2" fill="#ffd54f" opacity=".4"/>
    <rect x="${w*.76}" y="${h*.5}" width="${w*.06}" height="${h*.08}" rx="2" fill="#ffd54f" opacity=".4"/>
  </svg>`;
}

function drawStarWindow(w, h) {
  return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <rect width="${w}" height="${h}" fill="#1a0a2e"/>
    <rect x="${w*.05}" y="${h*.05}" width="${w*.9}" height="${h*.9}" rx="8" fill="#2d1052"/>
    <path d="M${w*.2},${h*.1} Q${w*.2},${h*.05} ${w*.5},${h*.05} Q${w*.8},${h*.05} ${w*.8},${h*.1} L${w*.8},${h*.9} L${w*.2},${h*.9}Z" fill="#0d1b3e"/>
    <line x1="${w*.5}" y1="${h*.05}" x2="${w*.5}" y2="${h*.9}" stroke="#4a1a6b" stroke-width="3"/>
    <line x1="${w*.2}" y1="${h*.5}" x2="${w*.8}" y2="${h*.5}" stroke="#4a1a6b" stroke-width="3"/>
    ${Array.from({length:12},()=>`<circle cx="${w*(.25+Math.random()*.5)}" cy="${h*(.1+Math.random()*.35)}" r="${1+Math.random()*1.5}" fill="white" opacity="${.4+Math.random()*.4}"/>`).join('')}
    <circle cx="${w*.55}" cy="${h*.35}" r="${h*.06}" fill="#ffd54f" opacity=".9">
      <animate attributeName="opacity" values=".7;1;.7" dur="1.5s" repeatCount="indefinite"/>
    </circle>
    <circle cx="${w*.55}" cy="${h*.35}" r="${h*.09}" fill="none" stroke="#ffd54f" stroke-width="1" opacity=".3">
      <animate attributeName="r" values="${h*.09};${h*.13};${h*.09}" dur="2s" repeatCount="indefinite"/>
    </circle>
    <ellipse cx="${w*.4}" cy="${h*.78}" rx="${w*.06}" ry="${h*.04}" fill="#fdd9b5"/>
    <path d="M${w*.35},${h*.7} Q${w*.35},${h*.6} ${w*.4},${h*.58} Q${w*.45},${h*.6} ${w*.45},${h*.7}" fill="#6d4c41"/>
    <path d="M${w*.35},${h*.78} Q${w*.4},${h*.76} ${w*.45},${h*.78} L${w*.46},${h*.85} Q${w*.4},${h*.86} ${w*.34},${h*.85}Z" fill="#f48fb1"/>
  </svg>`;
}

function drawPrincessThinking(w, h) {
  return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <rect width="${w}" height="${h}" fill="#1a0a2e"/>
    <rect y="${h*.75}" width="${w}" height="${h*.25}" fill="#2d1052"/>
    ${Array.from({length:15},()=>`<circle cx="${w*Math.random()}" cy="${h*Math.random()*.7}" r="${1+Math.random()*2}" fill="white" opacity="${.3+Math.random()*.4}"/>`).join('')}
    <ellipse cx="${w*.5}" cy="${h*.52}" rx="${w*.06}" ry="${h*.065}" fill="#fdd9b5"/>
    <path d="M${w*.44},${h*.47} Q${w*.44},${h*.35} ${w*.5},${h*.33} Q${w*.56},${h*.35} ${w*.56},${h*.47}" fill="#6d4c41"/>
    <ellipse cx="${w*.48}" cy="${h*.51}" rx="${w*.012}" ry="${h*.01}" fill="#5d4037"/>
    <ellipse cx="${w*.52}" cy="${h*.51}" rx="${w*.012}" ry="${h*.01}" fill="#5d4037"/>
    <path d="M${w*.48},${h*.56} Q${w*.5},${h*.575} ${w*.52},${h*.56}" fill="none" stroke="#e57373" stroke-width="1.5" stroke-linecap="round"/>
    <path d="M${w*.44},${h*.6} Q${w*.5},${h*.59} ${w*.56},${h*.6} L${w*.58},${h*.66} Q${w*.5},${h*.67} ${w*.42},${h*.66}Z" fill="#f48fb1"/>
    <path d="M${w*.42},${h*.65} Q${w*.36},${h*.72} ${w*.32},${h*.80} Q${w*.5},${h*.83} ${w*.68},${h*.80} Q${w*.64},${h*.72} ${w*.58},${h*.65}" fill="#f48fb1"/>
    <circle cx="${w*.62}" cy="${h*.40}" r="${h*.02}" fill="#ffd54f" opacity=".5"/>
    <circle cx="${w*.66}" cy="${h*.36}" r="${h*.015}" fill="#ffd54f" opacity=".4"/>
    <circle cx="${w*.69}" cy="${h*.31}" r="${h*.012}" fill="#ffd54f" opacity=".3"/>
  </svg>`;
}

function drawButterflyRide(w, h) {
  return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <rect width="${w}" height="${h}" fill="url(#skyGrad)"/>
    <defs><linearGradient id="skyGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1a237e"/><stop offset="50%" stop-color="#7b1fa2"/><stop offset="100%" stop-color="#f48fb1"/></linearGradient></defs>
    ${Array.from({length:10},()=>`<circle cx="${w*Math.random()}" cy="${h*Math.random()*.5}" r="${1+Math.random()*2}" fill="white" opacity="${.3+Math.random()*.5}"/>`).join('')}
    <ellipse cx="${w*.3}" cy="${h*.75}" rx="${w*.2}" ry="${h*.12}" fill="white" opacity=".2"/>
    <ellipse cx="${w*.7}" cy="${h*.65}" rx="${w*.15}" ry="${h*.08}" fill="white" opacity=".15"/>
    <path d="M${w*.5},${h*.5} Q${w*.3},${h*.25} ${w*.2},${h*.35} Q${w*.15},${h*.5} ${w*.35},${h*.5}" fill="#ce93d8" opacity=".7"/>
    <path d="M${w*.5},${h*.5} Q${w*.7},${h*.25} ${w*.8},${h*.35} Q${w*.85},${h*.5} ${w*.65},${h*.5}" fill="#f48fb1" opacity=".7"/>
    <path d="M${w*.5},${h*.5} Q${w*.35},${h*.6} ${w*.3},${h*.7} Q${w*.4},${h*.65} ${w*.48},${h*.55}" fill="#81d4fa" opacity=".6"/>
    <path d="M${w*.5},${h*.5} Q${w*.65},${h*.6} ${w*.7},${h*.7} Q${w*.6},${h*.65} ${w*.52},${h*.55}" fill="#ffd54f" opacity=".6"/>
    <ellipse cx="${w*.5}" cy="${h*.5}" rx="${w*.02}" ry="${h*.06}" fill="#6d4c41"/>
    <circle cx="${w*.5}" cy="${h*.5}" r="${h*.025}" fill="#fdd9b5"/>
    <path d="M${w*.49},${h*.49} Q${w*.485},${h*.46} ${w*.5},${h*.45} Q${w*.515},${h*.46} ${w*.51},${h*.49}" fill="#6d4c41" opacity=".7"/>
  </svg>`;
}

function drawStarOcean(w, h) {
  return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <rect width="${w}" height="${h}" fill="#0d1b3e"/>
    <rect width="${w}" height="${h}" fill="url(#oceanGrad)" opacity=".5"/>
    <defs><linearGradient id="oceanGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1a237e"/><stop offset="100%" stop-color="#4dd0e1"/></linearGradient></defs>
    ${Array.from({length:30},(_, i)=>`<circle cx="${w*Math.random()}" cy="${h*Math.random()}" r="${2+Math.random()*4}" fill="#ffd54f" opacity="${.15+Math.random()*.4}"/>`).join('')}
    <ellipse cx="${w*.5}" cy="${h*.5}" rx="${w*.05}" ry="${h*.055}" fill="#fdd9b5"/>
    <path d="M${w*.45},${h*.46} Q${w*.45},${h*.38} ${w*.5},${h*.36} Q${w*.55},${h*.38} ${w*.55},${h*.46}" fill="#6d4c41"/>
    <path d="M${w*.45},${h*.54} Q${w*.5},${h*.53} ${w*.55},${h*.54} L${w*.56},${h*.6} Q${w*.5},${h*.61} ${w*.44},${h*.6}Z" fill="#ce93d8"/>
    <path d="M${w*.44},${h*.59} Q${w*.42},${h*.66} ${w*.40},${h*.72} Q${w*.5},${h*.74} ${w*.60},${h*.72} Q${w*.58},${h*.66} ${w*.56},${h*.59}" fill="#4dd0e1" opacity=".7"/>
    <ellipse cx="${w*.25}" cy="${h*.4}" rx="${w*.025}" ry="${h*.015}" fill="#ffd54f" opacity=".5"/>
    <ellipse cx="${w*.75}" cy="${h*.6}" rx="${w*.02}" ry="${h*.012}" fill="#ffd54f" opacity=".4"/>
    <ellipse cx="${w*.65}" cy="${h*.3}" rx="${w*.018}" ry="${h*.01}" fill="#ffd54f" opacity=".3"/>
  </svg>`;
}

function drawStarGarden(w, h) {
  return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <rect width="${w}" height="${h}" fill="#0d1b3e"/>
    <rect y="${h*.7}" width="${w}" height="${h*.3}" fill="#1a237e" opacity=".5"/>
    ${Array.from({length:8},(_, i)=>{
      const x = w*(.1+i*.11), y = h*(.5+Math.random()*.2);
      return `<line x1="${x}" y1="${h*.7}" x2="${x}" y2="${y}" stroke="#66bb6a" stroke-width="2" opacity=".4"/>
        <circle cx="${x}" cy="${y}" r="${4+Math.random()*6}" fill="#ffd54f" opacity="${.5+Math.random()*.4}">
        <animate attributeName="opacity" values="${.4+Math.random()*.3};${.7+Math.random()*.3};${.4+Math.random()*.3}" dur="${2+Math.random()*2}s" repeatCount="indefinite"/>
        </circle>`;
    }).join('')}
    ${Array.from({length:12},()=>`<circle cx="${w*Math.random()}" cy="${h*Math.random()*.45}" r="${1+Math.random()*1.5}" fill="white" opacity="${.3+Math.random()*.4}"/>`).join('')}
  </svg>`;
}

function drawStarFamily(w, h) {
  return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <rect width="${w}" height="${h}" fill="#0d1b3e"/>
    ${Array.from({length:10},()=>`<circle cx="${w*Math.random()}" cy="${h*Math.random()}" r="${1+Math.random()*1.5}" fill="white" opacity="${.2+Math.random()*.3}"/>`).join('')}
    <circle cx="${w*.5}" cy="${h*.35}" r="${h*.1}" fill="#ffd54f" opacity=".7"/>
    <circle cx="${w*.5}" cy="${h*.35}" r="${h*.14}" fill="none" stroke="#ffd54f" stroke-width="1.5" opacity=".3"/>
    <circle cx="${w*.32}" cy="${h*.28}" r="${h*.06}" fill="#ffd54f" opacity=".5"/>
    <circle cx="${w*.68}" cy="${h*.28}" r="${h*.06}" fill="#ffd54f" opacity=".5"/>
    <circle cx="${w*.25}" cy="${h*.45}" r="${h*.05}" fill="#ffd54f" opacity=".4"/>
    <circle cx="${w*.75}" cy="${h*.45}" r="${h*.05}" fill="#ffd54f" opacity=".4"/>
    <circle cx="${w*.5}" cy="${h*.6}" r="${h*.035}" fill="#ffd54f" opacity=".8">
      <animate attributeName="opacity" values=".6;1;.6" dur="1.5s" repeatCount="indefinite"/>
    </circle>
    <text x="${w*.5}" y="${h*.63}" text-anchor="middle" font-size="8" fill="#4a3728">‚ò∫</text>
  </svg>`;
}

function drawStarGift(w, h) {
  return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <rect width="${w}" height="${h}" fill="#0d1b3e"/>
    ${Array.from({length:15},()=>`<circle cx="${w*Math.random()}" cy="${h*Math.random()}" r="${1+Math.random()*2}" fill="white" opacity="${.2+Math.random()*.4}"/>`).join('')}
    <circle cx="${w*.5}" cy="${h*.3}" r="${h*.07}" fill="#ffd54f" opacity=".8">
      <animate attributeName="r" values="${h*.07};${h*.09};${h*.07}" dur="2s" repeatCount="indefinite"/>
    </circle>
    <ellipse cx="${w*.5}" cy="${h*.65}" rx="${w*.06}" ry="${h*.06}" fill="#fdd9b5"/>
    <path d="M${w*.44},${h*.60} Q${w*.44},${h*.51} ${w*.5},${h*.49} Q${w*.56},${h*.51} ${w*.56},${h*.60}" fill="#6d4c41"/>
    <path d="M${w*.48},${h*.64} Q${w*.5},${h*.655} ${w*.52},${h*.64}" fill="none" stroke="#e57373" stroke-width="1.5" stroke-linecap="round"/>
    <path d="M${w*.44},${h*.72} Q${w*.5},${h*.71} ${w*.56},${h*.72} L${w*.58},${h*.82} Q${w*.5},${h*.84} ${w*.42},${h*.82}Z" fill="#f48fb1"/>
    <line x1="${w*.5}" y1="${h*.45}" x2="${w*.5}" y2="${h*.55}" stroke="#ffd54f" stroke-width="2" opacity=".5" stroke-dasharray="3 3"/>
  </svg>`;
}

function drawCrownScene(w, h) {
  return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <rect width="${w}" height="${h}" fill="#0d1b3e"/>
    ${Array.from({length:20},()=>`<circle cx="${w*Math.random()}" cy="${h*Math.random()}" r="${1+Math.random()*2}" fill="white" opacity="${.2+Math.random()*.4}"/>`).join('')}
    <ellipse cx="${w*.5}" cy="${h*.55}" rx="${w*.065}" ry="${h*.065}" fill="#fdd9b5"/>
    <path d="M${w*.435},${h*.50} Q${w*.435},${h*.40} ${w*.5},${h*.38} Q${w*.565},${h*.40} ${w*.565},${h*.50}" fill="#6d4c41"/>
    <path d="M${w*.46},${h*.36} L${w*.47},${h*.30} L${w*.48},${h*.34} L${w*.5},${h*.27} L${w*.52},${h*.34} L${w*.53},${h*.30} L${w*.54},${h*.36}" fill="#ffd54f" stroke="#f9a825" stroke-width="1.5"/>
    <circle cx="${w*.5}" cy="${h*.285}" r="${h*.012}" fill="#e91e8c"/>
    <circle cx="${w*.5}" cy="${h*.36}" r="${h*.14}" fill="none" stroke="#ffd54f" stroke-width="1" opacity=".3">
      <animate attributeName="r" values="${h*.14};${h*.2};${h*.14}" dur="3s" repeatCount="indefinite"/>
      <animate attributeName="opacity" values=".3;.1;.3" dur="3s" repeatCount="indefinite"/>
    </circle>
    <path d="M${w*.48},${h*.58} Q${w*.5},${h*.59} ${w*.52},${h*.58}" fill="none" stroke="#e57373" stroke-width="1.5" stroke-linecap="round"/>
    <path d="M${w*.44},${h*.64} Q${w*.5},${h*.63} ${w*.56},${h*.64} L${w*.58},${h*.78} Q${w*.5},${h*.80} ${w*.42},${h*.78}Z" fill="#f48fb1"/>
  </svg>`;
}

function drawWishScene(w, h) {
  return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <rect width="${w}" height="${h}" fill="#0d1b3e"/>
    <defs><radialGradient id="wishGlow" cx="50%" cy="50%"><stop offset="0%" stop-color="#ffd54f" stop-opacity=".3"/><stop offset="100%" stop-color="transparent"/></radialGradient></defs>
    <circle cx="${w*.5}" cy="${h*.45}" r="${h*.4}" fill="url(#wishGlow)"/>
    ${['#ef5350','#ff9800','#ffd54f','#66bb6a','#42a5f5','#ab47bc','#f48fb1'].map((c,i) =>
      `<path d="M${w*(.15+i*.1)},${h*.9} Q${w*(.25+i*.08)},${h*(.3+Math.random()*.2)} ${w*(.35+i*.06)},${h*.15}" fill="none" stroke="${c}" stroke-width="3" opacity=".4"/>`
    ).join('')}
    ${Array.from({length:25},()=>`<circle cx="${w*Math.random()}" cy="${h*Math.random()}" r="${2+Math.random()*4}" fill="#ffd54f" opacity="${.2+Math.random()*.5}">
      <animate attributeName="opacity" values="${.1+Math.random()*.3};${.5+Math.random()*.4};${.1+Math.random()*.3}" dur="${2+Math.random()*3}s" repeatCount="indefinite"/>
    </circle>`).join('')}
    <ellipse cx="${w*.5}" cy="${h*.6}" rx="${w*.04}" ry="${h*.045}" fill="#fdd9b5"/>
    <path d="M${w*.47},${h*.57} Q${w*.47},${h*.52} ${w*.5},${h*.51} Q${w*.53},${h*.52} ${w*.53},${h*.57}" fill="#6d4c41"/>
    <path d="M${w*.45},${h*.66} Q${w*.5},${h*.65} ${w*.55},${h*.66} L${w*.56},${h*.76} Q${w*.5},${h*.78} ${w*.44},${h*.76}Z" fill="#f48fb1"/>
  </svg>`;
}

function drawEnding(w, h) {
  return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <rect width="${w}" height="${h}" fill="#0d1b3e"/>
    <circle cx="${w*.8}" cy="${h*.15}" r="${h*.07}" fill="#fff9c4" opacity=".6"/>
    ${Array.from({length:30},()=>`<circle cx="${w*Math.random()}" cy="${h*Math.random()*.65}" r="${1+Math.random()*2}" fill="white" opacity="${.2+Math.random()*.5}"/>`).join('')}
    <rect x="${w*.3}" y="${h*.5}" width="${w*.4}" height="${h*.5}" fill="#4a1a6b" rx="4"/>
    <polygon points="${w*.35},${h*.5} ${w*.5},${h*.35} ${w*.65},${h*.5}" fill="#7b1fa2"/>
    <rect x="${w*.46}" y="${h*.75}" width="${w*.08}" height="${h*.25}" rx="${w*.04}" fill="#2d1052"/>
    <circle cx="${w*.5}" cy="${h*.58}" r="${h*.03}" fill="#ffd54f" opacity=".4"/>
    <circle cx="${w*.5}" cy="${h*.25}" r="${h*.025}" fill="#ffd54f" opacity=".8">
      <animate attributeName="opacity" values=".5;1;.5" dur="2s" repeatCount="indefinite"/>
    </circle>
    <line x1="${w*.5}" y1="${h*.25}" x2="${w*.5}" y2="${h*.35}" stroke="#ffd54f" stroke-width="1" opacity=".3" stroke-dasharray="2 3"/>
    <text x="${w*.5}" y="${h*.95}" text-anchor="middle" font-family="Dancing Script,cursive" font-size="${h*.06}" fill="#ffd54f" opacity=".6">The End ‚ú®</text>
  </svg>`;
}


// =============================================
// ROYAL TEA PARTY
// =============================================
let tpPhase = 0; // 0=treats, 1=cups, 2=pour, 3=done
let tpSelected = null;
let tpPlates = [];
let tpServed = 0;

const tpGuests = [
  { name:'Bunny', emoji:'üê∞', x:'15%', y:'-18%', plateX:'12%', plateY:'25%' },
  { name:'Teddy', emoji:'üß∏', x:'75%', y:'-18%', plateX:'68%', plateY:'25%' },
  { name:'Kitty', emoji:'üê±', x:'-5%', y:'50%', plateX:'8%', plateY:'58%' },
  { name:'Shiloh', emoji:'üë∏', x:'85%', y:'50%', plateX:'72%', plateY:'58%' },
];

const tpTreats = ['üßÅ','üç∞','üç™','üç©','üéÇ','üçì','üç´','üç¨'];
const tpCups = ['üçµ','‚òï','ü•§','üßÉ'];
const tpDecorations = ['üå∏','üå∑','üåπ','üíê','üéÄ','‚ú®'];

function initTea() {
  tpPhase = 0;
  tpSelected = null;
  tpServed = 0;
  document.getElementById('star-tea').textContent = stars;

  const table = document.getElementById('tp-table');
  // Clear old plates/guests
  table.querySelectorAll('.tp-plate,.tp-guest').forEach(e => e.remove());
  document.getElementById('tp-msg').classList.remove('show');
  document.getElementById('tp-msg').textContent = '';

  // Add guests around table
  tpGuests.forEach((g, i) => {
    const guest = document.createElement('div');
    guest.className = 'tp-guest';
    guest.id = 'tp-guest-' + i;
    guest.style.left = g.x;
    guest.style.top = g.y;
    guest.innerHTML = `<span class="tp-guest-emoji">${g.emoji}</span><div class="tp-guest-name">${g.name}</div>`;
    table.appendChild(guest);

    const plate = document.createElement('div');
    plate.className = 'tp-plate';
    plate.id = 'tp-plate-' + i;
    plate.style.left = g.plateX;
    plate.style.top = g.plateY;
    plate.dataset.idx = i;
    plate.dataset.treat = '';
    plate.dataset.cup = '';
    plate.addEventListener('pointerdown', () => tpPlaceTreat(i));
    table.appendChild(plate);
  });

  tpPlates = [0,1,2,3].map(i => ({treat:'', cup:''}));
  loadTpPhase();
}

function loadTpPhase() {
  const label = document.getElementById('tp-section-label');
  const items = document.getElementById('tp-items');

  if (tpPhase === 0) {
    label.textContent = 'üßÅ Pick treats for each plate';
    items.innerHTML = tpTreats.map(t =>
      `<div class="tp-item" onclick="tpSelectItem('${t}',this)">${t}</div>`
    ).join('');
  } else if (tpPhase === 1) {
    label.textContent = 'üçµ Pick cups for each plate';
    items.innerHTML = tpCups.map(c =>
      `<div class="tp-item" onclick="tpSelectItem('${c}',this)">${c}</div>`
    ).join('');
  } else if (tpPhase === 2) {
    label.textContent = 'ü´ñ Tap the teapot to pour tea!';
    items.innerHTML = tpDecorations.map(d =>
      `<div class="tp-item" onclick="tpSelectItem('${d}',this)">${d}</div>`
    ).join('');
    // Also allow placing decorations on plates
  } else if (tpPhase === 3) {
    label.textContent = 'üéâ Tea party complete!';
    items.innerHTML = '';
  }
}

function tpSelectItem(item, el) {
  tpSelected = item;
  document.querySelectorAll('.tp-item').forEach(i => i.classList.remove('selected'));
  if (el) el.classList.add('selected');
  playChime();
}

function tpPlaceTreat(plateIdx) {
  if (!tpSelected) {
    tpShowMsg('Pick something first! üëÜ');
    return;
  }

  const plate = document.getElementById('tp-plate-' + plateIdx);
  const data = tpPlates[plateIdx];

  if (tpPhase === 0) {
    data.treat = tpSelected;
    plate.textContent = tpSelected;
    plate.classList.add('filled');
    playMagicChime();
    const r = plate.getBoundingClientRect();
    burst(r.left + r.width/2, r.top + r.height/2, 10);

    // Bounce the guest
    const guest = document.getElementById('tp-guest-' + plateIdx);
    guest.classList.remove('happy');
    void guest.offsetWidth;
    guest.classList.add('happy');

    // Check if all have treats
    if (tpPlates.every(p => p.treat)) {
      setTimeout(() => {
        tpPhase = 1;
        tpSelected = null;
        loadTpPhase();
        tpShowMsg('Now pick cups! üçµ');
      }, 600);
    }
  } else if (tpPhase === 1) {
    data.cup = tpSelected;
    // Show both treat and cup
    plate.innerHTML = `<div style="font-size:0.7em;line-height:1.3">${data.treat}<br>${tpSelected}</div>`;
    plate.classList.add('filled');
    playMagicChime();
    const r = plate.getBoundingClientRect();
    burst(r.left + r.width/2, r.top + r.height/2, 10);

    const guest = document.getElementById('tp-guest-' + plateIdx);
    guest.classList.remove('happy');
    void guest.offsetWidth;
    guest.classList.add('happy');

    if (tpPlates.every(p => p.cup)) {
      setTimeout(() => {
        tpPhase = 2;
        tpSelected = null;
        loadTpPhase();
        tpShowMsg('Tap ü´ñ to pour tea!');
      }, 600);
    }
  } else if (tpPhase === 2) {
    // Add decoration
    if (tpSelected) {
      plate.innerHTML += `<span style="font-size:0.5em;position:absolute;top:-4px;right:-4px">${tpSelected}</span>`;
      playChime();
      const r = plate.getBoundingClientRect();
      burst(r.left + r.width/2, r.top + r.height/2, 6);
    }
  }
}

function tpPourTea() {
  if (tpPhase < 2) {
    tpShowMsg('Set the table first! üçΩÔ∏è');
    return;
  }

  tpServed++;
  const teapot = document.getElementById('tp-teapot');
  teapot.style.transform = 'translate(-50%,-50%) rotate(-30deg) scale(1.1)';
  setTimeout(() => {
    teapot.style.transform = 'translate(-50%,-50%) rotate(0deg) scale(1)';
  }, 300);

  playMagicChime();
  burstCenter(20);

  if (tpServed >= 3) {
    // Tea party complete!
    tpPhase = 3;
    loadTpPhase();

    // All guests bounce happy
    tpGuests.forEach((_, i) => {
      const g = document.getElementById('tp-guest-' + i);
      setTimeout(() => {
        g.classList.remove('happy');
        void g.offsetWidth;
        g.classList.add('happy');
      }, i * 200);
    });

    setTimeout(() => {
      tpShowMsg('üéâ Perfect tea party! üéâ');
      stars += 2;
      localStorage.setItem('shiloh_stars', stars.toString());
      updateStarDisplays();
      document.getElementById('star-tea').textContent = stars;
      showToast('+2 ‚≠ê Lovely tea party, Princess Shiloh!');
      for (let i = 0; i < 6; i++) {
        setTimeout(() => burst(Math.random()*window.innerWidth, Math.random()*window.innerHeight*0.6, 16), i*180);
      }
    }, 800);

    // Show play again after delay
    setTimeout(() => {
      const items = document.getElementById('tp-items');
      items.innerHTML = `<div class="tp-item" onclick="initTea()" style="width:auto;padding:0 18px;font-size:14px;font-weight:700;color:var(--purple-deep)">ü´ñ New Party!</div>`;
    }, 2000);
  } else {
    tpShowMsg(`Pouring tea... ${3 - tpServed} more pours! ü´ñ`);
  }
}

function tpShowMsg(text) {
  const msg = document.getElementById('tp-msg');
  msg.textContent = text;
  msg.classList.add('show');
  setTimeout(() => msg.classList.remove('show'), 2000);
}

// =============================================
// MERMAID DRESS-UP
// =============================================
let mdTab = 0;
let mdChoices = { hair:0, top:0, tail:0, accessory:0, friend:0 };

const mdCategories = [
  { name:'Hair', key:'hair', items:[
    {label:'üü§', color:'#6d4c41'},
    {label:'üü°', color:'#ffd54f'},
    {label:'üî¥', color:'#ef5350'},
    {label:'üü£', color:'#ab47bc'},
    {label:'ü©µ', color:'#4dd0e1'},
    {label:'ü©∑', color:'#f48fb1'},
  ]},
  { name:'Top', key:'top', items:[
    {label:'üêö', color:'#f48fb1', type:'shells'},
    {label:'‚≠ê', color:'#ffd54f', type:'starfish'},
    {label:'üíé', color:'#ce93d8', type:'gem'},
    {label:'üå∏', color:'#ef9a9a', type:'flower'},
    {label:'üíô', color:'#81d4fa', type:'blue'},
  ]},
  { name:'Tail', key:'tail', items:[
    {label:'üíö', color:'#66bb6a'},
    {label:'üíú', color:'#ce93d8'},
    {label:'üíô', color:'#42a5f5'},
    {label:'ü©∑', color:'#f48fb1'},
    {label:'üß°', color:'#ff9800'},
    {label:'üíõ', color:'#ffd54f'},
  ]},
  { name:'Extras', key:'accessory', items:[
    {label:'üëë', type:'crown'},
    {label:'üå∏', type:'flower'},
    {label:'‚≠ê', type:'starband'},
    {label:'üéÄ', type:'bow'},
    {label:'‚ùå', type:'none'},
  ]},
  { name:'Friend', key:'friend', items:[
    {label:'üê†', type:'fish'},
    {label:'üê¨', type:'dolphin'},
    {label:'üê¢', type:'turtle'},
    {label:'ü¶Ä', type:'crab'},
    {label:'‚ùå', type:'none'},
  ]},
];

function initMermaid() {
  document.getElementById('star-mermaid').textContent = stars;
  mdTab = 0;
  renderMdTabs();
  renderMdOptions();
  renderMermaid();
}

function renderMdTabs() {
  document.getElementById('md-tabs').innerHTML = mdCategories.map((c, i) =>
    `<div class="md-tab ${i===mdTab?'act':''}" onclick="mdSelectTab(${i})">${c.name}</div>`
  ).join('');
}

function mdSelectTab(i) {
  mdTab = i;
  renderMdTabs();
  renderMdOptions();
  playChime();
}

function renderMdOptions() {
  const cat = mdCategories[mdTab];
  document.getElementById('md-options').innerHTML = cat.items.map((item, i) =>
    `<div class="md-opt ${mdChoices[cat.key]===i?'act':''}" onclick="mdSelect('${cat.key}',${i})">${item.label}</div>`
  ).join('');
}

function mdSelect(key, idx) {
  mdChoices[key] = idx;
  renderMdOptions();
  renderMermaid();
  playMagicChime();
  burstCenter(12);
}

function renderMermaid() {
  const hair = mdCategories[0].items[mdChoices.hair];
  const top = mdCategories[1].items[mdChoices.top];
  const tail = mdCategories[2].items[mdChoices.tail];
  const acc = mdCategories[3].items[mdChoices.accessory];
  const friend = mdCategories[4].items[mdChoices.friend];

  const w = 300, h = 440;
  const hc = hair.color;
  const tc = top.color;
  const tlc = tail.color;

  // Lighter version of tail color
  const tlcLight = tlc + '88';

  let accessorySvg = '';
  if (acc.type === 'crown') {
    accessorySvg = `<path d="M${w*.38},${h*.12} L${w*.40},${h*.07} L${w*.44},${h*.10} L${w*.50},${h*.05} L${w*.56},${h*.10} L${w*.60},${h*.07} L${w*.62},${h*.12}" fill="#ffd54f" stroke="#f9a825" stroke-width="1.5"/><circle cx="${w*.50}" cy="${h*.065}" r="3" fill="#e91e8c"/>`;
  } else if (acc.type === 'flower') {
    accessorySvg = `<circle cx="${w*.35}" cy="${h*.15}" r="8" fill="#f48fb1"/><circle cx="${w*.35}" cy="${h*.15}" r="4" fill="#ffd54f"/>`;
  } else if (acc.type === 'starband') {
    accessorySvg = `<path d="M${w*.34},${h*.14} Q${w*.50},${h*.11} ${w*.66},${h*.14}" fill="none" stroke="#ffd54f" stroke-width="2.5"/><circle cx="${w*.50}" cy="${h*.12}" r="4" fill="#ffd54f"/>`;
  } else if (acc.type === 'bow') {
    accessorySvg = `<path d="M${w*.36},${h*.14} Q${w*.30},${h*.10} ${w*.34},${h*.14} Q${w*.36},${h*.10} ${w*.40},${h*.14}" fill="#f48fb1" stroke="#e91e8c" stroke-width="0.8"/><circle cx="${w*.37}" cy="${h*.14}" r="2" fill="#e91e8c"/>`;
  }

  let friendSvg = '';
  if (friend.type === 'fish') {
    friendSvg = `<ellipse cx="${w*.82}" cy="${h*.42}" rx="18" ry="10" fill="#ff9800" opacity=".7"/><polygon points="${w*.82+18},${h*.42} ${w*.82+28},${h*.42-8} ${w*.82+28},${h*.42+8}" fill="#ff9800" opacity=".6"/><circle cx="${w*.82-5}" cy="${h*.42-2}" r="2" fill="#5d4037"/>`;
  } else if (friend.type === 'dolphin') {
    friendSvg = `<ellipse cx="${w*.80}" cy="${h*.38}" rx="22" ry="10" fill="#90caf9" opacity=".7"/><path d="M${w*.80+20},${h*.38} Q${w*.80+30},${h*.38-12} ${w*.80+25},${h*.38-5}" fill="#90caf9" opacity=".6"/><circle cx="${w*.80-8}" cy="${h*.38-2}" r="2" fill="#5d4037"/>`;
  } else if (friend.type === 'turtle') {
    friendSvg = `<ellipse cx="${w*.82}" cy="${h*.45}" rx="16" ry="12" fill="#81c784" opacity=".7"/><ellipse cx="${w*.82}" cy="${h*.45}" rx="12" ry="9" fill="#66bb6a" opacity=".8"/><circle cx="${w*.82-8}" cy="${h*.45-4}" r="2.5" fill="#fdd9b5"/><circle cx="${w*.82-7}" cy="${h*.45-5}" r="1" fill="#5d4037"/>`;
  } else if (friend.type === 'crab') {
    friendSvg = `<ellipse cx="${w*.82}" cy="${h*.50}" rx="14" ry="10" fill="#ef5350" opacity=".7"/><circle cx="${w*.82-5}" cy="${h*.50-3}" r="1.5" fill="#5d4037"/><circle cx="${w*.82+5}" cy="${h*.50-3}" r="1.5" fill="#5d4037"/><line x1="${w*.82-14}" y1="${h*.50}" x2="${w*.82-20}" y2="${h*.50-6}" stroke="#ef5350" stroke-width="2.5" stroke-linecap="round"/><line x1="${w*.82+14}" y1="${h*.50}" x2="${w*.82+20}" y2="${h*.50-6}" stroke="#ef5350" stroke-width="2.5" stroke-linecap="round"/>`;
  }

  const svg = `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <!-- Hair back -->
    <path d="M${w*.38},${h*.18} Q${w*.30},${h*.28} ${w*.28},${h*.42} Q${w*.26},${h*.52} ${w*.32},${h*.48} Q${w*.36},${h*.35} ${w*.40},${h*.25}" fill="${hc}" opacity=".6"/>
    <path d="M${w*.62},${h*.18} Q${w*.70},${h*.28} ${w*.72},${h*.42} Q${w*.74},${h*.52} ${w*.68},${h*.48} Q${w*.64},${h*.35} ${w*.60},${h*.25}" fill="${hc}" opacity=".6"/>

    <!-- Body -->
    <ellipse cx="${w*.50}" cy="${h*.26}" rx="${w*.10}" ry="${h*.065}" fill="#fdd9b5"/>

    <!-- Eyes -->
    <ellipse cx="${w*.46}" cy="${h*.25}" rx="6" ry="5" fill="white"/>
    <circle cx="${w*.465}" cy="${h*.25}" r="3.5" fill="#5d4037"/>
    <circle cx="${w*.47}" cy="${h*.245}" r="1.2" fill="white"/>
    <ellipse cx="${w*.54}" cy="${h*.25}" rx="6" ry="5" fill="white"/>
    <circle cx="${w*.535}" cy="${h*.25}" r="3.5" fill="#5d4037"/>
    <circle cx="${w*.54}" cy="${h*.245}" r="1.2" fill="white"/>

    <!-- Blush -->
    <circle cx="${w*.42}" cy="${h*.27}" r="5" fill="#f8a4c8" opacity=".35"/>
    <circle cx="${w*.58}" cy="${h*.27}" r="5" fill="#f8a4c8" opacity=".35"/>

    <!-- Mouth -->
    <path d="M${w*.47},${h*.30} Q${w*.50},${h*.325} ${w*.53},${h*.30}" fill="none" stroke="#e57373" stroke-width="2" stroke-linecap="round"/>

    <!-- Hair front -->
    <path d="M${w*.38},${h*.20} Q${w*.38},${h*.10} ${w*.50},${h*.08} Q${w*.62},${h*.10} ${w*.62},${h*.20} Q${w*.65},${h*.30} ${w*.62},${h*.38} Q${w*.58},${h*.22} ${w*.50},${h*.20} Q${w*.42},${h*.22} ${w*.38},${h*.38} Q${w*.35},${h*.30} ${w*.38},${h*.20}Z" fill="${hc}"/>

    <!-- Hair strands -->
    <path d="M${w*.42},${h*.13} Q${w*.38},${h*.08} ${w*.35},${h*.12}" fill="none" stroke="${hc}" stroke-width="3" stroke-linecap="round" opacity=".7"/>
    <path d="M${w*.58},${h*.13} Q${w*.62},${h*.08} ${w*.65},${h*.12}" fill="none" stroke="${hc}" stroke-width="3" stroke-linecap="round" opacity=".7"/>

    <!-- Accessory -->
    ${accessorySvg}

    <!-- Top/shells -->
    <path d="M${w*.42},${h*.34} Q${w*.50},${h*.33} ${w*.58},${h*.34} L${w*.60},${h*.38} Q${w*.50},${h*.39} ${w*.40},${h*.38}Z" fill="${tc}"/>
    <circle cx="${w*.50}" cy="${h*.36}" r="3" fill="white" opacity=".4"/>

    <!-- Arms -->
    <path d="M${w*.42},${h*.34} Q${w*.34},${h*.38} ${w*.28},${h*.44}" fill="none" stroke="#fdd9b5" stroke-width="8" stroke-linecap="round"/>
    <path d="M${w*.58},${h*.34} Q${w*.66},${h*.38} ${w*.72},${h*.44}" fill="none" stroke="#fdd9b5" stroke-width="8" stroke-linecap="round"/>
    <circle cx="${w*.275}" cy="${h*.445}" r="5" fill="#fdd9b5"/>
    <circle cx="${w*.725}" cy="${h*.445}" r="5" fill="#fdd9b5"/>

    <!-- Torso -->
    <path d="M${w*.40},${h*.37} Q${w*.38},${h*.44} ${w*.40},${h*.50} Q${w*.50},${h*.52} ${w*.60},${h*.50} Q${w*.62},${h*.44} ${w*.60},${h*.37}" fill="#fdd9b5"/>

    <!-- Tail -->
    <path d="M${w*.40},${h*.49} Q${w*.38},${h*.56} ${w*.40},${h*.64} Q${w*.42},${h*.72} ${w*.46},${h*.78} Q${w*.50},${h*.82} ${w*.54},${h*.78} Q${w*.58},${h*.72} ${w*.60},${h*.64} Q${w*.62},${h*.56} ${w*.60},${h*.49}" fill="${tlc}"/>

    <!-- Tail scales pattern -->
    <path d="M${w*.42},${h*.55} Q${w*.50},${h*.57} ${w*.58},${h*.55}" fill="none" stroke="${tlcLight}" stroke-width="1.5" opacity=".6"/>
    <path d="M${w*.43},${h*.62} Q${w*.50},${h*.64} ${w*.57},${h*.62}" fill="none" stroke="${tlcLight}" stroke-width="1.5" opacity=".5"/>
    <path d="M${w*.44},${h*.69} Q${w*.50},${h*.71} ${w*.56},${h*.69}" fill="none" stroke="${tlcLight}" stroke-width="1.5" opacity=".4"/>

    <!-- Tail fin -->
    <path d="M${w*.46},${h*.78} Q${w*.40},${h*.84} ${w*.34},${h*.90} Q${w*.44},${h*.86} ${w*.50},${h*.83}" fill="${tlc}" opacity=".8"/>
    <path d="M${w*.54},${h*.78} Q${w*.60},${h*.84} ${w*.66},${h*.90} Q${w*.56},${h*.86} ${w*.50},${h*.83}" fill="${tlc}" opacity=".8"/>

    <!-- Navel detail -->
    <circle cx="${w*.50}" cy="${h*.47}" r="2" fill="${tlc}" opacity=".3"/>

    <!-- Friend -->
    ${friendSvg}
  </svg>`;

  document.getElementById('md-canvas').innerHTML = svg;
}

</script>
</body>
</html>
